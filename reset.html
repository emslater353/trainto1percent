<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Set New Password – AI Proof Club</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #0a0a0a;
            color: #e0e0e0;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .container { width: 100%; max-width: 400px; }
        .logo {
            text-align: center;
            font-size: 18px;
            font-weight: 800;
            letter-spacing: 3px;
            margin-bottom: 32px;
            color: #fff;
        }
        .logo span { color: #00ffd5; }
        .card {
            background: #141414;
            border: 1px solid #222;
            border-radius: 12px;
            padding: 32px 24px;
        }
        h2 { font-size: 22px; font-weight: 700; margin-bottom: 6px; color: #fff; }
        .subtitle { color: #888; font-size: 14px; margin-bottom: 24px; }
        .form-group { margin-bottom: 16px; }
        label {
            display: block; font-size: 11px; font-weight: 600;
            letter-spacing: 1.5px; text-transform: uppercase;
            color: #888; margin-bottom: 6px;
        }
        input {
            width: 100%; padding: 12px 14px;
            background: #1a1a1a; border: 1px solid #333;
            border-radius: 8px; color: #fff; font-size: 15px;
            outline: none; transition: border-color 0.2s;
        }
        input:focus { border-color: #00ffd5; }
        .btn {
            width: 100%; padding: 14px;
            background: #00ffd5; color: #000; border: none;
            border-radius: 8px; font-size: 15px; font-weight: 700;
            cursor: pointer; margin-top: 8px; transition: opacity 0.2s;
        }
        .btn:hover { opacity: 0.9; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .error {
            background: #2a1010; border: 1px solid #ff4444;
            color: #ff6666; padding: 12px 14px; border-radius: 8px;
            font-size: 13px; margin-bottom: 16px; display: none;
        }
        .success { text-align: center; }
        .success .icon { font-size: 48px; margin-bottom: 16px; color: #00ffd5; }
        .success h2 { margin-bottom: 12px; }
        .success p { color: #888; font-size: 14px; margin-bottom: 24px; line-height: 1.5; }
        .success .btn { text-decoration: none; display: inline-block; text-align: center; }
        .spinner {
            width: 32px; height: 32px;
            border: 3px solid #333; border-top-color: #00ffd5;
            border-radius: 50%; animation: spin 0.8s linear infinite;
            margin: 0 auto 16px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading { text-align: center; padding: 40px 0; }
        .loading p { color: #888; font-size: 14px; }
        .expired { text-align: center; }
        .expired p { color: #888; font-size: 14px; margin-bottom: 20px; line-height: 1.5; }
        .expired a { color: #00ffd5; text-decoration: none; font-weight: 600; }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">AI PROOF <span>CLUB</span></div>

        <!-- Loading: verifying token -->
        <div class="card" id="state-loading">
            <div class="loading">
                <div class="spinner"></div>
                <p>Verifying your reset link...</p>
            </div>
        </div>

        <!-- Password form -->
        <div class="card" id="state-form" style="display:none">
            <h2>Set New Password</h2>
            <p class="subtitle">Choose a strong password for your account</p>
            <div class="error" id="error-msg"></div>
            <form id="reset-form">
                <div class="form-group">
                    <label>New Password</label>
                    <input type="password" id="new-pass" required minlength="6" placeholder="Min 6 characters" autofocus>
                </div>
                <div class="form-group">
                    <label>Confirm Password</label>
                    <input type="password" id="confirm-pass" required minlength="6" placeholder="Confirm password">
                </div>
                <button type="submit" class="btn" id="submit-btn">Set New Password</button>
            </form>
        </div>

        <!-- Success -->
        <div class="card success" id="state-success" style="display:none">
            <div class="icon">✓</div>
            <h2 style="color:#00ffd5">Password Updated!</h2>
            <p>Your new password is set. You can now sign in.</p>
            <a href="/" class="btn">Sign In →</a>
        </div>

        <!-- Expired / invalid -->
        <div class="card expired" id="state-expired" style="display:none">
            <div style="font-size:48px;margin-bottom:16px">⚠️</div>
            <h2>Link Expired</h2>
            <p>This reset link is no longer valid or has already been used. Request a new one from the sign-in page.</p>
            <a href="/">← Back to Sign In</a>
        </div>
    </div>

    <script>
    /*
     * PASSWORD RESET FLOW:
     *
     * 1. Email template sends user to:
     *    https://aiproof.club/reset?token_hash=xxx&type=recovery
     *
     * 2. This page calls POST /auth/v1/verify with { token_hash, type }
     *    → Returns a session with access_token if valid
     *
     * 3. User enters new password
     *
     * 4. We call PUT /auth/v1/user with Bearer <access_token> and { password }
     *    → Password is updated
     */

    var SUPABASE_URL = 'https://snbchuvvnbwvghmbxehv.supabase.co';
    var SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNuYmNodXZ2bmJ3dmdobWJ4ZWh2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk5MDg5NzMsImV4cCI6MjA4NTQ4NDk3M30.cKPieraN3FRT_5ilAQL0X2b9kIpklzE49xGzVJwYxZo';

    var sessionAccessToken = null;

    function show(id) {
        ['state-loading','state-form','state-success','state-expired'].forEach(function(s) {
            document.getElementById(s).style.display = (s === id) ? 'block' : 'none';
        });
    }

    function showError(msg) {
        var el = document.getElementById('error-msg');
        el.textContent = msg;
        el.style.display = 'block';
    }

    // Get token_hash from URL query params or hash fragment
    function getParams() {
        // Check query params first (our custom email template sends these)
        var qp = new URLSearchParams(window.location.search);
        if (qp.get('token_hash')) {
            return { tokenHash: qp.get('token_hash'), type: qp.get('type') || 'recovery' };
        }

        // Check hash fragment (Supabase default ConfirmationURL redirects here with hash)
        var hp = new URLSearchParams(window.location.hash.substring(1));
        if (hp.get('token_hash')) {
            return { tokenHash: hp.get('token_hash'), type: hp.get('type') || 'recovery' };
        }

        // Check for direct access_token (implicit flow from ConfirmationURL)
        if (hp.get('access_token') && hp.get('type') === 'recovery') {
            return { accessToken: hp.get('access_token') };
        }

        return {};
    }

    // Verify token_hash → get session with access_token
    async function verifyToken(tokenHash, type) {
        try {
            var r = await fetch(SUPABASE_URL + '/auth/v1/verify', {
                method: 'POST',
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ token_hash: tokenHash, type: type })
            });

            var data = await r.json();
            console.log('Verify result:', r.status, data);

            if (!r.ok || data.error) {
                return { error: data.error_description || data.msg || data.error || 'Verification failed' };
            }

            if (data.access_token) {
                return { accessToken: data.access_token };
            }

            return { error: 'No session returned' };
        } catch(e) {
            console.error('Verify error:', e);
            return { error: e.message };
        }
    }

    // Update password using session access_token
    async function updatePassword(accessToken, newPassword) {
        try {
            var r = await fetch(SUPABASE_URL + '/auth/v1/user', {
                method: 'PUT',
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': 'Bearer ' + accessToken,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ password: newPassword })
            });

            var data = await r.json();
            console.log('Password update:', r.status);

            if (!r.ok) {
                return { error: data.msg || data.error_description || 'Failed to update password' };
            }
            return { success: true };
        } catch(e) {
            return { error: e.message };
        }
    }

    // Init
    async function init() {
        var p = getParams();

        // Already have access_token (implicit flow)
        if (p.accessToken) {
            sessionAccessToken = p.accessToken;
            show('state-form');
            return;
        }

        // Have token_hash — verify it to get a session
        if (p.tokenHash) {
            var result = await verifyToken(p.tokenHash, p.type);
            if (result.error) {
                console.error('Token expired or invalid:', result.error);
                show('state-expired');
            } else {
                sessionAccessToken = result.accessToken;
                show('state-form');
            }
            return;
        }

        // Nothing found
        console.error('No token found in URL:', window.location.href);
        show('state-expired');
    }

    // Form submit
    document.getElementById('reset-form').addEventListener('submit', async function(e) {
        e.preventDefault();

        var newPass = document.getElementById('new-pass').value;
        var confirmPass = document.getElementById('confirm-pass').value;
        var btn = document.getElementById('submit-btn');

        document.getElementById('error-msg').style.display = 'none';

        if (newPass !== confirmPass) { showError('Passwords do not match.'); return; }
        if (newPass.length < 6) { showError('Password must be at least 6 characters.'); return; }

        btn.textContent = 'Updating...';
        btn.disabled = true;

        var result = await updatePassword(sessionAccessToken, newPass);

        if (result.error) {
            showError(result.error);
            btn.textContent = 'Set New Password';
            btn.disabled = false;
            return;
        }

        show('state-success');
    });

    init();
    </script>
</body>
</html>
