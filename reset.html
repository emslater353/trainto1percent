<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Set New Password – AI Proof Club</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #0a0a0a;
            color: #e0e0e0;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .container { width: 100%; max-width: 400px; }
        .logo {
            text-align: center;
            font-size: 18px;
            font-weight: 800;
            letter-spacing: 3px;
            margin-bottom: 32px;
            color: #fff;
        }
        .logo span { color: #00ffd5; }
        .card {
            background: #141414;
            border: 1px solid #222;
            border-radius: 12px;
            padding: 32px 24px;
        }
        h2 { font-size: 22px; font-weight: 700; margin-bottom: 6px; color: #fff; }
        .subtitle { color: #888; font-size: 14px; margin-bottom: 24px; }
        .form-group { margin-bottom: 16px; }
        label {
            display: block; font-size: 11px; font-weight: 600;
            letter-spacing: 1.5px; text-transform: uppercase;
            color: #888; margin-bottom: 6px;
        }
        input {
            width: 100%; padding: 12px 14px;
            background: #1a1a1a; border: 1px solid #333;
            border-radius: 8px; color: #fff; font-size: 15px;
            outline: none; transition: border-color 0.2s;
        }
        input:focus { border-color: #00ffd5; }
        .btn {
            width: 100%; padding: 14px;
            background: #00ffd5; color: #000; border: none;
            border-radius: 8px; font-size: 15px; font-weight: 700;
            cursor: pointer; margin-top: 8px; transition: opacity 0.2s;
        }
        .btn:hover { opacity: 0.9; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .error {
            background: #2a1010; border: 1px solid #ff4444;
            color: #ff6666; padding: 12px 14px; border-radius: 8px;
            font-size: 13px; margin-bottom: 16px; display: none;
        }
        .success { text-align: center; }
        .success .icon { font-size: 48px; margin-bottom: 16px; color: #00ffd5; }
        .success h2 { margin-bottom: 12px; }
        .success p { color: #888; font-size: 14px; margin-bottom: 24px; line-height: 1.5; }
        .success .btn { text-decoration: none; display: inline-block; text-align: center; }
        .spinner {
            width: 32px; height: 32px;
            border: 3px solid #333; border-top-color: #00ffd5;
            border-radius: 50%; animation: spin 0.8s linear infinite;
            margin: 0 auto 16px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading { text-align: center; padding: 40px 0; }
        .loading p { color: #888; font-size: 14px; }
        .expired { text-align: center; }
        .expired p { color: #888; font-size: 14px; margin-bottom: 20px; line-height: 1.5; }
        .expired a { color: #00ffd5; text-decoration: none; font-weight: 600; }
        .debug { color: #666; font-size: 11px; margin-top: 20px; word-break: break-all; }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">AI PROOF <span>CLUB</span></div>

        <!-- Loading -->
        <div class="card" id="state-loading">
            <div class="loading">
                <div class="spinner"></div>
                <p>Preparing your reset form...</p>
            </div>
        </div>

        <!-- Password form -->
        <div class="card" id="state-form" style="display:none">
            <h2>Set New Password</h2>
            <p class="subtitle">Choose a strong password for your account</p>
            <div class="error" id="error-msg"></div>
            <form id="reset-form">
                <div class="form-group">
                    <label for="new-pass">New Password</label>
                    <input type="password" id="new-pass" required minlength="6" placeholder="Min 6 characters" autofocus>
                </div>
                <div class="form-group">
                    <label for="confirm-pass">Confirm Password</label>
                    <input type="password" id="confirm-pass" required minlength="6" placeholder="Confirm password">
                </div>
                <button type="submit" class="btn" id="submit-btn">Set New Password</button>
            </form>
        </div>

        <!-- Success -->
        <div class="card success" id="state-success" style="display:none">
            <div class="icon">✓</div>
            <h2 style="color:#00ffd5">Password Updated!</h2>
            <p>Your new password is set. You can now sign in.</p>
            <a href="/" class="btn">Sign In →</a>
        </div>

        <!-- Expired / invalid -->
        <div class="card expired" id="state-expired" style="display:none">
            <div style="font-size:48px;margin-bottom:16px">⚠️</div>
            <h2>Link Expired</h2>
            <p>This reset link is no longer valid or has already been used. Request a new one from the sign-in page.</p>
            <a href="/">← Back to Sign In</a>
            <div class="debug" id="debug-info"></div>
        </div>
    </div>

    <script>
    /*
     * PASSWORD RESET FLOW:
     *
     * Email template sends user to Supabase's verify endpoint:
     *   https://<project>.supabase.co/auth/v1/verify?token=<TokenHash>&type=recovery&redirect_to=https://aiproof.club/reset
     *
     * Supabase verifies the token, then redirects to:
     *   https://aiproof.club/reset#access_token=xxx&refresh_token=xxx&type=recovery
     *
     * This page reads the access_token from the hash fragment,
     * shows the password form, and calls PUT /auth/v1/user to update.
     */

    var SUPABASE_URL = 'https://snbchuvvnbwvghmbxehv.supabase.co';
    var SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNuYmNodXZ2bmJ3dmdobWJ4ZWh2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk5MDg5NzMsImV4cCI6MjA4NTQ4NDk3M30.cKPieraN3FRT_5ilAQL0X2b9kIpklzE49xGzVJwYxZo';

    var sessionAccessToken = null;

    function show(id) {
        ['state-loading','state-form','state-success','state-expired'].forEach(function(s) {
            document.getElementById(s).style.display = (s === id) ? 'block' : 'none';
        });
    }

    function showError(msg) {
        var el = document.getElementById('error-msg');
        el.textContent = msg;
        el.style.display = 'block';
    }

    function init() {
        console.log('Reset page loaded');
        console.log('Full URL:', window.location.href);
        console.log('Hash:', window.location.hash);
        console.log('Search:', window.location.search);

        var accessToken = null;

        // Method 1: Check hash fragment (Supabase redirects here with #access_token=xxx&type=recovery)
        if (window.location.hash && window.location.hash.length > 1) {
            var hashStr = window.location.hash.substring(1);
            var hp = new URLSearchParams(hashStr);
            console.log('Hash params - access_token:', hp.get('access_token') ? 'present' : 'missing');
            console.log('Hash params - type:', hp.get('type'));
            
            if (hp.get('access_token')) {
                accessToken = hp.get('access_token');
                console.log('Got access_token from hash fragment');
            }
        }

        // Method 2: Check query params (fallback)
        if (!accessToken) {
            var qp = new URLSearchParams(window.location.search);
            if (qp.get('access_token')) {
                accessToken = qp.get('access_token');
                console.log('Got access_token from query params');
            }
        }

        if (accessToken) {
            sessionAccessToken = accessToken;
            show('state-form');
            console.log('Showing password form');
        } else {
            console.error('No access_token found in URL');
            document.getElementById('debug-info').textContent = 
                'URL: ' + window.location.href.substring(0, 200);
            show('state-expired');
        }
    }

    // Update password
    async function updatePassword(newPassword) {
        try {
            var r = await fetch(SUPABASE_URL + '/auth/v1/user', {
                method: 'PUT',
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': 'Bearer ' + sessionAccessToken,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ password: newPassword })
            });

            var data = await r.json();
            console.log('Password update response:', r.status);

            if (!r.ok) {
                return { error: data.msg || data.error_description || 'Failed to update password' };
            }
            return { success: true };
        } catch(e) {
            console.error('Update error:', e);
            return { error: e.message };
        }
    }

    // Form submit
    document.getElementById('reset-form').addEventListener('submit', async function(e) {
        e.preventDefault();

        var newPass = document.getElementById('new-pass').value;
        var confirmPass = document.getElementById('confirm-pass').value;
        var btn = document.getElementById('submit-btn');

        document.getElementById('error-msg').style.display = 'none';

        if (newPass !== confirmPass) { showError('Passwords do not match.'); return; }
        if (newPass.length < 6) { showError('Password must be at least 6 characters.'); return; }

        btn.textContent = 'Updating...';
        btn.disabled = true;

        var result = await updatePassword(newPass);

        if (result.error) {
            showError(result.error);
            btn.textContent = 'Set New Password';
            btn.disabled = false;
            return;
        }

        show('state-success');
    });

    // Go
    init();
    </script>
</body>
</html>
