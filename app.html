<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Top 1% OS ‚Äî App</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Instrument+Serif:ital@0;1&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #111111;
            --bg-tertiary: #1a1a1a;
            --text-primary: #f5f5f5;
            --text-secondary: #888888;
            --text-muted: #555555;
            --accent: #c9ff2f;
            --danger: #ff4444;
            --success: #4ade80;
            --ideas-color: #6b8afd;
            --personality-color: #fd6b8a;
            --execution-color: #8afd6b;
            --font-display: 'Instrument Serif', Georgia, serif;
            --font-mono: 'Space Mono', monospace;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: var(--font-mono); background: var(--bg-primary); color: var(--text-primary); line-height: 1.6; font-size: 14px; min-height: 100vh; }
        
        /* Buttons */
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 16px 32px; font-family: var(--font-mono); font-size: 12px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; border: none; cursor: pointer; transition: all 0.3s; text-decoration: none; }
        .btn-primary { background: var(--accent); color: var(--bg-primary); }
        .btn-primary:hover { background: var(--text-primary); }
        .btn-primary:disabled { background: var(--bg-tertiary); color: var(--text-muted); cursor: not-allowed; }
        .btn-secondary { background: transparent; border: 1px solid var(--bg-tertiary); color: var(--text-secondary); }
        .btn-secondary:hover { border-color: var(--text-secondary); color: var(--text-primary); }
        .btn-full { width: 100%; }
        .btn-small { padding: 12px 20px; font-size: 11px; }
        .btn-success { background: var(--success); color: var(--bg-primary); }

        /* Layout */
        .screen-center { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .container-sm { width: 100%; max-width: 420px; }
        .container-md { width: 100%; max-width: 600px; }
        .container-xl { width: 100%; max-width: 1100px; }

        .logo { font-size: 14px; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 40px; text-align: center; }
        .logo span { color: var(--accent); }

        .card { background: var(--bg-secondary); border: 1px solid var(--bg-tertiary); padding: 40px; }
        .card-title { font-family: var(--font-display); font-size: 28px; margin-bottom: 10px; }
        .card-subtitle { color: var(--text-secondary); font-size: 13px; margin-bottom: 30px; }

        /* Forms */
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-size: 11px; letter-spacing: 1px; text-transform: uppercase; color: var(--text-secondary); margin-bottom: 8px; }
        .form-input { width: 100%; padding: 14px 16px; background: var(--bg-primary); border: 1px solid var(--bg-tertiary); color: var(--text-primary); font-family: var(--font-mono); font-size: 14px; }
        .form-input:focus { outline: none; border-color: var(--accent); }

        /* Utilities */
        .text-link { color: var(--accent); text-decoration: none; cursor: pointer; }
        .text-link:hover { text-decoration: underline; }
        .text-center { text-align: center; }
        .text-secondary { color: var(--text-secondary); }
        .text-small { font-size: 13px; }
        .mt-20 { margin-top: 20px; }
        .mt-30 { margin-top: 30px; }
        .mb-20 { margin-bottom: 20px; }
        .mb-30 { margin-bottom: 30px; }

        /* Pricing */
        .pricing-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        .pricing-card { background: var(--bg-secondary); border: 1px solid var(--bg-tertiary); padding: 35px; cursor: pointer; transition: all 0.3s; position: relative; }
        .pricing-card:hover { border-color: var(--text-secondary); }
        .pricing-card.selected { border-color: var(--accent); background: var(--bg-tertiary); }
        .pricing-card.featured::before { content: 'MOST POPULAR'; position: absolute; top: -12px; left: 50%; transform: translateX(-50%); background: var(--accent); color: var(--bg-primary); font-size: 9px; letter-spacing: 1px; padding: 5px 12px; }
        .pricing-tier { font-size: 11px; letter-spacing: 1px; text-transform: uppercase; color: var(--text-secondary); margin-bottom: 15px; }
        .pricing-price { font-size: 42px; font-weight: 700; margin-bottom: 5px; }
        .pricing-price span { font-size: 14px; font-weight: 400; color: var(--text-secondary); }
        .pricing-desc { font-size: 13px; color: var(--text-secondary); margin-bottom: 20px; }
        .pricing-features { list-style: none; }
        .pricing-features li { padding: 8px 0; font-size: 12px; }
        .pricing-features li::before { content: '‚úì '; color: var(--accent); }

        /* Choice Cards */
        .choice-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .choice-card { background: var(--bg-secondary); border: 1px solid var(--bg-tertiary); padding: 40px; text-align: center; cursor: pointer; transition: all 0.3s; }
        .choice-card:hover { border-color: var(--text-secondary); }
        .choice-card.selected { border-color: var(--accent); }
        .choice-icon { font-size: 48px; margin-bottom: 20px; }
        .choice-title { font-size: 16px; margin-bottom: 10px; }
        .choice-desc { font-size: 12px; color: var(--text-secondary); }

        /* Upload */
        .upload-zone { border: 2px dashed var(--bg-tertiary); padding: 60px; text-align: center; cursor: pointer; transition: all 0.3s; }
        .upload-zone:hover { border-color: var(--accent); }
        .upload-icon { font-size: 48px; margin-bottom: 20px; }
        .upload-text { margin-bottom: 10px; }
        .upload-hint { font-size: 12px; color: var(--text-secondary); }
        .file-input { display: none; }
        .uploaded-file { display: flex; align-items: center; gap: 15px; padding: 20px; background: var(--bg-tertiary); margin-top: 20px; }
        .uploaded-name { flex: 1; }
        .uploaded-remove { color: var(--danger); cursor: pointer; }

        /* Quiz */
        .progress-bar { display: flex; gap: 8px; margin-bottom: 40px; }
        .progress-dot { flex: 1; height: 4px; background: var(--bg-tertiary); border-radius: 2px; }
        .progress-dot.active { background: var(--accent); }
        .progress-dot.done { background: var(--accent); opacity: 0.5; }
        .q-number { font-size: 11px; letter-spacing: 1px; text-transform: uppercase; color: var(--accent); margin-bottom: 15px; }
        .q-text { font-family: var(--font-display); font-size: 24px; line-height: 1.4; margin-bottom: 30px; }
        .options { display: flex; flex-direction: column; gap: 12px; }
        .option { padding: 20px; background: var(--bg-secondary); border: 1px solid var(--bg-tertiary); cursor: pointer; text-align: left; font-family: var(--font-mono); font-size: 14px; color: var(--text-primary); transition: all 0.3s; }
        .option:hover { border-color: var(--text-secondary); }

        /* Results */
        .results-meters { display: flex; justify-content: center; gap: 40px; margin: 40px 0; }
        .meter { text-align: center; }
        .meter-circle { width: 120px; height: 120px; border-radius: 50%; border: 5px solid; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px; font-size: 32px; font-weight: 700; }
        .meter-circle.ideas { border-color: var(--ideas-color); color: var(--ideas-color); }
        .meter-circle.personality { border-color: var(--personality-color); color: var(--personality-color); }
        .meter-circle.execution { border-color: var(--execution-color); color: var(--execution-color); }
        .meter-label { font-size: 13px; }
        .verdict { background: var(--bg-primary); border-left: 3px solid var(--accent); padding: 25px; margin: 30px 0; text-align: left; }
        .verdict-title { font-size: 10px; letter-spacing: 1px; text-transform: uppercase; color: var(--accent); margin-bottom: 10px; }
        .verdict-text { font-size: 15px; line-height: 1.6; }

        /* App Layout */
        .app-layout { display: flex; min-height: 100vh; }
        .sidebar { width: 260px; background: var(--bg-secondary); border-right: 1px solid var(--bg-tertiary); padding: 30px 20px; position: fixed; height: 100vh; display: flex; flex-direction: column; }
        .sidebar-logo { font-size: 12px; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 40px; padding: 0 10px; }
        .sidebar-logo span { color: var(--accent); }
        .sidebar-nav { list-style: none; flex: 1; }
        .sidebar-nav li { margin-bottom: 5px; }
        .sidebar-nav a { display: block; padding: 12px 15px; color: var(--text-secondary); text-decoration: none; font-size: 13px; transition: all 0.3s; }
        .sidebar-nav a:hover, .sidebar-nav a.active { background: var(--bg-tertiary); color: var(--text-primary); }
        .sidebar-nav a.active { border-left: 2px solid var(--accent); }
        .sidebar-user { padding: 15px; background: var(--bg-tertiary); }
        .sidebar-name { font-size: 13px; margin-bottom: 5px; }
        .sidebar-email { font-size: 11px; color: var(--text-secondary); margin-bottom: 10px; }
        .sidebar-logout { font-size: 11px; color: var(--text-muted); cursor: pointer; }
        .sidebar-logout:hover { color: var(--danger); }
        .main { flex: 1; margin-left: 260px; padding: 40px; }
        .page-title { font-family: var(--font-display); font-size: 32px; margin-bottom: 10px; }
        .page-subtitle { color: var(--text-secondary); font-size: 14px; margin-bottom: 40px; }

        /* Stats */
        .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat { background: var(--bg-secondary); border: 1px solid var(--bg-tertiary); padding: 25px; text-align: center; }
        .stat-value { font-size: 36px; font-weight: 700; color: var(--accent); }
        .stat-label { font-size: 11px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; }

        /* Mode Bars */
        .mode-bars { display: flex; flex-direction: column; gap: 20px; }
        .mode-bar { display: flex; align-items: center; gap: 20px; }
        .mode-name { width: 100px; font-size: 12px; }
        .mode-name.ideas { color: var(--ideas-color); }
        .mode-name.personality { color: var(--personality-color); }
        .mode-name.execution { color: var(--execution-color); }
        .mode-track { flex: 1; height: 8px; background: var(--bg-tertiary); border-radius: 4px; overflow: hidden; }
        .mode-fill { height: 100%; border-radius: 4px; transition: width 0.5s; }
        .mode-fill.ideas { background: var(--ideas-color); }
        .mode-fill.personality { background: var(--personality-color); }
        .mode-fill.execution { background: var(--execution-color); }
        .mode-value { width: 50px; text-align: right; font-size: 18px; font-weight: 700; }

        /* Dashboard Grid */
        .dash-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 30px; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--bg-tertiary); }
        .card-header-title { font-size: 14px; }
        .card-badge { font-size: 10px; letter-spacing: 1px; text-transform: uppercase; color: var(--accent); }

        /* Quests */
        .quest { background: var(--bg-primary); border: 1px solid var(--bg-tertiary); padding: 25px; margin-bottom: 15px; }
        .quest.done { opacity: 0.5; }
        .quest-mode { font-size: 10px; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 10px; }
        .quest-mode.ideas { color: var(--ideas-color); }
        .quest-mode.personality { color: var(--personality-color); }
        .quest-mode.execution { color: var(--execution-color); }
        .quest-title { font-size: 15px; line-height: 1.5; margin-bottom: 15px; }
        .quest-meta { display: flex; gap: 20px; font-size: 11px; color: var(--text-secondary); margin-bottom: 20px; }
        .quest-xp { color: var(--accent); }
        .quest-actions { display: flex; gap: 10px; }

        /* Receipts */
        .receipt { display: flex; gap: 15px; padding: 15px 0; border-bottom: 1px solid var(--bg-tertiary); }
        .receipt:last-child { border-bottom: none; }
        .receipt-check { width: 24px; height: 24px; border: 1px solid var(--accent); display: flex; align-items: center; justify-content: center; font-size: 12px; color: var(--accent); }
        .receipt-content { flex: 1; }
        .receipt-title { font-size: 13px; margin-bottom: 4px; }
        .receipt-meta { font-size: 11px; color: var(--text-secondary); }

        /* Chat */
        .chat-container { display: flex; flex-direction: column; height: calc(100vh - 200px); }
        .chat-messages { flex: 1; overflow-y: auto; padding: 20px 0; }
        .chat-msg { display: flex; gap: 15px; margin-bottom: 25px; }
        .chat-msg.user { flex-direction: row-reverse; }
        .chat-avatar { width: 36px; height: 36px; border-radius: 50%; background: var(--bg-tertiary); display: flex; align-items: center; justify-content: center; font-size: 14px; }
        .chat-msg.ai .chat-avatar { background: var(--accent); color: var(--bg-primary); }
        .chat-bubble { max-width: 70%; padding: 15px 20px; background: var(--bg-secondary); border: 1px solid var(--bg-tertiary); font-size: 14px; line-height: 1.6; }
        .chat-msg.user .chat-bubble { background: var(--bg-tertiary); }
        .chat-input-row { display: flex; gap: 10px; padding-top: 20px; border-top: 1px solid var(--bg-tertiary); }
        .chat-input { flex: 1; padding: 15px; background: var(--bg-secondary); border: 1px solid var(--bg-tertiary); color: var(--text-primary); font-family: var(--font-mono); font-size: 14px; resize: none; }
        .chat-input:focus { outline: none; border-color: var(--accent); }
        .chat-send { padding: 15px 25px; background: var(--accent); border: none; color: var(--bg-primary); font-family: var(--font-mono); font-size: 12px; font-weight: 700; cursor: pointer; }

        /* Loading */
        .spinner { width: 24px; height: 24px; border: 2px solid var(--bg-tertiary); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { text-align: center; color: var(--text-secondary); font-size: 13px; margin-top: 15px; }

        /* Responsive */
        @media (max-width: 1024px) {
            .pricing-grid, .choice-grid, .dash-grid { grid-template-columns: 1fr; }
            .stats { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 768px) {
            .sidebar { display: none; }
            .main { margin-left: 0; padding: 20px; }
            .results-meters { flex-direction: column; gap: 20px; }
            .stats { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
    const OPENAI_KEY = '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';

    const state = {
        screen: 'login',
        user: null,
        selectedPlan: null,
        onboardingMethod: null,
        uploadedFile: null,
        quizStep: 0,
        quizAnswers: [],
        scores: { ideas: 50, personality: 50, execution: 50 },
        quests: [],
        receipts: [],
        chat: [],
        loading: false
    };

    const questions = [
        { text: "When you have a big decision to make, what's your first instinct?", options: [
            { text: "Map out all possible scenarios and think through implications", mode: "ideas", w: 2 },
            { text: "Call someone I trust to talk it through", mode: "personality", w: 2 },
            { text: "Make a quick decision and course-correct as needed", mode: "execution", w: 2 },
            { text: "Research extensively before committing", mode: "ideas", w: 1 }
        ]},
        { text: "In group settings, people usually look to you to:", options: [
            { text: "Generate creative ideas and new directions", mode: "ideas", w: 2 },
            { text: "Keep the energy up and mediate tensions", mode: "personality", w: 2 },
            { text: "Drive things forward and keep people accountable", mode: "execution", w: 2 },
            { text: "Ask the questions no one else is asking", mode: "ideas", w: 1 }
        ]},
        { text: "What frustrates you most at work?", options: [
            { text: "Great ideas that never get implemented", mode: "ideas", w: 2 },
            { text: "Being left out of key conversations", mode: "personality", w: 2 },
            { text: "People who don't follow through on commitments", mode: "execution", w: 2 },
            { text: "Lack of clear strategy or vision", mode: "ideas", w: 1 }
        ]},
        { text: "When you want something from someone, you typically:", options: [
            { text: "Build a logical case with clear reasoning", mode: "ideas", w: 2 },
            { text: "Build rapport first, then make the ask feel natural", mode: "personality", w: 2 },
            { text: "Ask directly and handle whatever response comes", mode: "execution", w: 2 },
            { text: "Hint at it and hope they offer", mode: "personality", w: -1 }
        ]},
        { text: "When things get tense or awkward, you usually:", options: [
            { text: "Step back and analyze what's really going on", mode: "ideas", w: 2 },
            { text: "Use humor or charm to diffuse it", mode: "personality", w: 2 },
            { text: "Address it directly and move on", mode: "execution", w: 2 },
            { text: "Avoid it and hope it blows over", mode: "execution", w: -1 }
        ]},
        { text: "After completing a project, what are you most proud of?", options: [
            { text: "The innovative approach or strategy we used", mode: "ideas", w: 2 },
            { text: "The relationships and trust built along the way", mode: "personality", w: 2 },
            { text: "Delivering on time and exceeding expectations", mode: "execution", w: 2 },
            { text: "The recognition and visibility it brought", mode: "personality", w: 1 }
        ]},
        { text: "Your close friends would describe you as the one who:", options: [
            { text: "Always has interesting perspectives and ideas", mode: "ideas", w: 2 },
            { text: "Makes everyone laugh and brings people together", mode: "personality", w: 2 },
            { text: "Actually gets things done when it matters", mode: "execution", w: 2 },
            { text: "Keeps everyone organized and on track", mode: "execution", w: 1 }
        ]}
    ];

    const questBank = {
        ideas: [
            { title: "Make one decision you've been postponing for over 3 days. Commit to it.", xp: 50, diff: "Medium" },
            { title: "Take your best idea and write down 3 concrete next steps.", xp: 40, diff: "Easy" },
            { title: "In your next meeting, ask one clarifying question instead of nodding.", xp: 30, diff: "Easy" },
            { title: "Set a 10-minute timer and decide on something you've been overthinking.", xp: 50, diff: "Medium" }
        ],
        personality: [
            { title: "Add levity to one tense moment today. Notice the reaction.", xp: 50, diff: "Medium" },
            { title: "Start a conversation with someone you don't usually talk to.", xp: 40, diff: "Easy" },
            { title: "Give someone a genuine, specific compliment.", xp: 30, diff: "Easy" },
            { title: "Recover gracefully from an awkward moment. Note what worked.", xp: 60, diff: "Hard" }
        ],
        execution: [
            { title: "Rewrite your last email to be 40% shorter. Send it.", xp: 40, diff: "Easy" },
            { title: "Decline one meeting that doesn't move your goals forward.", xp: 50, diff: "Medium" },
            { title: "Ship one thing you've been putting off for more than 3 days.", xp: 60, diff: "Medium" },
            { title: "Ask for something you want directly. No hinting.", xp: 70, diff: "Hard" }
        ]
    };

    function save() {
        localStorage.setItem('t1p_state', JSON.stringify({
            user: state.user, scores: state.scores, quests: state.quests, receipts: state.receipts, chat: state.chat
        }));
    }

    function load() {
        const d = localStorage.getItem('t1p_state');
        if (d) {
            const p = JSON.parse(d);
            if (p.user?.onboarded) {
                Object.assign(state, { user: p.user, scores: p.scores, quests: p.quests || [], receipts: p.receipts || [], chat: p.chat || [], screen: 'dashboard' });
                return true;
            }
        }
        return false;
    }

    function weakest() {
        const { ideas, personality, execution } = state.scores;
        if (ideas <= personality && ideas <= execution) return 'ideas';
        if (personality <= ideas && personality <= execution) return 'personality';
        return 'execution';
    }

    function strongest() {
        const { ideas, personality, execution } = state.scores;
        if (ideas >= personality && ideas >= execution) return 'ideas';
        if (personality >= ideas && personality >= execution) return 'personality';
        return 'execution';
    }

    function genQuests() {
        const w = weakest();
        const qs = [];
        const wBank = [...questBank[w]].sort(() => Math.random() - 0.5).slice(0, 2);
        wBank.forEach(q => qs.push({ ...q, mode: w, id: Date.now() + Math.random(), done: false }));
        ['ideas', 'personality', 'execution'].filter(m => m !== w).forEach(m => {
            const t = questBank[m][Math.floor(Math.random() * questBank[m].length)];
            qs.push({ ...t, mode: m, id: Date.now() + Math.random(), done: false });
        });
        return qs;
    }

    function dayNum() {
        if (!state.user?.startDate) return 1;
        return Math.floor((Date.now() - new Date(state.user.startDate).getTime()) / 86400000) + 1;
    }

    function totalXP() {
        return state.receipts.reduce((s, r) => s + (r.xp || 50), 0);
    }

    async function aiChat(msg) {
        const sys = `You are a direct, tactical coach. User's modes: Ideas ${state.scores.ideas}%, Personality ${state.scores.personality}%, Execution ${state.scores.execution}%. Weakest: ${weakest()}. Be concise, actionable. Use words like: modes, levers, receipts, velocity, calibration. Avoid therapy-speak.`;
        try {
            const r = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${OPENAI_KEY}` },
                body: JSON.stringify({ model: 'gpt-4o-mini', messages: [{ role: 'system', content: sys }, ...state.chat.map(m => ({ role: m.user ? 'user' : 'assistant', content: m.text })), { role: 'user', content: msg }], max_tokens: 500 })
            });
            const d = await r.json();
            return d.choices[0].message.content;
        } catch { return "Connection error. Try again."; }
    }

    async function analyzeFile(content) {
        const sys = `Analyze ChatGPT history for operating modes. Return JSON: {"scores":{"ideas":0-100,"personality":0-100,"execution":0-100},"analysis":"2 sentences"}`;
        try {
            const r = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${OPENAI_KEY}` },
                body: JSON.stringify({ model: 'gpt-4o-mini', messages: [{ role: 'system', content: sys }, { role: 'user', content: content.substring(0, 15000) }], max_tokens: 500 })
            });
            const d = await r.json();
            return JSON.parse(d.choices[0].message.content);
        } catch { return null; }
    }

    function render() {
        const app = document.getElementById('app');
        const screens = { login: loginHTML, signup: signupHTML, pricing: pricingHTML, onboarding: onboardingHTML, upload: uploadHTML, analyzing: analyzingHTML, quiz: quizHTML, results: resultsHTML, dashboard: () => appHTML(dashboardHTML()), quests: () => appHTML(questsHTML()), coach: () => appHTML(coachHTML()), receipts: () => appHTML(receiptsHTML()), profile: () => appHTML(profileHTML()) };
        app.innerHTML = (screens[state.screen] || loginHTML)();
        bindEvents();
    }

    function loginHTML() {
        return `<div class="screen-center"><div class="container-sm"><div class="logo">TOP <span>1%</span> OS</div><div class="card"><h1 class="card-title">Welcome back</h1><p class="card-subtitle">Continue your training</p><form id="login-form"><div class="form-group"><label class="form-label">Email</label><input type="email" class="form-input" id="email" required></div><div class="form-group"><label class="form-label">Password</label><input type="password" class="form-input" id="pass" required></div><button type="submit" class="btn btn-primary btn-full">Sign In</button></form><p class="text-center text-secondary text-small mt-20">New here? <a class="text-link" id="to-signup">Start training</a></p></div></div></div>`;
    }

    function signupHTML() {
        return `<div class="screen-center"><div class="container-sm"><div class="logo">TOP <span>1%</span> OS</div><div class="card"><h1 class="card-title">Start training</h1><p class="card-subtitle">Build the skills AI can't replace</p><form id="signup-form"><div class="form-group"><label class="form-label">Name</label><input type="text" class="form-input" id="name" required></div><div class="form-group"><label class="form-label">Email</label><input type="email" class="form-input" id="email" required></div><div class="form-group"><label class="form-label">Password</label><input type="password" class="form-input" id="pass" required minlength="6"></div><button type="submit" class="btn btn-primary btn-full">Create Account</button></form><p class="text-center text-secondary text-small mt-20">Already training? <a class="text-link" id="to-login">Sign in</a></p></div></div></div>`;
    }

    function pricingHTML() {
        return `<div class="screen-center"><div class="container-xl"><div class="logo">TOP <span>1%</span> OS</div><h1 class="card-title text-center mb-20">Choose your plan</h1><p class="text-center text-secondary mb-30">All plans include the full system.</p><div class="pricing-grid mb-30"><div class="pricing-card ${state.selectedPlan === 'monthly' ? 'selected' : ''}" data-plan="monthly"><div class="pricing-tier">Monthly</div><div class="pricing-price">$14 <span>/ month</span></div><p class="pricing-desc">Full access. Cancel anytime.</p><ul class="pricing-features"><li>Mode diagnostic</li><li>Daily IRL quests</li><li>AI coaching</li><li>Progress receipts</li></ul></div><div class="pricing-card featured ${state.selectedPlan === 'sprint' ? 'selected' : ''}" data-plan="sprint"><div class="pricing-tier">90-Day Sprint</div><div class="pricing-price">$49 <span>one-time</span></div><p class="pricing-desc">Full transformation.</p><ul class="pricing-features"><li>Everything in Monthly</li><li>90-day curriculum</li><li>Progress capsules</li><li>Priority support</li></ul></div><div class="pricing-card ${state.selectedPlan === 'annual' ? 'selected' : ''}" data-plan="annual"><div class="pricing-tier">Annual</div><div class="pricing-price">$99 <span>/ year</span></div><p class="pricing-desc">Best value.</p><ul class="pricing-features"><li>Everything in Sprint</li><li>Quarterly reassessment</li><li>Operating Manual</li><li>Early access</li></ul></div></div><div class="text-center"><button class="btn btn-primary" id="to-onboarding" ${!state.selectedPlan ? 'disabled' : ''}>Continue ‚Üí</button><p class="text-secondary text-small mt-20">14-day money-back guarantee</p></div></div></div>`;
    }

    function onboardingHTML() {
        return `<div class="screen-center"><div class="container-md"><div class="logo">TOP <span>1%</span> OS</div><h1 class="card-title text-center mb-20">How should we assess your modes?</h1><p class="text-center text-secondary mb-30">We'll figure out where to focus your training.</p><div class="choice-grid mb-30"><div class="choice-card ${state.onboardingMethod === 'upload' ? 'selected' : ''}" data-method="upload"><div class="choice-icon">üì§</div><div class="choice-title">Upload ChatGPT History</div><div class="choice-desc">We'll analyze your patterns. Most accurate.</div></div><div class="choice-card ${state.onboardingMethod === 'quiz' ? 'selected' : ''}" data-method="quiz"><div class="choice-icon">üìù</div><div class="choice-title">Take Quick Quiz</div><div class="choice-desc">7 questions. Takes 2 minutes.</div></div></div><div class="text-center"><button class="btn btn-primary" id="continue-onboarding" ${!state.onboardingMethod ? 'disabled' : ''}>Continue ‚Üí</button></div></div></div>`;
    }

    function uploadHTML() {
        return `<div class="screen-center"><div class="container-md"><div class="logo">TOP <span>1%</span> OS</div><h1 class="card-title text-center mb-20">Upload ChatGPT history</h1><p class="text-center text-secondary mb-30">Export from ChatGPT settings and upload.</p><div class="card"><div class="upload-zone" id="upload-zone"><div class="upload-icon">üìÅ</div><div class="upload-text">Drop conversations.json here</div><div class="upload-hint">or click to browse</div><input type="file" class="file-input" id="file-input" accept=".json"></div>${state.uploadedFile ? `<div class="uploaded-file"><span>üìÑ</span><span class="uploaded-name">${state.uploadedFile.name}</span><span class="uploaded-remove" id="remove-file">Remove</span></div>` : ''}</div><div class="text-center mt-30"><button class="btn btn-primary" id="analyze-btn" ${!state.uploadedFile ? 'disabled' : ''}>Analyze ‚Üí</button><p class="mt-20"><a class="text-link" id="skip-quiz">Take quiz instead</a></p></div></div></div>`;
    }

    function analyzingHTML() {
        return `<div class="screen-center"><div class="container-sm text-center"><div class="logo">TOP <span>1%</span> OS</div><div class="card"><div class="spinner"></div><p class="loading-text mt-20">Analyzing your patterns...</p></div></div></div>`;
    }

    function quizHTML() {
        const q = questions[state.quizStep];
        const dots = questions.map((_, i) => `<div class="progress-dot ${i < state.quizStep ? 'done' : i === state.quizStep ? 'active' : ''}"></div>`).join('');
        return `<div class="screen-center"><div class="container-md"><div class="logo">TOP <span>1%</span> OS</div><div class="progress-bar">${dots}</div><div class="q-number">Question ${state.quizStep + 1} of ${questions.length}</div><div class="q-text">${q.text}</div><div class="options">${q.options.map((o, i) => `<button class="option" data-idx="${i}">${o.text}</button>`).join('')}</div></div></div>`;
    }

    function resultsHTML() {
        const { ideas, personality, execution } = state.scores;
        return `<div class="screen-center"><div class="container-md"><div class="logo">TOP <span>1%</span> OS</div><div class="card text-center"><h1 class="card-title">Your Mode Profile</h1><p class="card-subtitle">Here's how you operate</p><div class="results-meters"><div class="meter"><div class="meter-circle ideas">${ideas}%</div><div class="meter-label">Ideas</div></div><div class="meter"><div class="meter-circle personality">${personality}%</div><div class="meter-label">Personality</div></div><div class="meter"><div class="meter-circle execution">${execution}%</div><div class="meter-label">Execution</div></div></div><div class="verdict"><div class="verdict-title">Your Focus</div><div class="verdict-text">You default to <strong>${strongest()}</strong> mode. Your training will focus on <strong>${weakest()}</strong>, where you're leaving leverage on the table.</div></div><button class="btn btn-primary" id="start-app">Start Training ‚Üí</button></div></div></div>`;
    }

    function appHTML(content) {
        return `<div class="app-layout"><aside class="sidebar"><div class="sidebar-logo">TOP <span>1%</span> OS</div><ul class="sidebar-nav"><li><a href="#" data-screen="dashboard" class="${state.screen === 'dashboard' ? 'active' : ''}">‚óâ Dashboard</a></li><li><a href="#" data-screen="quests" class="${state.screen === 'quests' ? 'active' : ''}">‚öî IRL Quests</a></li><li><a href="#" data-screen="coach" class="${state.screen === 'coach' ? 'active' : ''}">‚óé AI Coach</a></li><li><a href="#" data-screen="receipts" class="${state.screen === 'receipts' ? 'active' : ''}">‚óà Receipts</a></li><li><a href="#" data-screen="profile" class="${state.screen === 'profile' ? 'active' : ''}">‚óá Profile</a></li></ul><div class="sidebar-user"><div class="sidebar-name">${state.user?.name || 'User'}</div><div class="sidebar-email">${state.user?.email || ''}</div><span class="sidebar-logout" id="logout">Sign out</span></div></aside><main class="main">${content}</main></div>`;
    }

    function dashboardHTML() {
        const active = state.quests.filter(q => !q.done).slice(0, 2);
        const recent = state.receipts.slice(-3).reverse();
        return `<h1 class="page-title">Dashboard</h1><p class="page-subtitle">Day ${dayNum()} of your training</p><div class="stats"><div class="stat"><div class="stat-value">${totalXP()}</div><div class="stat-label">Total XP</div></div><div class="stat"><div class="stat-value">${state.receipts.length}</div><div class="stat-label">Receipts</div></div><div class="stat"><div class="stat-value">${state.quests.filter(q => q.done).length}</div><div class="stat-label">Quests Done</div></div><div class="stat"><div class="stat-value">${dayNum()}</div><div class="stat-label">Day</div></div></div><div class="dash-grid"><div><div class="card mb-20"><div class="card-header"><span class="card-header-title">Mode Levels</span><span class="card-badge">Current</span></div><div class="mode-bars"><div class="mode-bar"><span class="mode-name ideas">Ideas</span><div class="mode-track"><div class="mode-fill ideas" style="width:${state.scores.ideas}%"></div></div><span class="mode-value">${state.scores.ideas}%</span></div><div class="mode-bar"><span class="mode-name personality">Personality</span><div class="mode-track"><div class="mode-fill personality" style="width:${state.scores.personality}%"></div></div><span class="mode-value">${state.scores.personality}%</span></div><div class="mode-bar"><span class="mode-name execution">Execution</span><div class="mode-track"><div class="mode-fill execution" style="width:${state.scores.execution}%"></div></div><span class="mode-value">${state.scores.execution}%</span></div></div></div><div class="card"><div class="card-header"><span class="card-header-title">Today's Quests</span><a href="#" data-screen="quests" class="text-link">View all ‚Üí</a></div>${active.length ? active.map(q => `<div class="quest"><div class="quest-mode ${q.mode}">${q.mode.toUpperCase()}</div><div class="quest-title">${q.title}</div><div class="quest-meta"><span>${q.diff}</span><span class="quest-xp">+${q.xp} XP</span></div><div class="quest-actions"><button class="btn btn-small btn-success complete-quest" data-id="${q.id}">‚úì Complete</button><button class="btn btn-small btn-secondary skip-quest" data-id="${q.id}">Skip</button></div></div>`).join('') : '<p class="text-secondary">All done! New quests tomorrow.</p>'}</div></div><div><div class="card"><div class="card-header"><span class="card-header-title">Recent Receipts</span><span class="card-badge">${state.receipts.length} total</span></div>${recent.length ? recent.map(r => `<div class="receipt"><div class="receipt-check">‚úì</div><div class="receipt-content"><div class="receipt-title">${r.title}</div><div class="receipt-meta">${r.date} ¬∑ +${r.xp} XP</div></div></div>`).join('') : '<p class="text-secondary text-small">Complete quests to earn receipts</p>'}</div></div></div>`;
    }

    function questsHTML() {
        const active = state.quests.filter(q => !q.done);
        const done = state.quests.filter(q => q.done);
        return `<h1 class="page-title">IRL Quests</h1><p class="page-subtitle">Real challenges to level up your ${weakest()} mode</p><div class="card mb-30"><div class="card-header"><span class="card-header-title">Active</span><span class="card-badge">${active.length} remaining</span></div>${active.length ? active.map(q => `<div class="quest"><div class="quest-mode ${q.mode}">${q.mode.toUpperCase()}</div><div class="quest-title">${q.title}</div><div class="quest-meta"><span>${q.diff}</span><span class="quest-xp">+${q.xp} XP</span></div><div class="quest-actions"><button class="btn btn-small btn-success complete-quest" data-id="${q.id}">‚úì Complete</button><button class="btn btn-small btn-secondary skip-quest" data-id="${q.id}">Skip</button></div></div>`).join('') : '<p class="text-secondary">All done! Check back tomorrow.</p>'}</div>${done.length ? `<div class="card"><div class="card-header"><span class="card-header-title">Completed</span></div>${done.map(q => `<div class="quest done"><div class="quest-mode ${q.mode}">${q.mode.toUpperCase()}</div><div class="quest-title">${q.title}</div><div class="quest-meta"><span>Done</span><span class="quest-xp">+${q.xp} XP</span></div></div>`).join('')}</div>` : ''}`;
    }

    function coachHTML() {
        const msgs = state.chat.length ? state.chat.map(m => `<div class="chat-msg ${m.user ? 'user' : 'ai'}"><div class="chat-avatar">${m.user ? state.user.name[0] : 'AI'}</div><div class="chat-bubble">${m.text}</div></div>`).join('') : `<div class="chat-msg ai"><div class="chat-avatar">AI</div><div class="chat-bubble">I've analyzed your profile. You're strong in ${strongest()}, but your ${weakest()} mode needs work. What situation do you want help with?</div></div>`;
        return `<h1 class="page-title">AI Coach</h1><p class="page-subtitle">Tactical advice for ${weakest()} mode</p><div class="chat-container"><div class="chat-messages" id="chat-msgs">${msgs}${state.loading ? '<div class="chat-msg ai"><div class="chat-avatar">AI</div><div class="chat-bubble"><div class="spinner"></div></div></div>' : ''}</div><div class="chat-input-row"><textarea class="chat-input" id="chat-input" placeholder="Ask for advice..." rows="2"></textarea><button class="chat-send" id="send-msg">Send</button></div></div>`;
    }

    function receiptsHTML() {
        const byMode = { ideas: state.receipts.filter(r => r.mode === 'ideas').length, personality: state.receipts.filter(r => r.mode === 'personality').length, execution: state.receipts.filter(r => r.mode === 'execution').length };
        return `<h1 class="page-title">Receipts</h1><p class="page-subtitle">Proof of action</p><div class="stats" style="grid-template-columns:repeat(3,1fr)"><div class="stat"><div class="stat-value" style="color:var(--ideas-color)">${byMode.ideas}</div><div class="stat-label">Ideas</div></div><div class="stat"><div class="stat-value" style="color:var(--personality-color)">${byMode.personality}</div><div class="stat-label">Personality</div></div><div class="stat"><div class="stat-value" style="color:var(--execution-color)">${byMode.execution}</div><div class="stat-label">Execution</div></div></div><div class="card"><div class="card-header"><span class="card-header-title">All Receipts</span><span class="card-badge">${totalXP()} XP</span></div>${state.receipts.length ? [...state.receipts].reverse().map(r => `<div class="receipt"><div class="receipt-check">‚úì</div><div class="receipt-content"><div class="receipt-title">${r.title}</div><div class="receipt-meta">${r.date} ¬∑ ${r.mode} ¬∑ +${r.xp} XP</div></div></div>`).join('') : '<p class="text-secondary">Complete quests to earn receipts.</p>'}</div>`;
    }

    function profileHTML() {
        return `<h1 class="page-title">Profile</h1><p class="page-subtitle">Your stats</p><div class="card mb-30"><div class="card-header"><span class="card-header-title">Mode Profile</span><span class="card-badge">Day ${dayNum()}</span></div><div class="mode-bars"><div class="mode-bar"><span class="mode-name ideas">Ideas</span><div class="mode-track"><div class="mode-fill ideas" style="width:${state.scores.ideas}%"></div></div><span class="mode-value">${state.scores.ideas}%</span></div><div class="mode-bar"><span class="mode-name personality">Personality</span><div class="mode-track"><div class="mode-fill personality" style="width:${state.scores.personality}%"></div></div><span class="mode-value">${state.scores.personality}%</span></div><div class="mode-bar"><span class="mode-name execution">Execution</span><div class="mode-track"><div class="mode-fill execution" style="width:${state.scores.execution}%"></div></div><span class="mode-value">${state.scores.execution}%</span></div></div><div class="verdict mt-30"><div class="verdict-title">Focus</div><div class="verdict-text">Training focused on <strong>${weakest()}</strong> mode.</div></div></div><div class="card"><div class="card-header"><span class="card-header-title">Account</span></div><p class="mb-20"><strong>Name:</strong> ${state.user?.name}</p><p class="mb-20"><strong>Email:</strong> ${state.user?.email}</p><p class="mb-20"><strong>Plan:</strong> ${state.user?.plan || 'Free'}</p><p><strong>Started:</strong> ${new Date(state.user?.startDate).toLocaleDateString()}</p></div>`;
    }

    function bindEvents() {
        document.getElementById('login-form')?.addEventListener('submit', e => { e.preventDefault(); login(); });
        document.getElementById('signup-form')?.addEventListener('submit', e => { e.preventDefault(); signup(); });
        document.getElementById('to-signup')?.addEventListener('click', () => { state.screen = 'signup'; render(); });
        document.getElementById('to-login')?.addEventListener('click', () => { state.screen = 'login'; render(); });

        document.querySelectorAll('.pricing-card[data-plan]').forEach(c => c.addEventListener('click', () => { state.selectedPlan = c.dataset.plan; render(); }));
        document.getElementById('to-onboarding')?.addEventListener('click', () => { if (state.selectedPlan) { state.user.plan = state.selectedPlan; state.screen = 'onboarding'; render(); } });

        document.querySelectorAll('.choice-card[data-method]').forEach(c => c.addEventListener('click', () => { state.onboardingMethod = c.dataset.method; render(); }));
        document.getElementById('continue-onboarding')?.addEventListener('click', () => { state.screen = state.onboardingMethod === 'upload' ? 'upload' : 'quiz'; render(); });

        const zone = document.getElementById('upload-zone');
        const input = document.getElementById('file-input');
        zone?.addEventListener('click', () => input?.click());
        zone?.addEventListener('dragover', e => e.preventDefault());
        zone?.addEventListener('drop', e => { e.preventDefault(); handleFile(e.dataTransfer.files[0]); });
        input?.addEventListener('change', e => handleFile(e.target.files[0]));
        document.getElementById('remove-file')?.addEventListener('click', () => { state.uploadedFile = null; render(); });
        document.getElementById('analyze-btn')?.addEventListener('click', analyze);
        document.getElementById('skip-quiz')?.addEventListener('click', () => { state.screen = 'quiz'; render(); });

        document.querySelectorAll('.option')?.forEach(o => o.addEventListener('click', () => answerQuiz(parseInt(o.dataset.idx))));

        document.getElementById('start-app')?.addEventListener('click', startApp);

        document.querySelectorAll('[data-screen]').forEach(a => a.addEventListener('click', e => { e.preventDefault(); state.screen = a.dataset.screen; render(); }));
        document.getElementById('logout')?.addEventListener('click', logout);

        document.querySelectorAll('.complete-quest').forEach(b => b.addEventListener('click', () => completeQuest(b.dataset.id)));
        document.querySelectorAll('.skip-quest').forEach(b => b.addEventListener('click', () => skipQuest(b.dataset.id)));

        document.getElementById('send-msg')?.addEventListener('click', sendChat);
        document.getElementById('chat-input')?.addEventListener('keypress', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendChat(); } });
    }

    function login() {
        const email = document.getElementById('email').value;
        const pass = document.getElementById('pass').value;
        const users = JSON.parse(localStorage.getItem('t1p_users') || '{}');
        if (users[email]?.pass === pass) {
            state.user = users[email];
            if (load()) render();
            else { state.screen = 'pricing'; render(); }
        } else alert('Invalid credentials');
    }

    function signup() {
        const name = document.getElementById('name').value;
        const email = document.getElementById('email').value;
        const pass = document.getElementById('pass').value;
        const users = JSON.parse(localStorage.getItem('t1p_users') || '{}');
        if (users[email]) { alert('Email exists'); return; }
        state.user = { name, email, pass, startDate: new Date().toISOString(), onboarded: false };
        users[email] = state.user;
        localStorage.setItem('t1p_users', JSON.stringify(users));
        state.screen = 'pricing';
        render();
    }

    function handleFile(f) {
        if (f?.name.endsWith('.json')) { state.uploadedFile = f; render(); }
        else alert('Please upload a .json file');
    }

    async function analyze() {
        state.screen = 'analyzing'; render();
        try {
            const txt = await state.uploadedFile.text();
            const res = await analyzeFile(txt);
            if (res?.scores) state.scores = res.scores;
            else state.scores = { ideas: 60, personality: 45, execution: 55 };
        } catch { state.scores = { ideas: 60, personality: 45, execution: 55 }; }
        state.screen = 'results'; render();
    }

    function answerQuiz(idx) {
        const q = questions[state.quizStep];
        state.quizAnswers.push(q.options[idx]);
        if (state.quizStep < questions.length - 1) { state.quizStep++; render(); }
        else calcQuiz();
    }

    function calcQuiz() {
        const s = { ideas: 50, personality: 50, execution: 50 };
        state.quizAnswers.forEach(a => { s[a.mode] = Math.min(100, Math.max(0, s[a.mode] + a.w * 7)); });
        state.scores = s;
        state.screen = 'results'; render();
    }

    function startApp() {
        state.user.onboarded = true;
        state.user.baselineScores = { ...state.scores };
        state.quests = genQuests();
        const users = JSON.parse(localStorage.getItem('t1p_users') || '{}');
        users[state.user.email] = state.user;
        localStorage.setItem('t1p_users', JSON.stringify(users));
        save();
        state.screen = 'dashboard'; render();
    }

    function completeQuest(id) {
        const q = state.quests.find(x => x.id == id);
        if (q && !q.done) {
            q.done = true;
            state.receipts.push({ id: Date.now(), title: q.title, mode: q.mode, xp: q.xp, date: new Date().toLocaleDateString() });
            state.scores[q.mode] = Math.min(100, state.scores[q.mode] + 1);
            save(); render();
        }
    }

    function skipQuest(id) {
        state.quests = state.quests.filter(q => q.id != id);
        save(); render();
    }

    async function sendChat() {
        const input = document.getElementById('chat-input');
        const msg = input.value.trim();
        if (!msg) return;
        state.chat.push({ text: msg, user: true });
        input.value = '';
        state.loading = true; render();
        const reply = await aiChat(msg);
        state.chat.push({ text: reply || 'Error. Try again.', user: false });
        state.loading = false;
        save(); render();
        document.getElementById('chat-msgs')?.scrollTo(0, 999999);
    }

    function logout() {
        state.user = null;
        state.screen = 'login';
        state.scores = { ideas: 50, personality: 50, execution: 50 };
        state.quests = [];
        state.receipts = [];
        state.chat = [];
        localStorage.removeItem('t1p_state');
        render();
    }

    if (!load()) render(); else render();
    </script>
</body>
</html>
