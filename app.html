<!-- Test PR Work Flow -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>AI Proof Club ‚Äî Build Skills AI Can't Replace</title>
    <meta name="description" content="Build the skills AI can't replace ‚Äî with adaptive technology that tracks your growth, locks in your progress, and proves how far you've come.">
    
    <!-- Open Graph / Social Media -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://aiproof.club/">
    <meta property="og:title" content="AI Proof Club ‚Äî Build Skills AI Can't Replace">
    <meta property="og:description" content="Build the skills AI can't replace ‚Äî with adaptive technology that tracks your growth, locks in your progress, and proves how far you've come.">
    <meta property="og:image" content="https://aiproof.club/og-image.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    
    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://aiproof.club/">
    <meta name="twitter:title" content="AI Proof Club ‚Äî Build Skills AI Can't Replace">
    <meta name="twitter:description" content="Build the skills AI can't replace ‚Äî with adaptive technology that tracks your growth, locks in your progress, and proves how far you've come.">
    <meta name="twitter:image" content="https://aiproof.club/og-image.png">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Instrument+Serif:ital@0;1&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="shared/styles.css">

</head>
<body>
<div id="app"></div>
<script src="shared/config.js"></script>
<script src="shared/helpers.js"></script>
<script src="shared/forecasts-data.js"></script>
<script>
function render(){
    const screens={
        login:loginH, signup:signupH, forgot:forgotH, pricing:pricingH, resetPassword:resetPasswordH,
        // Free diagnostic flow (from landing page) - 4 questions with email gate
        diagnostic:diagnosticH, company:companyH, threat:threatH, freeQuiz:quizH, freeResults:freeResultsH,
        // Onboarding flow
        onboarding:onboardingH, upload:uploadH, analyzing:analyzingH, quiz:quizH, results:resultsH,
        // App screens
        dashboard:()=>appH(dashH()), quests:()=>appH(questsH()), coach:()=>appH(coachH()), 
        receipts:()=>appH(receiptsH()), capsules:()=>appH(capsulesH()), review:()=>appH(reviewH()), 
        settings:()=>appH(settingsH()), forecasts:()=>appH(forecastsH())
    };
    document.getElementById('app').innerHTML=(screens[S.screen]||loginH)()+(S.modal?modalH():'');
    if(typeof updateHash === 'function') updateHash();
    bindEvents();
}

// 4-question AI-Proof Score flow
function diagnosticH(){
    const step = S.diagnosticStep;
    
    // Step 0: Email + Industry collection
    if(step === 0){
        return `<div class="screen-center"><div class="container-sm"><div class="logo">AI PROOF <span>CLUB</span></div>
        <div class="card">
            <h2 class="card-title text-center">Get Your AI-Proof Score</h2>
            <p class="card-subtitle text-center">4 quick questions to see where you stand</p>
            
            <div style="background:var(--bg-primary);padding:20px;margin:20px 0;text-align:center">
                <div style="display:flex;gap:15px;justify-content:center;margin-bottom:15px">
                    <div><span style="font-size:24px">üí°</span><div style="font-size:10px;color:var(--ideas)">Ideas</div></div>
                    <div><span style="font-size:24px">‚ö°</span><div style="font-size:10px;color:var(--personality)">Personality</div></div>
                    <div><span style="font-size:24px">üéØ</span><div style="font-size:10px;color:var(--execution)">Execution</div></div>
                </div>
                <p class="text-secondary text-small">We measure the 3 modes that separate people who thrive with AI vs get replaced by it.</p>
            </div>
            
            <form id="diagnostic-start-form">
                <div class="form-group">
                    <label class="form-label">Your Email</label>
                    <input type="email" class="form-input" id="diag-email" required placeholder="you@email.com">
                </div>
                <div class="form-group">
                    <label class="form-label">Your Industry</label>
                    <select class="form-input" id="diag-industry" required>
                        <option value="">Select your industry...</option>
                        ${INDUSTRIES.map(i=>`<option value="${i}">${i}</option>`).join('')}
                    </select>
                </div>
                <button type="submit" class="btn btn-primary btn-full">Get My Score ‚Üí</button>
            </form>
            <p class="text-center text-secondary text-small mt-15">Takes 60 seconds.</p>
        </div>
        <p class="text-center mt-20"><a class="text-link text-small" id="back-to-login">‚Üê Back to login</a></p>
        </div></div>`;
    }
    
    // Steps 1-4: Questions
    if(step >= 1 && step <= 4){
        const q = DiagnosticQs[step - 1];
        return `<div class="screen-center"><div class="container-md">
            <div class="logo">AI PROOF <span>CLUB</span></div>
            <div class="progress-bar">${[1,2,3,4].map(i=>`<div class="progress-dot ${i<step?'done':i===step?'active':''}"></div>`).join('')}</div>
            <div class="q-number">Question ${step} of 4</div>
            <div class="q-text">${q.t}</div>
            <div class="options">${q.o.map((o,i)=>`<button class="option diag-option" data-idx="${i}">${o.t}</button>`).join('')}</div>
        </div></div>`;
    }
    
    // Step 5: Results
    if(step === 5){
        const scores = calculateDiagnosticScores();
        const {ideas:i,personality:p,execution:e} = scores;
        const avgScore = Math.round((i+p+e)/3);
        const percentile = getPercentile(avgScore);
        const weak = ['ideas','personality','execution'].reduce((a,b)=>scores[a]<scores[b]?a:b);
        
        return `<div class="screen-center"><div class="container-md"><div class="logo">AI PROOF <span>CLUB</span></div>
        <div class="card text-center">
            <h2 class="card-title">Your AI-Proof Score</h2>
            
            <div class="results-meters">
                <div class="meter"><div class="meter-circle ideas">${i}%</div><div class="meter-label">Ideas</div></div>
                <div class="meter"><div class="meter-circle personality">${p}%</div><div class="meter-label">Personality</div></div>
                <div class="meter"><div class="meter-circle execution">${e}%</div><div class="meter-label">Execution</div></div>
            </div>
            
            <div class="verdict">
                <div class="verdict-title">Your Position</div>
                <div class="verdict-text">You're in the <strong>${percentile}th percentile</strong>. The AI-Proof threshold is 85%+.</div>
            </div>
            
            <div class="verdict" style="border-color:var(--${weak})">
                <div class="verdict-title">Your Weakest Mode</div>
                <div class="verdict-text"><strong style="text-transform:capitalize">${weak}</strong> is where AI will hit you hardest. This is where your training starts.</div>
            </div>
            
            <div style="background:var(--bg-primary);padding:20px;margin-top:25px;text-align:left">
                <h4 style="font-size:13px;margin-bottom:10px">What happens next?</h4>
                <p class="text-secondary text-small">AI Proof Club gives you weekly quests based on your profile to build real-world proof that you can do what AI can't. Track forecasts. Level up. Become irreplaceable.</p>
            </div>
            
            <div style="display:flex;flex-direction:column;gap:15px;margin-top:20px">
                <div style="border:2px solid var(--accent);padding:15px;background:var(--bg-primary)">
                    <div style="font-size:10px;color:var(--accent);text-transform:uppercase;letter-spacing:1px;margin-bottom:5px">Monthly</div>
                    <div style="font-size:24px;font-weight:700">$9.99<span style="font-size:12px;color:var(--text-secondary)">/month</span></div>
                    <a href="${STRIPE_LINK}?prefilled_email=${encodeURIComponent(S.diagnosticEmail||'')}" class="btn btn-primary btn-full mt-10" id="diag-to-signup-link">Start Monthly ‚Üí</a>
                </div>
                <div style="border:1px solid var(--success);padding:15px">
                    <div style="font-size:10px;color:var(--success);text-transform:uppercase;letter-spacing:1px;margin-bottom:5px">Best Value ‚Äî 2 Months Free</div>
                    <div style="font-size:24px;font-weight:700">$99<span style="font-size:12px;color:var(--text-secondary)">/year</span></div>
                    <a href="${STRIPE_ANNUAL}?prefilled_email=${encodeURIComponent(S.diagnosticEmail||'')}" class="btn btn-secondary btn-full mt-10" id="diag-to-signup-annual">Start Annual ‚Üí</a>
                </div>
            </div>
            <p class="text-center text-secondary text-small mt-10">Cancel anytime</p>
        </div>
        <p class="text-center mt-20"><a class="text-link text-small" id="back-to-login">‚Üê Back to login</a></p>
        </div></div>`;
    }
    
    return loginH();
}

function calculateDiagnosticScores(){
    let scores = {ideas: 50, personality: 50, execution: 50};
    S.diagnosticAnswers.forEach((answerIdx, qIdx) => {
        const q = DiagnosticQs[qIdx];
        if(q && q.o[answerIdx]){
            const opt = q.o[answerIdx];
            scores[opt.m] += opt.w * 8; // Amplify since fewer questions
        }
    });
    // Clamp scores
    Object.keys(scores).forEach(k => {
        scores[k] = Math.max(20, Math.min(95, scores[k]));
    });
    return scores;
}

// ===== THREAT PROVIDERS =====
var THREAT_PROVIDERS={google:{name:'Google',color:'#4285F4',tagline:'Google is launching AI products faster than any company in history.',products:[{name:'Gemini 2.5 Pro',date:'2025',desc:'Most capable reasoning model'},{name:'AI Overviews in Search',date:'2024-2025',desc:'AI answers replacing website clicks'},{name:'Gemini in Workspace',date:'2024-2025',desc:'AI in Gmail, Docs, Sheets'},{name:'Google Veo 2',date:'2025',desc:'AI video generation from text'},{name:'Project Astra',date:'2025',desc:'Real-time AI assistant with vision'},{name:'Waymo Expansion',date:'2025',desc:'Autonomous ride-hailing in 10+ cities'},{name:'Gemini Code Assist',date:'2025',desc:'AI pair-programmer'},{name:'AI-Powered Ads',date:'2025',desc:'Fully automated ad creation'}],defaultMonths:18},claude:{name:'Anthropic (Claude)',color:'#D97706',tagline:"Anthropic is building the most trusted AI \u2014 coming for knowledge work.",products:[{name:'Claude Opus 4',date:'2025',desc:'Most capable AI for complex reasoning'},{name:'Computer Use',date:'2025',desc:'AI that operates your computer'},{name:'Claude for Enterprise',date:'2024-2025',desc:'Enterprise AI with team collaboration'},{name:'Claude Code',date:'2025',desc:'AI coding agent'},{name:'Claude in Excel/Chrome',date:'2025',desc:'AI agents in spreadsheets and browsers'},{name:'MCP Protocol',date:'2024-2025',desc:'AI connecting to any tool or API'},{name:'Extended Thinking',date:'2025',desc:'AI reasoning for minutes'}],defaultMonths:14},openai:{name:'OpenAI',color:'#10A37F',tagline:'OpenAI is racing to build AGI \u2014 every product reshapes your industry.',products:[{name:'ChatGPT',date:'2024-2025',desc:'200M+ weekly users doing specialist work'},{name:'Sora',date:'2025',desc:'AI video generation'},{name:'GPT Store',date:'2024-2025',desc:'Marketplace of AI apps'},{name:'o3 Reasoning',date:'2025',desc:'PhD-level reasoning'},{name:'Operator',date:'2025',desc:'AI completing tasks'},{name:'Codex',date:'2024-2025',desc:'AI writing code'},{name:'Voice Mode',date:'2024-2025',desc:'Natural voice replacing support'},{name:'DALL-E',date:'2024-2025',desc:'AI images'}],defaultMonths:12}};

function downloadReportPDF(type){
    var domain,result,providerName='',providerColor='#00e5c7';
    if(type==='company'){
        domain=S.companyUrl.replace(/https?:\/\//,'').replace(/www\./,'').replace(/\/$/,'');
        result=S.companyResult;
    } else {
        domain=S.threatUrl.replace(/https?:\/\//,'').replace(/www\./,'').replace(/\/$/,'');
        result=S.threatResult;
        var prov=THREAT_PROVIDERS[S.threatProvider];
        providerName=prov?prov.name:'';providerColor=prov?prov.color:'#00e5c7';
    }
    if(!result)return;
    var opps=result.opportunities||[],risks=result.threats||[];
    var title=type==='company'?'AI Opportunity Report: '+domain:providerName+' Threat Assessment: '+domain;
    var html='<!DOCTYPE html><html><head><meta charset="utf-8"><title>'+title+'</title>';
    html+='<style>body{font-family:-apple-system,BlinkMacSystemFont,sans-serif;max-width:700px;margin:0 auto;padding:40px 30px;color:#1a1a2e;line-height:1.6}h1{font-size:22px;margin-bottom:4px}h2{font-size:11px;margin-top:30px;margin-bottom:12px;text-transform:uppercase;letter-spacing:1.5px;color:#666}.subtitle{color:#666;font-size:13px;margin-bottom:25px}.opp{border-left:3px solid '+providerColor+';padding:12px 16px;margin-bottom:12px;background:#f8f9fa}.opp-label{font-size:10px;text-transform:uppercase;letter-spacing:1.5px;color:'+providerColor+';margin-bottom:4px}.opp-title{font-size:15px;font-weight:700;margin-bottom:4px}.opp-desc{font-size:13px;color:#444}.risk{margin-bottom:10px;padding:8px 0;border-bottom:1px solid #eee}.risk-head{display:flex;justify-content:space-between}.risk-name{font-weight:600;font-size:13px}.risk-prob{font-weight:700;color:#e67e22;font-size:12px}.risk-impact{font-size:12px;color:#666;margin-top:2px}.banner{padding:20px;margin-bottom:25px;border-left:4px solid '+providerColor+';background:#f8f9fa}.threat-info{background:#f0f0f5;padding:16px;margin-bottom:15px;border-radius:4px}.topbar{text-align:center;padding:12px;background:#0a0a14;color:#00e5c7;font-size:13px;font-weight:700;letter-spacing:3px;margin:-40px -30px 30px -30px}.footer{margin-top:40px;padding-top:20px;border-top:1px solid #ddd;font-size:11px;color:#999;text-align:center}@media print{body{padding:20px}.topbar{margin:-20px -20px 30px -20px}}</style></head><body>';
    html+='<div class="topbar">AIPROOF.CLUB</div>';
    html+='<div class="banner"><h1>'+title+'</h1><p class="subtitle">'+(result.company_description||domain)+'</p></div>';
    if(type==='threat'&&result.threat_level){
        html+='<div class="threat-info"><strong>Threat Level:</strong> '+result.threat_level+'<br><strong>Timeline:</strong> '+(result.months_until_threat||'')+ ' months<br>'+(result.timeline_reason||'')+'</div>';
    }
    html+='<h2>Opportunities ('+opps.length+')</h2>';
    opps.forEach(function(o,i){html+='<div class="opp">'+(o.prediction?'<div class="opp-label">'+o.prediction+'</div>':'')+'<div class="opp-title">'+(i+1)+'. '+o.title+'</div><div class="opp-desc">'+o.description+'</div></div>';});
    html+='<h2>Risks ('+risks.length+')</h2>';
    risks.forEach(function(t){html+='<div class="risk"><div class="risk-head"><span class="risk-name">'+t.prediction+'</span><span class="risk-prob">'+t.probability+'%</span></div><div class="risk-impact">'+t.impact+'</div></div>';});
    if(result.summary){html+='<h2>Summary</h2><p style="font-size:13px">'+result.summary+'</p>';}
    html+='<div class="footer">Generated by AIProof.Club &middot; aiproof.club &middot; Questions? erica@aiproof.club</div></body></html>';
    var w=window.open('','_blank');w.document.write(html);w.document.close();
    setTimeout(function(){w.print();},500);
}

function emailReportToTeam(type){
    var domain,result,email,providerName='';
    if(type==='company'){domain=S.companyUrl.replace(/https?:\/\//,'').replace(/www\./,'').replace(/\/$/,'');result=S.companyResult;email=S.companyEmail;}
    else{domain=S.threatUrl.replace(/https?:\/\//,'').replace(/www\./,'').replace(/\/$/,'');result=S.threatResult;email=S.threatEmail;var p=THREAT_PROVIDERS[S.threatProvider];providerName=p?p.name+' ':'';}
    var teamEmail=document.getElementById('team-email-'+type)?.value;
    if(!teamEmail||!result)return;
    var opps=result.opportunities||[];
    var subject=encodeURIComponent('AI Threat + Opportunity Snapshot for '+domain);
    var body='Hi,\n\nI ran an AI threat and opportunity assessment on '+domain+' using AI Proof Club. It is a platform that takes major AI and technology predictions (like timelines for self-driving cars, AI-human integration etc.) and translates them into actionable opportunities for companies.\n\nThought this was interesting and worth sharing:\n\n';
    if(result.threat_level)body+='Threat Level: '+result.threat_level+'\n';
    if(result.months_until_threat)body+='Timeline: '+result.months_until_threat+' months\n\n';
    body+='Top Opportunities:\n';
    opps.forEach(function(o,i){body+=(i+1)+'. '+o.title+' \u2014 '+o.description+'\n\n';});
    body+='If you want to go deeper on what this could look like in practice, the founder is available here: erica@aiproof.club\n\n\u2014 Shared via AI Proof Club';
    window.open('mailto:'+teamEmail+'?subject='+subject+'&body='+encodeURIComponent(body));
    var statusEl=document.getElementById(type+'-email-status');
    if(statusEl){statusEl.style.display='block';setTimeout(function(){statusEl.style.display='none';},3000);}
}

function generateCompanyOpportunities(d,ind){return [{prediction:'Loneliness epidemic',title:'Community-Powered Growth',description:d+' could build community features that turn customers into a tribe.'},{prediction:'AI-generated movies',title:'AI Content Studio',description:'Use generative AI to produce brand content at 100x speed.'},{prediction:'Human-AI merge',title:'Human Premium Positioning',description:'What makes '+d+' uniquely human becomes more valuable.'},{prediction:'Self-driving cars',title:'In-Transit Experiences',description:'Autonomous vehicles free up commute hours for '+d+'.'},{prediction:'Continuous learning',title:'AI Upskilling Platform',description:'Build a learning system that keeps your team current.'},{prediction:'AI copilots',title:'AI Workflow Integration',description:'Embed AI copilot features before competitors.'},{prediction:'Trust collapses',title:'Verified Authenticity',description:d+' can build verified-authentic brand signals.'},{prediction:'Filter bubbles',title:'Shared Experiences',description:d+' could create live non-algorithmic moments.'},{prediction:'Mental health',title:'Wellbeing Integration',description:'Integrate wellbeing features for lower turnover.'},{prediction:'AI agents',title:'Agent-Ready Infrastructure',description:'Prepare for AI agents acting for customers.'},{prediction:'Data privacy',title:'Privacy-First',description:'Turn data protection into a selling point.'},{prediction:'Voice interfaces',title:'Voice-First Features',description:'Design voice interaction for core product.'},{prediction:'Personalization',title:'Personalized Journeys',description:'AI-powered individualized experiences.'},{prediction:'Automation',title:'Human+AI Model',description:'Redesign teams around human-AI collaboration.'},{prediction:'Creator economy',title:'Creator Partnerships',description:'Build a creator ecosystem around '+d+'.'}];}

function generateCompanyRisks(d){return [{prediction:'Discovery channels become obsolete',probability:82,impact:'AI may replace how customers find '+d+'.'},{prediction:'AI competitors flood market',probability:78,impact:'New entrants could replicate offerings cheaply.'},{prediction:'Customer expectations outpace adoption',probability:85,impact:'Customers will expect AI features as standard.'},{prediction:'Talent migrates to AI-native cos',probability:74,impact:'Top performers may leave for AI-forward companies.'},{prediction:'Regulatory shifts',probability:68,impact:'AI regulations could change how '+d+' operates.'},{prediction:'Brand trust erodes',probability:72,impact:'AI content makes authenticity signals weaker.'},{prediction:'Pricing pressure',probability:80,impact:'AI-enabled competitors will undercut pricing.'}];}

function companyH(){
    if(S.companyStep===0){
        return `<div class="screen-center"><div class="container-sm">
            <div class="logo">AI PROOF <span>CLUB</span></div>
            <div class="card">
                <h2 class="card-title" style="font-size:20px;margin-bottom:6px">Company AI Opportunity Map</h2>
                <p class="text-secondary text-small" style="margin-bottom:4px">Enter a company and we'll map AI-driven opportunities and risks.</p>
                <p class="text-secondary text-small" style="margin-bottom:20px;color:var(--accent)">3 opportunities free. Full 15 after unlock.</p>
                <form id="company-form">
                    <div class="form-group"><label class="form-label">Company Website</label><input type="text" class="form-input" id="company-url" required placeholder="yourwebsite.com"></div>
                    <div class="form-group"><label class="form-label">What does the company do?</label><input type="text" class="form-input" id="company-desc" placeholder="e.g. AI executive assistant" maxlength="150"></div>
                    <div class="form-group"><label class="form-label">Your Email</label><input type="email" class="form-input" id="company-email" required placeholder="you@email.com"></div>
                    <div class="form-group"><label class="form-label">Industry</label><select class="form-input" id="company-industry" required><option value="">Select industry</option>${INDUSTRIES.map(i=>`<option value="${i}">${i}</option>`).join('')}</select></div>
                    <button type="submit" class="btn btn-primary btn-full">Show Me Opportunities for My Company \u2192</button>
                </form>
            </div></div></div>`;
    }
    if(S.companyStep===1){
        var steps=['Reading website...','Identifying business model...','Matching predictions...','Finding opportunities...','Building report...'];
        var allDone=S.companyLoadingStep>=steps.length;
        return `<div class="screen-center"><div class="container-sm"><div class="logo">AI PROOF <span>CLUB</span></div><div class="card text-center" style="padding:40px"><div style="font-size:28px;margin-bottom:15px">${allDone?'üß†':'üîç'}</div><h2 class="card-title">Analyzing ${S.companyUrl.replace(/https?:\/\//,'').replace(/\/$/,'')}</h2><div style="margin-top:20px">${steps.map((st,i)=>`<div style="display:flex;align-items:center;gap:10px;padding:8px 0;opacity:${i<=S.companyLoadingStep?1:0.3}"><span style="color:${i<S.companyLoadingStep?'var(--success)':i===S.companyLoadingStep?'var(--accent)':'var(--text-muted)'};font-size:14px">${i<S.companyLoadingStep?'‚úì':i===S.companyLoadingStep?'‚óâ':'‚óã'}</span><span class="text-small">${st}</span></div>`).join('')}</div>${allDone?`<div style="margin-top:24px;padding-top:20px;border-top:1px solid var(--bg-tertiary)"><div style="display:flex;align-items:center;justify-content:center;gap:12px"><div style="width:20px;height:20px;border:2px solid var(--accent);border-top-color:transparent;border-radius:50%;animation:spin 0.8s linear infinite"></div><span style="font-size:13px;color:var(--text-secondary)">AI is reasoning about your company...</span></div><div style="margin-top:16px;font-size:11px;color:var(--text-muted);line-height:1.6">Cross-referencing 119 predictions against your business model.<br>This usually takes 15-30 seconds.</div></div>`:''}</div></div></div>`;
    }
    if(S.companyStep===2&&S.companyResult){
        var r=S.companyResult,domain=S.companyUrl.replace(/https?:\/\//,'').replace(/www\./,'').replace(/\/$/,'');
        var allOpps=r.opportunities||[],allRisks=r.threats||[];
        var opps=allOpps;
        var risks=allRisks;
        var totalSlides=opps.length+3; // 0=status, 1..N=opps, N+1=risks, N+2=actions
        var slide=Math.max(0,Math.min(S.reportSlide||0,totalSlides-1));
        var statusData=r.ai_status||{};
        
        // Slide navigation bar
        var navDots='';for(var di=0;di<totalSlides;di++){navDots+=`<div style="width:${di===slide?'20px':'8px'};height:8px;border-radius:4px;background:${di===slide?'var(--accent)':'rgba(255,255,255,0.2)'};transition:all 0.3s"></div>`;}
        
        var h=`<div class="screen-center" style="align-items:flex-start;padding-top:40px"><div class="container-sm"><div class="logo">AI PROOF <span>CLUB</span></div>${S.companyUnlocked?'<div style="text-align:center;margin-bottom:15px;padding:10px;background:var(--accent);color:#000;font-size:11px;text-transform:uppercase;letter-spacing:2px;font-weight:700">\u2713 Full Report Unlocked</div>':''}`;
        
        // --- SLIDE: STATUS (slide 0) ---
        if(slide===0){
            var statusIcon=statusData.level==='High Risk'?'üî¥':statusData.level==='Well Positioned'?'üü¢':'üü°';
            var statusColor=statusData.level==='High Risk'?'var(--danger)':statusData.level==='Well Positioned'?'var(--success)':'var(--warning)';
            var statusBg=statusData.level==='High Risk'?'rgba(255,60,60,0.12)':statusData.level==='Well Positioned'?'rgba(0,200,100,0.12)':'rgba(255,170,0,0.12)';
            var statusBorder=statusData.level==='High Risk'?'rgba(255,60,60,0.3)':statusData.level==='Well Positioned'?'rgba(0,200,100,0.3)':'rgba(255,170,0,0.3)';
            h+=`<div style="margin-bottom:20px;padding:24px;background:linear-gradient(135deg,${statusBg},rgba(0,0,0,0.02));border:1px solid ${statusBorder};position:relative"><div style="position:absolute;top:0;left:0;width:4px;height:100%;background:${statusColor}"></div><div style="display:flex;align-items:center;gap:8px;margin-bottom:10px"><span style="font-size:18px">${statusIcon}</span><span style="font-size:10px;color:${statusColor};text-transform:uppercase;letter-spacing:2px;font-weight:700">AI-Proof Status</span></div><h2 style="font-size:24px;font-weight:700;margin-bottom:12px">${statusData.level||'Moderately Positioned'}</h2><p style="font-size:14px;color:var(--text-secondary);line-height:1.7">${statusData.summary||''}</p>${r.company_description?`<p style="font-size:11px;color:var(--text-muted);margin-top:14px;padding-top:12px;border-top:1px solid ${statusBorder}">${domain} ‚Äî ${r.company_description}</p>`:''}</div>`;
            h+=`<div style="text-align:center;padding:10px 0"><p style="font-size:12px;color:var(--text-muted);margin-bottom:4px">${opps.length} opportunities ¬∑ ${risks.length} risks identified</p></div>`;
        }
        // --- SLIDES: INDIVIDUAL OPPORTUNITIES (slides 1..N) ---
        else if(slide>=1&&slide<=opps.length){
            var oi=slide-1,o=opps[oi];
            var plan=S.plans[oi];
            h+=`<div style="font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:2px;margin-bottom:8px">Opportunity ${oi+1} of ${opps.length}</div>`;
            h+=`<div class="card" style="margin-bottom:16px;border-left:3px solid var(--accent);padding:20px 24px">${o.prediction?`<div style="font-size:10px;color:var(--accent);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:10px">üîÆ Prediction: ${o.prediction}</div>`:''}<div style="font-size:18px;font-weight:700;margin-bottom:10px">${o.title}</div><p style="font-size:14px;color:var(--text-secondary);line-height:1.7">${o.description}</p>`;
            // Generate Plan button or plan display
            if(plan&&plan.steps&&plan.steps.length>0){
                h+=`<div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--bg-tertiary)"><div style="font-size:10px;color:var(--success);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:12px">‚úì Action Plan</div>`;
                plan.steps.forEach(function(step,si){h+=`<div style="display:flex;gap:10px;margin-bottom:10px"><span style="color:var(--accent);font-weight:700;font-size:13px;min-width:20px">${si+1}.</span><div><div style="font-size:13px;font-weight:600;margin-bottom:3px">${step.title}</div><p style="font-size:12px;color:var(--text-secondary);line-height:1.5">${step.desc}</p>${step.timeline?`<span style="font-size:10px;color:var(--text-muted)">‚è± ${step.timeline}</span>`:''}</div></div>`;});
                h+=`</div>`;
            } else if(plan&&plan.generating){
                h+=`<div style="margin-top:16px;text-align:center;padding:20px 0"><div style="display:inline-block;width:20px;height:20px;border:2px solid var(--accent);border-top-color:transparent;border-radius:50%;animation:spin 0.8s linear infinite"></div><p style="font-size:12px;color:var(--text-muted);margin-top:8px">Generating action plan...</p></div>`;
            } else {
                h+=`<button class="btn btn-secondary btn-full" style="margin-top:16px" id="gen-plan-${oi}">‚ö° Generate Action Plan</button>`;
            }
            h+=`</div>`;
        }
        // --- SLIDE: RISKS (slide N+1) ---
        else if(slide===opps.length+1){
            h+=`<div style="font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:2px;margin-bottom:8px">Risks to Watch</div>`;
            h+=`<div class="card" style="margin-bottom:16px;border-left:3px solid var(--warning);padding:20px 24px"><h3 style="font-size:11px;color:var(--warning);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:14px">‚ö†Ô∏è ${risks.length} Risks Identified</h3>`;
            risks.forEach(function(t,ti){h+=`<div style="padding:10px 0;${ti<risks.length-1?'border-bottom:1px solid var(--bg-tertiary)':''}"><div style="display:flex;justify-content:space-between;align-items:center"><span style="font-size:13px;font-weight:600">${t.prediction}</span><span style="font-size:11px;font-weight:700;color:var(--warning);background:rgba(255,170,0,0.12);padding:2px 8px;border-radius:10px">${t.probability}%</span></div><p style="font-size:12px;color:var(--text-secondary);margin-top:4px;line-height:1.5">${t.impact}</p></div>`;});
            h+=`</div>`;
        }
        // --- SLIDE: BOTTOM LINE + ACTIONS (last slide) ---
        else {
            h+=`<div class="card" style="margin-bottom:16px"><h3 style="font-size:11px;text-transform:uppercase;letter-spacing:1.5px;margin-bottom:10px">The Bottom Line</h3><p style="font-size:14px;line-height:1.7">${r.summary||''}</p></div>`;
            h+=`<div style="display:flex;gap:10px;margin-bottom:15px"><button class="btn btn-secondary" style="flex:1" id="download-company-pdf">‚Üì Download PDF</button></div><div class="card" style="margin-bottom:15px"><h3 style="font-size:11px;text-transform:uppercase;letter-spacing:1.5px;margin-bottom:10px">Share with Your Team</h3><div style="display:flex;gap:8px"><input type="email" class="form-input" id="team-email-company" placeholder="teammate@company.com" style="flex:1;font-size:12px"><button class="btn btn-primary btn-small" id="send-company-email">Send</button></div><p id="company-email-status" style="font-size:11px;color:var(--success);margin-top:6px;display:none">‚úì Email client opened</p></div><div class="card text-center" style="border-color:var(--accent)"><p style="font-size:14px;font-weight:600;margin-bottom:6px">Want help building your defense?</p><a href="${STRATEGY_CALL_URL}" target="_blank" class="btn btn-primary btn-full">Book a Strategy Call ‚Üí</a></div>`;
        }
        
        // Navigation: dots + prev/next buttons
        h+=`<div style="display:flex;align-items:center;justify-content:space-between;padding:20px 0 30px 0"><button class="btn btn-secondary" id="slide-prev" style="min-width:90px;font-size:13px;${slide===0?'opacity:0.3;pointer-events:none':''}">‚Üê Back</button><div style="display:flex;gap:4px;align-items:center">${navDots}</div><button class="btn btn-primary" id="slide-next" style="min-width:90px;font-size:13px;${slide>=totalSlides-1?'opacity:0.3;pointer-events:none':''}">${slide===0?'See Opportunities ‚Üí':slide===opps.length?'See Risks ‚Üí':slide===opps.length+1?'Summary ‚Üí':'Next ‚Üí'}</button></div>`;
        
        h+=`</div></div>`;
        return h;
    }
    return '';
}

function threatH(){
    var provider=THREAT_PROVIDERS[S.threatProvider];if(!provider)return '';
    if(S.threatStep===0){
        return `<div class="screen-center"><div class="container-sm"><div class="logo">AI PROOF <span>CLUB</span></div><div style="margin-bottom:20px;padding:18px;background:${provider.color}15;border:1px solid ${provider.color}40"><div style="font-size:11px;color:${provider.color};text-transform:uppercase;letter-spacing:2px;font-weight:700;margin-bottom:8px">${provider.name} Threat Assessment</div><p style="font-size:14px;line-height:1.5;margin:0">${provider.tagline}</p></div><div class="card"><h2 class="card-title" style="font-size:18px;margin-bottom:6px">How exposed is your company?</h2><p class="text-secondary text-small" style="margin-bottom:20px">We'll analyze how ${provider.name}'s AI launches threaten your business.</p><form id="threat-form"><div class="form-group"><label class="form-label">Your Company Website</label><input type="text" class="form-input" id="threat-url" required placeholder="yourwebsite.com"></div><div class="form-group"><label class="form-label">What does your company do?</label><input type="text" class="form-input" id="threat-desc" placeholder="e.g. Digital marketing agency" maxlength="150"></div><div class="form-group"><label class="form-label">Your Email</label><input type="email" class="form-input" id="threat-email" required placeholder="you@company.com"></div><div class="form-group"><label class="form-label">Industry</label><select class="form-input" id="threat-industry" required><option value="">Select</option>${INDUSTRIES.map(i=>`<option value="${i}">${i}</option>`).join('')}</select></div><button type="submit" class="btn btn-primary btn-full">Run ${provider.name} Threat Assessment \u2192</button></form></div></div></div>`;
    }
    if(S.threatStep===1){
        var steps=['Scanning your business...','Analyzing '+provider.name+'...','Calculating threat timeline...','Finding opportunities...','Building report...'];
        var allDone=S.threatLoadingStep>=steps.length;
        return `<div class="screen-center"><div class="container-sm"><div class="logo">AI PROOF <span>CLUB</span></div><div class="card text-center" style="padding:40px"><div style="font-size:28px;margin-bottom:15px">${allDone?'üß†':'‚ö°'}</div><h2 class="card-title">${provider.name} vs ${S.threatUrl.replace(/https?:\/\//,'').replace(/\/$/,'')}</h2><div style="margin-top:20px">${steps.map((st,i)=>`<div style="display:flex;align-items:center;gap:10px;padding:8px 0;opacity:${i<=S.threatLoadingStep?1:0.3}"><span style="color:${i<S.threatLoadingStep?'var(--success)':i===S.threatLoadingStep?'var(--accent)':'var(--text-muted)'};font-size:14px">${i<S.threatLoadingStep?'‚úì':i===S.threatLoadingStep?'‚óâ':'‚óã'}</span><span class="text-small">${st}</span></div>`).join('')}</div>${allDone?`<div style="margin-top:24px;padding-top:20px;border-top:1px solid var(--bg-tertiary)"><div style="display:flex;align-items:center;justify-content:center;gap:12px"><div style="width:20px;height:20px;border:2px solid var(--accent);border-top-color:transparent;border-radius:50%;animation:spin 0.8s linear infinite"></div><span style="font-size:13px;color:var(--text-secondary)">AI is assessing threats to your company...</span></div><div style="margin-top:16px;font-size:11px;color:var(--text-muted);line-height:1.6">Analyzing ${provider.name}'s products against your business model.<br>This usually takes 15-30 seconds.</div></div>`:''}</div></div></div>`;
    }
    if(S.threatStep===2&&S.threatResult){
        var r=S.threatResult,domain=S.threatUrl.replace(/https?:\/\//,'').replace(/www\./,'').replace(/\/$/,'');
        var allOpps=r.opportunities||[],allRisks=r.threats||[];
        var opps=allOpps;
        var risks=allRisks;
        var provider=THREAT_PROVIDERS[S.threatProvider];
        var totalSlides=opps.length+3; // 0=status, 1..N=opps, N+1=risks, N+2=actions
        var slide=Math.max(0,Math.min(S.threatSlide||0,totalSlides-1));
        
        var tl=r.threat_level||'High Exposure';
        var statusIcon=tl.includes('Critical')||tl.includes('High')?'üî¥':tl.includes('Positioned')||tl.includes('Low')?'üü¢':'üü°';
        var statusColor=tl.includes('Critical')||tl.includes('High')?'var(--danger)':tl.includes('Positioned')||tl.includes('Low')?'var(--success)':'var(--warning)';
        var statusBg=tl.includes('Critical')||tl.includes('High')?'rgba(255,60,60,0.12)':tl.includes('Positioned')||tl.includes('Low')?'rgba(0,200,100,0.12)':'rgba(255,170,0,0.12)';
        var statusBorder=tl.includes('Critical')||tl.includes('High')?'rgba(255,60,60,0.3)':tl.includes('Positioned')||tl.includes('Low')?'rgba(0,200,100,0.3)':'rgba(255,170,0,0.3)';
        
        var navDots='';for(var di=0;di<totalSlides;di++){navDots+=`<div style="width:${di===slide?'20px':'8px'};height:8px;border-radius:4px;background:${di===slide?'var(--accent)':'rgba(255,255,255,0.2)'};transition:all 0.3s"></div>`;}
        
        var h=`<div class="screen-center" style="align-items:flex-start;padding-top:40px"><div class="container-sm"><div class="logo">AI PROOF <span>CLUB</span></div>${S.threatUnlocked?'<div style="text-align:center;margin-bottom:15px;padding:10px;background:var(--accent);color:#000;font-size:11px;text-transform:uppercase;letter-spacing:2px;font-weight:700">‚úì Full Report Unlocked</div>':''}`;
        
        // --- SLIDE: THREAT STATUS (slide 0) ---
        if(slide===0){
            h+=`<div style="margin-bottom:20px;padding:24px;background:linear-gradient(135deg,${statusBg},rgba(0,0,0,0.02));border:1px solid ${statusBorder};position:relative"><div style="position:absolute;top:0;left:0;width:4px;height:100%;background:${provider.color}"></div><div style="display:flex;align-items:center;gap:8px;margin-bottom:10px"><span style="font-size:18px">${statusIcon}</span><span style="font-size:10px;color:${provider.color};text-transform:uppercase;letter-spacing:2px;font-weight:700">${provider.name} Threat Level</span></div><h2 style="font-size:24px;font-weight:700;margin-bottom:12px">${tl}</h2><p style="font-size:14px;color:var(--text-secondary);line-height:1.7">${r.threat_summary||''}</p></div>`;
            h+=`<div style="margin-bottom:15px;padding:18px;background:#111118;border:1px solid #1a1a2e"><div style="display:flex;align-items:center;gap:8px;margin-bottom:8px"><span>‚è±Ô∏è</span><span style="font-size:11px;color:var(--warning);text-transform:uppercase;letter-spacing:1.5px;font-weight:700">Estimated Timeline</span></div><p style="font-size:20px;font-weight:700;margin-bottom:4px">${r.months_until_threat||provider.defaultMonths} months</p><p style="font-size:12px;color:var(--text-secondary)">${r.timeline_reason||''}</p></div>`;
            h+=`<div style="margin-bottom:15px;padding:18px;background:#111118;border:1px solid #1a1a2e"><div style="font-size:11px;color:${provider.color};text-transform:uppercase;letter-spacing:1.5px;margin-bottom:12px">${provider.name}'s AI Product Launches</div>${provider.products.slice(0,5).map((p,i)=>`<div style="padding:6px 0;${i<4?'border-bottom:1px solid var(--bg-tertiary)':''}"><div style="display:flex;justify-content:space-between"><span style="font-size:12px;font-weight:600">${p.name}</span><span style="font-size:10px;color:var(--text-muted)">${p.date}</span></div><p style="font-size:11px;color:var(--text-secondary);margin-top:2px">${p.desc}</p></div>`).join('')}</div>`;
            h+=`<div style="text-align:center;padding:10px 0"><p style="font-size:12px;color:var(--text-muted)">${opps.length} defensive opportunities ¬∑ ${risks.length} risks identified</p></div>`;
        }
        // --- SLIDES: INDIVIDUAL OPPORTUNITIES (slides 1..N) ---
        else if(slide>=1&&slide<=opps.length){
            var oi=slide-1,o=opps[oi];
            var plan=S.threatPlans?S.threatPlans[oi]:null;
            h+=`<div style="font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:2px;margin-bottom:8px">Opportunity ${oi+1} of ${opps.length}</div>`;
            h+=`<div class="card" style="margin-bottom:16px;border-left:3px solid var(--accent);padding:20px 24px">${o.prediction?`<div style="font-size:10px;color:var(--accent);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:10px">üîÆ ${o.prediction}</div>`:''}<div style="font-size:18px;font-weight:700;margin-bottom:10px">${o.title}</div><p style="font-size:14px;color:var(--text-secondary);line-height:1.7">${o.description}</p>`;
            if(plan&&plan.steps&&plan.steps.length>0){
                h+=`<div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--bg-tertiary)"><div style="font-size:10px;color:var(--success);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:12px">‚úì Action Plan</div>`;
                plan.steps.forEach(function(step,si){h+=`<div style="display:flex;gap:10px;margin-bottom:10px"><span style="color:var(--accent);font-weight:700;font-size:13px;min-width:20px">${si+1}.</span><div><div style="font-size:13px;font-weight:600;margin-bottom:3px">${step.title}</div><p style="font-size:12px;color:var(--text-secondary);line-height:1.5">${step.desc}</p>${step.timeline?`<span style="font-size:10px;color:var(--text-muted)">‚è± ${step.timeline}</span>`:''}</div></div>`;});
                h+=`</div>`;
            } else if(plan&&plan.generating){
                h+=`<div style="margin-top:16px;text-align:center;padding:20px 0"><div style="display:inline-block;width:20px;height:20px;border:2px solid var(--accent);border-top-color:transparent;border-radius:50%;animation:spin 0.8s linear infinite"></div><p style="font-size:12px;color:var(--text-muted);margin-top:8px">Generating action plan...</p></div>`;
            } else {
                h+=`<button class="btn btn-secondary btn-full" style="margin-top:16px" id="gen-threat-plan-${oi}">‚ö° Generate Action Plan</button>`;
            }
            h+=`</div>`;
        }
        // --- SLIDE: RISKS (slide N+1) ---
        else if(slide===opps.length+1){
            h+=`<div style="font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:2px;margin-bottom:8px">Risks from ${provider.name}</div>`;
            h+=`<div class="card" style="margin-bottom:16px;border-left:3px solid var(--warning);padding:20px 24px"><h3 style="font-size:11px;color:var(--warning);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:14px">‚ö†Ô∏è ${risks.length} Risks Identified</h3>`;
            risks.forEach(function(t,ti){h+=`<div style="padding:10px 0;${ti<risks.length-1?'border-bottom:1px solid var(--bg-tertiary)':''}"><div style="display:flex;justify-content:space-between;align-items:center"><span style="font-size:13px;font-weight:600">${t.prediction}</span><span style="font-size:11px;font-weight:700;color:var(--warning);background:rgba(255,170,0,0.12);padding:2px 8px;border-radius:10px">${t.probability}%</span></div><p style="font-size:12px;color:var(--text-secondary);margin-top:4px;line-height:1.5">${t.impact}</p></div>`;});
            h+=`</div>`;
        }
        // --- SLIDE: ACTIONS (last slide) ---
        else {
            h+=`<div style="display:flex;gap:10px;margin-bottom:15px"><button class="btn btn-secondary" style="flex:1" id="download-threat-pdf">‚Üì Download PDF</button></div><div class="card" style="margin-bottom:15px"><h3 style="font-size:11px;text-transform:uppercase;letter-spacing:1.5px;margin-bottom:10px">Share with Your Team</h3><div style="display:flex;gap:8px"><input type="email" class="form-input" id="team-email-threat" placeholder="teammate@company.com" style="flex:1;font-size:12px"><button class="btn btn-primary btn-small" id="send-threat-email">Send</button></div><p id="threat-email-status" style="font-size:11px;color:var(--success);margin-top:6px;display:none">‚úì Email client opened</p></div><div class="card text-center" style="border-color:var(--accent)"><p style="font-size:14px;font-weight:600;margin-bottom:6px">Want help building your defense?</p><a href="${STRATEGY_CALL_URL}" target="_blank" class="btn btn-primary btn-full">Book a Strategy Call ‚Üí</a></div>`;
        }
        
        // Navigation
        h+=`<div style="display:flex;align-items:center;justify-content:space-between;padding:20px 0 30px 0"><button class="btn btn-secondary" id="threat-slide-prev" style="min-width:90px;font-size:13px;${slide===0?'opacity:0.3;pointer-events:none':''}">‚Üê Back</button><div style="display:flex;gap:4px;align-items:center">${navDots}</div><button class="btn btn-primary" id="threat-slide-next" style="min-width:90px;font-size:13px;${slide>=totalSlides-1?'opacity:0.3;pointer-events:none':''}">${slide===0?'See Opportunities ‚Üí':slide===opps.length?'See Risks ‚Üí':slide===opps.length+1?'Summary ‚Üí':'Next ‚Üí'}</button></div>`;
        
        h+=`</div></div>`;
        return h;
    }
    return '';
}

function loginH(){return `<div class="screen-center"><div class="container-sm"><div class="logo">AI PROOF <span>CLUB</span></div><div class="card"><h2 class="card-title">Welcome back</h2><p class="card-subtitle">Continue your training</p><form id="login-form"><div class="form-group"><label class="form-label">Email</label><input type="email" class="form-input" id="email" required></div><div class="form-group"><label class="form-label">Password</label><input type="password" class="form-input" id="pass" required></div><button type="submit" class="btn btn-primary btn-full">Sign In</button></form><p class="text-center mt-10"><a class="text-link text-small" id="forgot-pass">Forgot password?</a></p><p class="text-center text-secondary text-small mt-20">New? <a class="text-link" id="to-signup">Start training</a></p></div><div class="card mt-20 text-center" style="border-color:var(--accent)"><p class="text-small mb-10">Not sure yet?</p><button class="btn btn-secondary btn-full" id="take-free-quiz">Get My AI-Proof Score ‚Üí</button><p class="text-secondary text-small mt-10">4 questions. 60 seconds.</p></div></div></div>`;}

function freeResultsH(){
    const {ideas:i,personality:p,execution:e}=S.freeQuizScores||S.scores;
    const avgScore = Math.round((i+p+e)/3);
    const percentile = getPercentile(avgScore);
    const weak = ['ideas','personality','execution'].reduce((a,b)=>(S.freeQuizScores||S.scores)[a]<(S.freeQuizScores||S.scores)[b]?a:b);
    
    return `<div class="screen-center"><div class="container-md"><div class="logo">AI PROOF <span>CLUB</span></div>
    <div class="card text-center">
        <h2 class="card-title">Your Mode Profile</h2>
        <p class="text-secondary text-small mb-20">Based on your responses</p>
        
        <div class="results-meters">
            <div class="meter"><div class="meter-circle ideas">${i}%</div><div class="meter-label">Ideas</div></div>
            <div class="meter"><div class="meter-circle personality">${p}%</div><div class="meter-label">Personality</div></div>
            <div class="meter"><div class="meter-circle execution">${e}%</div><div class="meter-label">Execution</div></div>
        </div>
        
        <div class="verdict">
            <div class="verdict-title">Your Position</div>
            <div class="verdict-text">You're in the <strong>${percentile}th percentile</strong>. AI Proof Club starts at 85+.</div>
        </div>
        
        <div class="verdict" style="border-color:var(--danger)">
            <div class="verdict-title" style="color:var(--danger)">Your Gap</div>
            <div class="verdict-text"><strong style="text-transform:capitalize">${weak}</strong> is holding you back. This is where focused training pays off.</div>
        </div>
        
        <div style="background:var(--bg-primary);padding:20px;margin-top:25px;border:1px solid var(--accent)">
            <p class="text-small mb-10">Ready to train your weak spots?</p>
            <button class="btn btn-primary btn-full" id="free-to-signup">Start Training ‚Üí</button>
            <p class="text-secondary text-small mt-10">$9.99/mo ¬∑ Cancel anytime</p>
        </div>
    </div>
    <p class="text-center mt-20"><a class="text-link text-small" id="back-login">Already have an account? Sign in</a></p>
    </div></div>`;
}

function forgotH(){return `<div class="screen-center"><div class="container-sm"><div class="logo">AI PROOF <span>CLUB</span></div><div class="card"><h2 class="card-title">Reset Password</h2><p class="card-subtitle">Enter your email to reset</p><form id="forgot-form"><div class="form-group"><label class="form-label">Email</label><input type="email" class="form-input" id="reset-email" required></div><button type="submit" class="btn btn-primary btn-full">Send Reset Link</button></form><p class="text-center text-secondary text-small mt-20"><a class="text-link" id="back-login">Back to sign in</a></p></div></div></div>`;}

function resetPasswordH(){return `<div class="screen-center"><div class="container-sm"><div class="logo">AI PROOF <span>CLUB</span></div><div class="card"><h2 class="card-title">Set New Password</h2><p class="card-subtitle">Enter your new password below</p><form id="reset-password-form"><div class="form-group"><label class="form-label">New Password</label><input type="password" class="form-input" id="reset-new-pass" required minlength="6" placeholder="Min 6 characters"></div><div class="form-group"><label class="form-label">Confirm Password</label><input type="password" class="form-input" id="reset-confirm-pass" required minlength="6"></div><button type="submit" class="btn btn-primary btn-full">Set New Password</button></form><p class="text-center text-secondary text-small mt-20"><a class="text-link" id="back-login">Back to sign in</a></p></div></div></div>`;}

function signupH(){return `<div class="screen-center"><div class="container-sm"><div class="logo">AI PROOF <span>CLUB</span></div><div class="card"><h2 class="card-title">Start training</h2><p class="card-subtitle">Build skills AI can't replace</p><form id="signup-form"><div class="form-group"><label class="form-label">Name</label><input type="text" class="form-input" id="name" required></div><div class="form-group"><label class="form-label">Email</label><input type="email" class="form-input" id="email" required></div><div class="form-group"><label class="form-label">Password</label><input type="password" class="form-input" id="pass" required minlength="6"></div><button type="submit" class="btn btn-primary btn-full">Create Account</button></form><p class="text-center text-secondary text-small mt-20">Have account? <a class="text-link" id="to-login">Sign in</a></p></div></div></div>`;}

function pricingH(){return `<div class="screen-center"><div class="container-sm"><div class="logo">AI PROOF <span>CLUB</span></div><div class="card text-center"><h2 class="card-title">Choose Your Plan</h2><p class="text-secondary text-small mb-20">Cancel anytime</p><div style="display:flex;flex-direction:column;gap:15px"><div style="border:2px solid var(--accent);padding:20px;background:var(--bg-primary)"><div style="font-size:11px;color:var(--accent);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px">Most Popular</div><div style="font-size:36px;font-weight:700">$9.99<span style="font-size:14px;color:var(--text-secondary)">/month</span></div><a href="${STRIPE_LINK}" class="btn btn-primary btn-full mt-20">Start Monthly ‚Üí</a></div>${STRIPE_ANNUAL?`<div style="border:1px solid var(--bg-tertiary);padding:20px"><div style="font-size:11px;color:var(--success);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px">Best Value ‚Äî 2 Months Free</div><div style="font-size:36px;font-weight:700">$99<span style="font-size:14px;color:var(--text-secondary)">/year</span></div><a href="${STRIPE_ANNUAL}" class="btn btn-secondary btn-full mt-20">Start Annual ‚Üí</a></div>`:''}</div><ul style="list-style:none;text-align:left;margin-top:25px;font-size:12px"><li style="padding:8px 0;border-bottom:1px solid var(--bg-tertiary)">‚úì AI-Proof Score + personalized profile</li><li style="padding:8px 0;border-bottom:1px solid var(--bg-tertiary)">‚úì Progressive weekly quests</li><li style="padding:8px 0;border-bottom:1px solid var(--bg-tertiary)">‚úì 3 AI Coaches (Ideas, Personality, Execution)</li><li style="padding:8px 0;border-bottom:1px solid var(--bg-tertiary)">‚úì Progress capsules + Weekly reviews</li><li style="padding:8px 0">‚úì Cancel anytime</li></ul></div></div></div>`;}

function onboardingH(){
    const step = S.onboardStep;
    const totalSteps = 6; // 1-email/industry, 2-quiz, 3-results+pay, 4-account, 5-goals, 6-interests
    
    // Progress bar
    const progressBar = `<div class="progress-bar" style="margin-bottom:30px">${Array(totalSteps).fill(0).map((_,i)=>`<div class="progress-dot ${i<step?'done':i===step-1?'active':''}"></div>`).join('')}</div>`;
    
    if(step === 1) {
        // Email + Industry (first step - collect email immediately)
        return `<div class="screen-center"><div class="container-sm"><div class="logo">AI PROOF <span>CLUB</span></div>
        ${progressBar}
        <div class="card">
            <h2 class="card-title">Let's get started</h2>
            <p class="card-subtitle">First, tell us a bit about you</p>
            <form id="onboard-email-form">
                <div class="form-group"><label class="form-label">Email</label><input type="email" class="form-input" id="ob-email" value="${S.onboardData.email||S.diagnosticEmail||''}" required></div>
                <div class="form-group">
                    <label class="form-label">Industry</label>
                    <select class="form-input" id="ob-industry" required>
                        <option value="">Select your industry...</option>
                        ${INDUSTRIES.map(i=>`<option value="${i}" ${(S.onboardData.industry||S.diagnosticIndustry)===i?'selected':''}>${i}</option>`).join('')}
                    </select>
                </div>
                <button type="submit" class="btn btn-primary btn-full">Continue to Assessment ‚Üí</button>
            </form>
        </div>
        <p class="text-center text-secondary text-small mt-20">Have account? <a class="text-link" id="to-login">Sign in</a></p>
        </div></div>`;
    }
    
    if(step === 2) {
        // 7-question Quiz intro
        return `<div class="screen-center"><div class="container-md"><div class="logo">AI PROOF <span>CLUB</span></div>
        ${progressBar}
        <div class="card text-center">
            <h2 class="card-title">Mode Assessment</h2>
            <p class="card-subtitle">7 questions to understand your strengths</p>
            
            <div style="background:var(--bg-primary);padding:25px;margin:25px 0;text-align:left">
                <div style="display:flex;gap:20px;margin-bottom:20px">
                    <div style="text-align:center;flex:1">
                        <div style="font-size:28px;margin-bottom:5px;color:var(--ideas)">üí°</div>
                        <div style="font-size:10px;text-transform:uppercase;letter-spacing:1px;color:var(--ideas)">Ideas</div>
                    </div>
                    <div style="text-align:center;flex:1">
                        <div style="font-size:28px;margin-bottom:5px;color:var(--personality)">‚ö°</div>
                        <div style="font-size:10px;text-transform:uppercase;letter-spacing:1px;color:var(--personality)">Personality</div>
                    </div>
                    <div style="text-align:center;flex:1">
                        <div style="font-size:28px;margin-bottom:5px;color:var(--execution)">üéØ</div>
                        <div style="font-size:10px;text-transform:uppercase;letter-spacing:1px;color:var(--execution)">Execution</div>
                    </div>
                </div>
                <p style="font-size:12px;color:var(--text-secondary);text-align:center">We'll measure these three modes that separate the top 1% from everyone else.</p>
            </div>
            
            <button class="btn btn-primary btn-full" id="start-assessment">Start Assessment ‚Üí</button>
            <p class="text-secondary text-small mt-20">Takes about 2 minutes</p>
        </div>
        </div></div>`;
    }
    
    if(step === 3) {
        // Results + Paywall (show results, require payment to continue)
        const {ideas:i,personality:p,execution:e}=S.freeQuizScores||S.scores;
        const avgScore = Math.round((i+p+e)/3);
        const percentile = getPercentile(avgScore);
        const weak = weakest();
        
        return `<div class="screen-center"><div class="container-md"><div class="logo">AI PROOF <span>CLUB</span></div>
        ${progressBar}
        <div class="card">
            <h2 class="card-title text-center">Your Mode Profile</h2>
            
            <div class="results-meters">
                <div class="meter"><div class="meter-circle ideas">${i}%</div><div class="meter-label">Ideas</div></div>
                <div class="meter"><div class="meter-circle personality">${p}%</div><div class="meter-label">Personality</div></div>
                <div class="meter"><div class="meter-circle execution">${e}%</div><div class="meter-label">Execution</div></div>
            </div>
            
            <div class="verdict">
                <div class="verdict-title">Your Position</div>
                <div class="verdict-text">You're in the <strong>${percentile}th percentile</strong>. AI Proof Club operates at 85%+ across all modes. Your <strong style="text-transform:capitalize">${weak}</strong> mode needs the most work.</div>
            </div>
            
            <div style="background:var(--bg-primary);padding:20px;margin-top:20px;border:1px solid var(--accent)">
                <h3 style="font-size:14px;text-align:center;margin-bottom:15px">üöÄ Ready to Level Up?</h3>
                <p class="text-secondary text-small text-center mb-15">Get weekly quests to build your ${weak} mode. Track forecasts. Become irreplaceable.</p>
                <ul style="list-style:none;font-size:11px;margin-bottom:15px">
                    <li style="padding:5px 0">‚úì Weekly quests based on your profile</li>
                    <li style="padding:5px 0">‚úì AI Coaches for each mode</li>
                    <li style="padding:5px 0">‚úì Forecast tracking + opportunities</li>
                    <li style="padding:5px 0">‚úì Progress tracking + receipts</li>
                </ul>
                
                <div style="display:flex;flex-direction:column;gap:12px">
                    <div style="border:2px solid var(--accent);padding:12px;background:var(--bg-secondary)">
                        <div style="display:flex;justify-content:space-between;align-items:center">
                            <div>
                                <div style="font-size:10px;color:var(--accent);text-transform:uppercase;letter-spacing:1px">Monthly</div>
                                <div style="font-size:20px;font-weight:700">$9.99<span style="font-size:11px;color:var(--text-secondary)">/month</span></div>
                            </div>
                            <a href="${STRIPE_LINK}?prefilled_email=${encodeURIComponent(S.onboardData.email||'')}" class="btn btn-primary btn-small" id="go-to-stripe-link">Start Monthly ‚Üí</a>
                        </div>
                    </div>
                    <div style="border:1px solid var(--success);padding:12px">
                        <div style="display:flex;justify-content:space-between;align-items:center">
                            <div>
                                <div style="font-size:10px;color:var(--success);text-transform:uppercase;letter-spacing:1px">Best Value ‚Äî 2 Months Free</div>
                                <div style="font-size:20px;font-weight:700">$99<span style="font-size:11px;color:var(--text-secondary)">/year</span></div>
                            </div>
                            <a href="${STRIPE_ANNUAL}?prefilled_email=${encodeURIComponent(S.onboardData.email||'')}" class="btn btn-secondary btn-small" id="go-to-stripe-annual">Start Annual ‚Üí</a>
                        </div>
                    </div>
                </div>
                <p class="text-center text-secondary text-small mt-10">Cancel anytime</p>
            </div>
        </div>
        </div></div>`;
    }
    
    if(step === 4) {
        // Create account (after payment) - collect name and password
        return `<div class="screen-center"><div class="container-sm"><div class="logo">AI PROOF <span>CLUB</span></div>
        ${progressBar}
        <div class="card">
            <h2 class="card-title">Create Your Account</h2>
            <p class="card-subtitle">Set up your login credentials</p>
            <form id="post-payment-account-form">
                <div class="form-group"><label class="form-label">Name</label><input type="text" class="form-input" id="ob-name" value="${S.user?.name||''}" required></div>
                <div class="form-group"><label class="form-label">Email</label><input type="email" class="form-input" id="ob-email-display" value="${S.onboardData?.email||S.user?.email||''}" disabled style="opacity:0.7"></div>
                <div class="form-group"><label class="form-label">Password</label><input type="password" class="form-input" id="ob-pass" minlength="6" required placeholder="Min 6 characters"></div>
                <button type="submit" class="btn btn-primary btn-full">Continue ‚Üí</button>
            </form>
        </div>
        </div></div>`;
    }
    
    if(step === 5) {
        // Goals (after account creation)
        const selectedGoals = S.onboardData.goals || [];
        return `<div class="screen-center"><div class="container-md"><div class="logo">AI PROOF <span>CLUB</span></div>
        ${progressBar}
        <div class="card">
            <h2 class="card-title">What's driving you here?</h2>
            <p class="card-subtitle">Select all that apply</p>
            <div class="goal-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:20px 0">
                ${GOALS.map(g=>`
                    <div class="choice-card goal-option ${selectedGoals.includes(g.id)?'selected':''}" data-goal="${g.id}" style="padding:15px;cursor:pointer">
                        <div style="font-size:24px;margin-bottom:8px">${g.icon}</div>
                        <div style="font-size:12px">${g.label}</div>
                    </div>
                `).join('')}
            </div>
            <button class="btn btn-primary btn-full" id="goals-continue" ${selectedGoals.length===0?'disabled':''}>Continue ‚Üí</button>
        </div>
        </div></div>`;
    }
    
    if(step === 6) {
        // Interests + suggested forecasts (final step)
        const selectedInterests = S.onboardData.forecastInterests || [];
        const suggestedForecasts = getSuggestedForecasts();
        
        return `<div class="screen-center"><div class="container-md"><div class="logo">AI PROOF <span>CLUB</span></div>
        ${progressBar}
        <div class="card">
            <h2 class="card-title">What topics interest you?</h2>
            <p class="card-subtitle">We'll show you relevant forecasts and opportunities</p>
            <div class="interest-grid" style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin:20px 0">
                ${FORECAST_INTERESTS.map(f=>`
                    <div class="choice-card interest-option ${selectedInterests.includes(f.id)?'selected':''}" data-interest="${f.id}" style="padding:15px;cursor:pointer">
                        <div style="font-size:24px;margin-bottom:8px">${f.icon}</div>
                        <div style="font-size:11px">${f.label}</div>
                    </div>
                `).join('')}
            </div>
            
            ${suggestedForecasts.length ? `
            <div style="margin-top:25px">
                <h3 style="font-size:14px;margin-bottom:15px">üîÆ Suggested Forecasts</h3>
                <div style="display:flex;flex-direction:column;gap:10px">
                    ${suggestedForecasts.slice(0,3).map(f=>`
                        <div class="suggested-forecast" data-fid="${f.id}" style="background:var(--bg-primary);border:1px solid var(--bg-tertiary);padding:15px;cursor:pointer;transition:all 0.3s;${S.onboardSelectedForecasts?.includes(f.id)?'border-color:var(--accent);':''}">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                                <span style="font-size:11px;color:var(--accent);text-transform:uppercase">${f.probability}% likely</span>
                                <span style="font-size:10px;color:var(--text-secondary)">${f.timeframe}</span>
                            </div>
                            <div style="font-size:13px">${f.title}</div>
                        </div>
                    `).join('')}
                </div>
            </div>
            ` : ''}
            
            <button class="btn btn-primary btn-full mt-20" id="finish-onboarding">Start Training ‚Üí</button>
        </div>
        </div></div>`;
    }
    
    return loginH();
}

function uploadH(){return `<div class="screen-center"><div class="container-md"><div class="logo">AI PROOF <span>CLUB</span></div>
<h2 class="card-title text-center mb-10">Upload ChatGPT History</h2>
<p class="text-center text-secondary text-small mb-20">This gives us the most accurate read on your modes. Takes 2-3 minutes to analyze.</p>
<div class="card">
    <div class="verdict mb-20">
        <div class="verdict-title">How to Export</div>
        <div class="verdict-text">
            1. <a href="https://chat.openai.com/#settings/DataControls" target="_blank" class="text-link">Click here to open ChatGPT Settings</a><br>
            2. Click "Export data"<br>
            3. Check your email for the download link<br>
            4. Download and <strong>unzip</strong> the file<br>
            5. Upload the <strong>conversations.json</strong> file from inside
        </div>
    </div>
    <div class="upload-zone" id="upload-zone">
        <div style="font-size:32px;margin-bottom:10px">üìÅ</div>
        <div>Drop <strong>conversations.json</strong> here</div>
        <div class="text-secondary text-small mt-10">Found inside the unzipped folder</div>
        <input type="file" class="file-input" id="file-input" accept=".json">
    </div>
    ${S.uploadedFile?`<div class="uploaded-file"><span>üìÑ</span><span>${S.uploadedFile.name}</span><span class="uploaded-remove" id="rm-file">‚úï</span></div>`:''}
</div>
<div class="text-center mt-20">
    <button class="btn btn-primary" id="analyze-btn" ${!S.uploadedFile?'disabled':''}>Analyze ‚Üí</button>
    <p class="mt-20"><a class="text-link" id="skip-upload">Skip for now ‚Üí</a></p>
    <p class="text-secondary text-small mt-10">You can always do this later in Settings</p>
</div></div></div>`;}

function analyzingH(){return `<div class="screen-center"><div class="container-sm text-center"><div class="logo">AI PROOF <span>CLUB</span></div><div class="card"><div class="spinner"></div><p class="text-secondary mt-20">Analyzing patterns...</p></div></div></div>`;}

function quizH(){
    // Use first 7 questions for onboarding, all 15 for free quiz
    const isFree = S.freeQuizMode || S.screen === 'freeQuiz';
    const quizQuestions = isFree ? Qs : Qs.slice(0, 7);
    const q=quizQuestions[S.quizStep];
    return `<div class="screen-center"><div class="container-md">
        <div class="logo">AI PROOF <span>CLUB</span></div>
        ${isFree ? '<p class="text-center text-secondary text-small mb-20">Free Mode Assessment</p>' : ''}
        <div class="progress-bar">${quizQuestions.map((_,i)=>`<div class="progress-dot ${i<S.quizStep?'done':i===S.quizStep?'active':''}"></div>`).join('')}</div>
        <div class="q-number">Question ${S.quizStep+1} of ${quizQuestions.length}</div>
        <div class="q-text">${q.t}</div>
        <div class="options">${q.o.map((o,i)=>`<button class="option" data-idx="${i}">${o.t}</button>`).join('')}</div>
        ${isFree ? `<p class="text-center mt-20"><a class="text-link text-small" id="quit-quiz">‚Üê Back to login</a></p>` : ''}
    </div></div>`;
}

function resultsH(){
    const {ideas:i,personality:p,execution:e}=S.scores;
    const avgScore = Math.round((i+p+e)/3);
    const percentile = getPercentile(avgScore);
    const weak = weakest();
    
    return `<div class="screen-center"><div class="container-md"><div class="logo">AI PROOF <span>CLUB</span></div>
    <div class="card text-center">
        <h2 class="card-title">Your Mode Profile</h2>
        <p class="text-secondary text-small mb-10">Based on your assessment</p>
        
        <div class="results-meters">
            <div class="meter"><div class="meter-circle ideas">${i}%</div><div class="meter-label">Ideas</div></div>
            <div class="meter"><div class="meter-circle personality">${p}%</div><div class="meter-label">Personality</div></div>
            <div class="meter"><div class="meter-circle execution">${e}%</div><div class="meter-label">Execution</div></div>
        </div>
        
        <div class="verdict">
            <div class="verdict-title">Current Position</div>
            <div class="verdict-text">You're in the <strong>${percentile}th percentile</strong>. AI Proof Club operates at 85%+ across all modes.</div>
        </div>
        
        <div class="verdict" style="border-color:var(--${weak})">
            <div class="verdict-title">Training Focus</div>
            <div class="verdict-text">Your <strong style="text-transform:capitalize">${weak}</strong> mode needs the most attention. We'll prioritize quests here.</div>
        </div>
        
        ${S.gptAnalysis?`<div class="verdict"><div class="verdict-title">ChatGPT Insights</div><div class="verdict-text">${S.gptAnalysis.patterns?.join(' ¬∑ ')||'Analysis complete.'}</div></div>`:''}
        
        <div class="form-group mt-20">
            <label class="form-label">Quest Difficulty</label>
            <div class="tabs">
                <button class="tab ${S.diff==='easy'?'active':''}" data-diff="easy">Easy</button>
                <button class="tab ${S.diff==='standard'?'active':''}" data-diff="standard">Standard</button>
                <button class="tab ${S.diff==='hard'?'active':''}" data-diff="hard">Hard</button>
            </div>
            <p class="text-secondary text-small mt-10">Start easy and level up, or dive into hard mode.</p>
        </div>
        
        <button class="btn btn-primary btn-full mt-20" id="start-app">Begin Training ‚Üí</button>
    </div></div></div>`;
}

function appH(c){return `<div class="app-layout"><aside class="sidebar"><div class="sidebar-logo">AI PROOF <span>CLUB</span></div><div class="sidebar-streak"><div class="streak-value">üî• ${streak()}</div><div class="streak-label">Day Streak</div></div><ul class="sidebar-nav"><li><a href="#" data-screen="dashboard" class="${S.screen==='dashboard'?'active':''}">‚óâ Dashboard</a></li><li><a href="#" data-screen="quests" class="${S.screen==='quests'?'active':''}">‚öî Quests</a></li><li><a href="#" data-screen="coach" class="${S.screen==='coach'?'active':''}">‚óé AI Coach</a></li><li><a href="#" data-screen="forecasts" class="${S.screen==='forecasts'?'active':''}">üîÆ Forecasts</a></li><li><a href="#" data-screen="receipts" class="${S.screen==='receipts'?'active':''}">‚óà Receipts</a></li><li><a href="#" data-screen="capsules" class="${S.screen==='capsules'?'active':''}">üì¶ Capsules</a></li><li><a href="#" data-screen="review" class="${S.screen==='review'?'active':''}">üìä Review</a></li><li><a href="#" data-screen="settings" class="${S.screen==='settings'?'active':''}">‚öô Settings</a></li></ul><div class="sidebar-user"><div class="sidebar-name">${S.user?.name||'User'}</div><div class="sidebar-email">${S.user?.email||''}</div><span class="sidebar-logout" id="logout">Sign out</span></div></aside><main class="main">${c}</main><nav class="mobile-nav"><div class="mobile-nav-item ${S.screen==='dashboard'?'active':''}" data-screen="dashboard"><span>‚óâ</span>Home</div><div class="mobile-nav-item ${S.screen==='quests'?'active':''}" data-screen="quests"><span>‚öî</span>Quests</div><div class="mobile-nav-item ${S.screen==='coach'?'active':''}" data-screen="coach"><span>‚óé</span>Coach</div><div class="mobile-nav-item ${S.screen==='forecasts'?'active':''}" data-screen="forecasts"><span>üîÆ</span>Forecasts</div><div class="mobile-nav-item ${['receipts','capsules','review','settings'].includes(S.screen)?'active':''}" id="more-menu-toggle"><span>‚ò∞</span>More</div></nav><div class="more-menu ${S.showMoreMenu?'show':''}" id="more-menu"><div class="more-menu-item" data-screen="receipts"><span>‚óà</span> Receipts</div><div class="more-menu-item" data-screen="capsules"><span>üì¶</span> Capsules</div><div class="more-menu-item" data-screen="review"><span>üìä</span> Review</div><div class="more-menu-item" data-screen="settings"><span>‚öô</span> Settings</div><div class="more-menu-item" id="mobile-logout"><span>‚Ü©</span> Sign Out</div></div></div>`;}

function dashH(){
    const active=S.quests.filter(q=>!q.done).slice(0,3);
    const recent=S.receipts.slice(-3).reverse();
    const forecastQuests=getFollowedForecastQuests().slice(0,2);
    
    // Calculate days until Monday (next quest refresh)
    const now = new Date();
    const dayOfWeek = now.getDay();
    const daysUntilMonday = dayOfWeek === 0 ? 1 : dayOfWeek === 1 ? 7 : 8 - dayOfWeek;
    const questRefreshText = daysUntilMonday === 1 ? 'New quests tomorrow!' : daysUntilMonday === 7 ? 'New quests in 7 days' : `New quests in ${daysUntilMonday} days`;
    
    return `<div class="page-header"><h1 class="page-title">Dashboard</h1><p class="page-subtitle">Day ${dayNum()}</p></div>
    
    <div class="card mb-20" style="background: linear-gradient(135deg, var(--bg-secondary) 0%, rgba(0,255,170,0.05) 100%); border-color: var(--accent)">
        <div class="card-header"><span class="card-header-title">‚öîÔ∏è Your Quests</span><a href="#" data-screen="quests" class="text-link">All ‚Üí</a></div>
        <p class="text-secondary text-small" style="margin-bottom:12px;padding:0 15px">Complete quests to level up your <strong style="color:var(--${weakest()})">${weakest()}</strong> mode. <span style="color:var(--accent)">${questRefreshText}</span></p>
        ${forecastQuests.length?forecastQuests.map(q=>`<div class="quest" style="border-left:3px solid var(--accent)">
            <div class="quest-header"><span class="quest-mode ${q.mode}">${q.mode}</span><span class="quest-diff" style="color:var(--accent)">üîÆ Forecast</span></div>
            <div class="quest-title">${q.t}</div>
            <div class="quest-meta"><span class="quest-xp">+${q.xp} XP</span></div>
            <div class="quest-actions"><button class="btn btn-small btn-success complete-forecast-q" data-fid="${q.forecastId}" data-oid="${q.oppId}">‚óã Done</button></div>
        </div>`).join(''):''}
        ${active.length?active.map(q=>`<div class="quest ${q.boss?'boss':''}">
            <div class="quest-header"><span class="quest-mode ${q.mode}">${q.mode}</span><span class="quest-diff ${q.diff}">${q.boss?'üëë BOSS':q.diff}</span></div>
            <div class="quest-title">${q.t}</div>
            <div class="quest-meta"><span class="quest-xp">+${q.xp} XP</span></div>
            <div class="quest-actions"><button class="btn btn-small btn-success complete-q" data-id="${q.id}">‚óã Done</button></div>
        </div>`).join(''):''}
        ${!active.length && !forecastQuests.length?'<p class="text-secondary text-small" style="padding:10px 15px">All caught up! üéâ Check back Monday for new quests.</p>':''}
    </div>
    
    <div class="stats"><div class="stat"><div class="stat-value">${totalXP()}</div><div class="stat-label">XP</div></div><div class="stat"><div class="stat-value">${S.receipts.length}</div><div class="stat-label">Receipts</div></div><div class="stat"><div class="stat-value">${streak()}</div><div class="stat-label">Streak</div></div><div class="stat"><div class="stat-value">${dayNum()}</div><div class="stat-label">Day</div></div></div>
    
    <div class="grid-2"><div><div class="card"><div class="card-header"><span class="card-header-title">Mode Levels</span></div><div class="mode-bars"><div class="mode-bar"><span class="mode-name ideas">Ideas</span><div class="mode-track"><div class="mode-fill ideas" style="width:${S.scores.ideas}%"></div></div><span class="mode-value">${S.scores.ideas}%</span></div><div class="mode-bar"><span class="mode-name personality">Personality</span><div class="mode-track"><div class="mode-fill personality" style="width:${S.scores.personality}%"></div></div><span class="mode-value">${S.scores.personality}%</span></div><div class="mode-bar"><span class="mode-name execution">Execution</span><div class="mode-track"><div class="mode-fill execution" style="width:${S.scores.execution}%"></div></div><span class="mode-value">${S.scores.execution}%</span></div></div></div></div><div><div class="card"><div class="card-header"><span class="card-header-title">Recent Receipts</span></div>${recent.length?recent.map(r=>`<div class="receipt"><div class="receipt-check">‚úì</div><div class="receipt-content"><div class="receipt-title">${r.title}</div><div class="receipt-meta">${r.mode} ¬∑ +${r.xp} XP</div></div></div>`).join(''):'<p class="text-secondary text-small">Complete quests to earn receipts.</p>'}</div></div></div>`;
}

function questsH(){
    const active=S.quests.filter(q=>!q.done && !S.hiddenQuests.includes(q.id));
    const custom=S.customQuests.filter(q=>!q.done);
    const forecastQuests=getFollowedForecastQuests();
    const done=[...S.quests.filter(q=>q.done), ...S.customQuests.filter(q=>q.done), ...S.receipts.filter(r=>r.forecastId).map(r=>({t:r.title,xp:r.xp,mode:r.mode,done:true}))];
    const allOpen = [...active, ...custom, ...forecastQuests];
    
    return `<div class="page-header"><h1 class="page-title">IRL Quests</h1><p class="page-subtitle">Focus: ${weakest()} mode</p></div>
    
    <div class="card mb-20">
        <div class="card-header">
            <span class="card-header-title">Open Quests</span>
            <span class="card-badge">${allOpen.length}</span>
        </div>
        
        ${forecastQuests.length ? forecastQuests.map(q=>`<div class="quest forecast-quest">
            <div class="quest-header"><span class="quest-mode ${q.mode}">${q.mode}</span><span class="quest-diff forecast">üîÆ ${q.forecastTitle?.substring(0,30)}...</span></div>
            <div class="quest-title">${q.t}</div>
            <div class="quest-meta"><span class="quest-xp">+${q.xp} XP</span><span class="quest-progress">Step ${q.step}/${q.totalSteps}</span></div>
            <div class="quest-actions">
                <button class="btn btn-small btn-success complete-forecast-q" data-fid="${q.forecastId}" data-oid="${q.oppId}">‚óã Done</button>
            </div>
        </div>`).join('') : ''}
        
        ${custom.length ? custom.map(q=>`<div class="quest custom-quest">
            <div class="quest-header"><span class="quest-mode ${q.mode}">${q.mode}</span><span class="quest-diff">Custom</span></div>
            <div class="quest-title">${q.t}</div>
            <div class="quest-meta"><span class="quest-xp">+${q.xp} XP</span></div>
            <div class="quest-actions">
                <button class="btn btn-small btn-success complete-custom-q" data-id="${q.id}">‚óã Done</button>
                <button class="btn btn-small btn-secondary delete-custom-q" data-id="${q.id}">‚úï</button>
            </div>
        </div>`).join('') : ''}
        
        ${active.length ? active.map(q=>`<div class="quest ${q.boss?'boss':''}">
            <div class="quest-header">
                <span class="quest-mode ${q.mode}">${q.mode}</span>
                ${q.boss?'<span class="quest-diff boss">üëë BOSS</span>':''}
            </div>
            <div class="quest-title">${q.t}</div>
            <div class="quest-meta"><span class="quest-xp">+${q.xp} XP</span></div>
            ${q.tip?`<div class="quest-tip">üí° ${q.tip}</div>`:''}
            <div class="quest-actions">
                <button class="btn btn-small btn-success complete-q" data-id="${q.id}">‚óã Done</button>
                <button class="btn btn-small btn-secondary skip-q" data-id="${q.id}">Skip</button>
            </div>
        </div>`).join('') : ''}
        
        ${allOpen.length === 0 ? '<p class="text-secondary text-small" style="padding:15px">No open quests. Get more below!</p>' : ''}
    </div>
    
    <div class="flex gap-10 mb-20">
        <button class="btn btn-primary" id="get-quests-btn">+ Get More Quests</button>
        <button class="btn btn-secondary" id="add-custom-quest">+ Add Custom</button>
    </div>
    
    ${S.hiddenQuests.length?`<p class="text-secondary text-small mb-20">${S.hiddenQuests.length} hidden quest(s). <a class="text-link" id="unhide-all">Show all</a></p>`:''}
    
    ${done.length?`<div class="card"><div class="card-header"><span class="card-header-title">Completed</span></div>${done.slice(-5).map(q=>`<div class="quest done"><div class="quest-title">${q.t}</div><div class="quest-meta">‚úì +${q.xp} XP</div></div>`).join('')}</div>`:''}`;}

// Get quests from followed forecasts
function getFollowedForecastQuests() {
    const quests = [];
    S.followedForecasts.forEach(fId => {
        const forecast = FORECAST_DATABASE.find(f => f.id === fId);
        if (!forecast) return;
        
        // Get first opportunity with incomplete quests
        forecast.opportunities.forEach((opp, oppIndex) => {
            const progress = S.forecastProgress[fId]?.[oppIndex] || 0;
            if (progress < opp.quests.length) {
                const quest = opp.quests[progress];
                quests.push({
                    ...quest,
                    t: quest.task,
                    forecastId: fId,
                    oppId: oppIndex,
                    forecastTitle: forecast.title,
                    oppTitle: opp.title,
                    step: progress + 1,
                    totalSteps: opp.quests.length,
                    id: `${fId}-${oppIndex}-${progress}`
                });
            }
        });
    });
    return quests.slice(0, 3); // Max 3 forecast quests at a time
}
function coachH(){
    const mode = S.coachMode;
    const modeChats = S.chat.filter(m => m.mode === mode);
    const coachDesc = {
        ideas: "Strategic thinking, decision-making, analysis",
        personality: "Communication, influence, social calibration", 
        execution: "Action-taking, follow-through, shipping"
    };
    const msgs = modeChats.length ? modeChats.map(m=>`<div class="chat-msg ${m.u?'user':'ai'}"><div class="chat-avatar">${m.u?(S.user?.name?.[0]||'U'):'AI'}</div><div class="chat-bubble">${m.t}</div></div>`).join('') : `<div class="chat-msg ai"><div class="chat-avatar">AI</div><div class="chat-bubble">I'm your ${mode} coach. Tell me a situation and I'll give you tactical advice on ${coachDesc[mode].toLowerCase()}.</div></div>`;
    return `<div class="page-header"><h1 class="page-title">AI Coaches</h1><p class="page-subtitle">Tactical advice for each mode</p></div><div class="tabs mb-20"><button class="tab ${mode==='ideas'?'active':''}" data-coach="ideas">üí° Ideas</button><button class="tab ${mode==='personality'?'active':''}" data-coach="personality">üé≠ Personality</button><button class="tab ${mode==='execution'?'active':''}" data-coach="execution">‚ö° Execution</button></div><div class="card mb-10" style="padding:12px"><span class="text-small text-secondary">${coachDesc[mode]}</span></div><div class="chat-container"><div class="chat-messages" id="chat-msgs">${msgs}${S.loading?'<div class="chat-msg ai"><div class="chat-avatar">AI</div><div class="chat-bubble"><div class="spinner"></div></div></div>':''}</div><div class="chat-input-row"><textarea class="chat-input" id="chat-input" placeholder="Describe a situation..." rows="2"></textarea><button class="chat-send" id="send-msg">Send</button></div></div>`;
}

function receiptsH(){const by={ideas:S.receipts.filter(r=>r.mode==='ideas'),personality:S.receipts.filter(r=>r.mode==='personality'),execution:S.receipts.filter(r=>r.mode==='execution')};return `<div class="page-header"><h1 class="page-title">Receipts</h1><p class="page-subtitle">Proof of action</p></div><div class="stats" style="grid-template-columns:repeat(3,1fr)"><div class="stat"><div class="stat-value" style="color:var(--ideas)">${by.ideas.length}</div><div class="stat-label">Ideas</div></div><div class="stat"><div class="stat-value" style="color:var(--personality)">${by.personality.length}</div><div class="stat-label">Personality</div></div><div class="stat"><div class="stat-value" style="color:var(--execution)">${by.execution.length}</div><div class="stat-label">Execution</div></div></div><div class="card"><div class="card-header"><span class="card-header-title">All Receipts</span><span class="card-badge">${totalXP()} XP</span></div>${S.receipts.length?[...S.receipts].reverse().map(r=>`<div class="receipt"><div class="receipt-check">‚úì</div><div class="receipt-content"><div class="receipt-title">${r.title}</div><div class="receipt-meta">${new Date(r.ts).toLocaleDateString()} ¬∑ ${r.mode} ¬∑ +${r.xp} XP</div>${r.reflection?`<div class="receipt-reflection">"${r.reflection}"</div>`:''}</div></div>`).join(''):'<p class="text-secondary" style="padding:15px 0">Receipts appear here as you complete quests.</p>'}</div>`;}

function capsulesH(){const caps=capsules(),base=S.user?.baseline_scores||S.scores;return `<div class="page-header"><h1 class="page-title">Progress Capsules</h1><p class="page-subtitle">Locked snapshots of growth</p></div><div class="capsule-grid">${caps.map(c=>`<div class="capsule ${c.unlocked?'unlocked':'locked'}"><div class="capsule-day">${c.label}</div><div class="capsule-icon">${c.unlocked?'üì¶':'üîí'}</div><div class="capsule-status ${c.unlocked?'unlocked':'locked'}">${c.unlocked?'Unlocked':`${c.day-dayNum()}d left`}</div></div>`).join('')}</div><div class="grid-2"><div class="card"><div class="card-header"><span class="card-header-title">Day 1 Baseline</span></div><div class="mode-bars"><div class="mode-bar"><span class="mode-name ideas">Ideas</span><div class="mode-track"><div class="mode-fill ideas" style="width:${base.ideas}%"></div></div><span class="mode-value">${base.ideas}%</span></div><div class="mode-bar"><span class="mode-name personality">Personality</span><div class="mode-track"><div class="mode-fill personality" style="width:${base.personality}%"></div></div><span class="mode-value">${base.personality}%</span></div><div class="mode-bar"><span class="mode-name execution">Execution</span><div class="mode-track"><div class="mode-fill execution" style="width:${base.execution}%"></div></div><span class="mode-value">${base.execution}%</span></div></div></div><div class="card"><div class="card-header"><span class="card-header-title">Current</span><span class="card-badge">Day ${dayNum()}</span></div><div class="mode-bars"><div class="mode-bar"><span class="mode-name ideas">Ideas</span><div class="mode-track"><div class="mode-fill ideas" style="width:${S.scores.ideas}%"></div></div><span class="mode-value">${S.scores.ideas}%</span></div><div class="mode-bar"><span class="mode-name personality">Personality</span><div class="mode-track"><div class="mode-fill personality" style="width:${S.scores.personality}%"></div></div><span class="mode-value">${S.scores.personality}%</span></div><div class="mode-bar"><span class="mode-name execution">Execution</span><div class="mode-track"><div class="mode-fill execution" style="width:${S.scores.execution}%"></div></div><span class="mode-value">${S.scores.execution}%</span></div></div></div></div>`;}

function reviewH(){const week=S.receipts.filter(r=>(Date.now()-new Date(r.ts))<7*86400000);return `<div class="page-header"><h1 class="page-title">Weekly Review</h1><p class="page-subtitle">AI analysis of your progress</p></div><div class="card mb-20"><div class="card-header"><span class="card-header-title">This Week</span></div><div class="stats" style="grid-template-columns:repeat(3,1fr);margin:0"><div class="stat"><div class="stat-value">${week.length}</div><div class="stat-label">Quests</div></div><div class="stat"><div class="stat-value">${week.reduce((s,r)=>s+r.xp,0)}</div><div class="stat-label">XP</div></div><div class="stat"><div class="stat-value">${streak()}</div><div class="stat-label">Streak</div></div></div></div><div class="card"><div class="card-header"><span class="card-header-title">AI Analysis</span><button class="btn btn-small btn-secondary" id="gen-review">Generate</button></div><div id="review-out">${S.weeklyReview?`<div style="font-size:13px;line-height:1.6">${S.weeklyReview.replace(/\n/g,'<br>')}</div>`:`<p class="text-secondary text-small">${week.length<3?'Complete 3+ quests this week to generate.':'Click Generate for AI review.'}</p>`}</div></div>`;}

function settingsH(){
    const isLightMode = document.documentElement.classList.contains('light-mode');
    return `<div class="page-header"><h1 class="page-title">Settings</h1></div>
<div class="card mb-20"><div class="card-header"><span class="card-header-title">Account</span></div>
<p class="text-small mb-10"><strong>Name:</strong> ${S.user?.name}</p>
<p class="text-small mb-10"><strong>Email:</strong> ${S.user?.email}</p>
<p class="text-small mb-10"><strong>Plan:</strong> Monthly</p>
<p class="text-small"><strong>Day:</strong> ${dayNum()}</p>
</div>

<div class="card mb-20"><div class="card-header"><span class="card-header-title">Appearance</span></div>
<p class="text-secondary text-small mb-15">Choose your preferred theme.</p>
<div class="flex gap-10">
<button class="btn btn-small ${!isLightMode ? 'btn-primary' : 'btn-secondary'}" id="theme-dark">üåô Dark</button>
<button class="btn btn-small ${isLightMode ? 'btn-primary' : 'btn-secondary'}" id="theme-light">‚òÄÔ∏è Light</button>
</div>
</div>

<div class="card mb-20"><div class="card-header"><span class="card-header-title">Re-assess Modes</span></div>
<p class="text-secondary text-small mb-10">Upload new ChatGPT data or retake the quiz to update your mode profile.</p>
<div class="flex gap-10"><button class="btn btn-small btn-secondary" id="re-upload">Upload ChatGPT</button><button class="btn btn-small btn-secondary" id="re-quiz">Retake Quiz</button></div>
</div>

<div class="card mb-20"><div class="card-header"><span class="card-header-title">Support & Feedback</span></div>
<p class="text-secondary text-small mb-15">Questions, ideas, or issues? We'd love to hear from you.</p>
<form id="support-form">
<div class="form-group"><label class="form-label">Subject</label>
<select class="form-input" id="support-subject" required>
<option value="">Select a topic...</option>
<option value="Question">General Question</option>
<option value="Bug Report">Bug Report</option>
<option value="Feature Request">Feature Request / Idea</option>
<option value="Billing">Billing Issue</option>
<option value="Other">Other</option>
</select></div>
<div class="form-group"><label class="form-label">Message</label><textarea class="form-textarea" id="support-message" rows="4" placeholder="Tell us what's on your mind..." required></textarea></div>
<button type="submit" class="btn btn-small btn-primary">Send Message</button>
</form>
</div>

<div class="card mb-20"><div class="card-header"><span class="card-header-title">Subscription</span></div>
<p class="text-secondary text-small mb-15">Manage billing or cancel anytime.</p>
<a href="https://billing.stripe.com/p/login/3cIeVd98He9l4NC1Ym9ws00" target="_blank" class="btn btn-small btn-secondary">Manage Subscription</a>
</div>

<div class="card"><div class="card-header"><span class="card-header-title">Security</span></div>
<p class="text-secondary text-small mb-10"><a class="text-link" id="toggle-password-form">Change password ‚Üí</a></p>
<div id="password-form-container" style="display:none">
<form id="change-password-form">
<div class="form-group"><label class="form-label">Current Password</label><input type="password" class="form-input" id="current-pass" required></div>
<div class="form-group"><label class="form-label">New Password</label><input type="password" class="form-input" id="new-pass" required minlength="6"></div>
<div class="form-group"><label class="form-label">Confirm New Password</label><input type="password" class="form-input" id="confirm-pass" required></div>
<button type="submit" class="btn btn-small btn-primary">Update Password</button>
</form>
</div>
</div>`;}


function modalH(){
    if(S.modal==='forecastDetail') return forecastDetailModalH();
    if(S.modal==='getQuests') return getQuestsModalH();
    if(S.modal==='complete'){
        const q=S.selectedQuest;
        return `<div class="modal-overlay" id="modal-bg"><div class="modal"><h3 class="modal-title">Quest Complete! üéØ</h3><p class="text-secondary text-small mb-20">${q.t}</p><div class="form-group"><label class="form-label">Reflection (optional)</label><textarea class="form-textarea" id="reflection" placeholder="What happened? What did you learn?"></textarea></div><div class="flex gap-10"><button class="btn btn-primary btn-full" id="confirm-done">Log Receipt (+${q.xp} XP)</button><button class="btn btn-secondary" id="cancel-modal">Cancel</button></div></div></div>`;
    }
    if(S.modal==='resetPassword'){
        return `<div class="modal-overlay" id="modal-bg"><div class="modal"><h3 class="modal-title">Set New Password</h3><p class="text-secondary text-small mb-20">Enter your new password below.</p>
        <form id="reset-password-form">
        <div class="form-group"><label class="form-label">New Password</label><input type="password" class="form-input" id="reset-new-pass" required minlength="6"></div>
        <div class="form-group"><label class="form-label">Confirm Password</label><input type="password" class="form-input" id="reset-confirm-pass" required></div>
        <button type="submit" class="btn btn-primary btn-full">Reset Password</button>
        </form></div></div>`;
    }
    if(S.modal==='addQuest'){
        return `<div class="modal-overlay" id="modal-bg"><div class="modal">
        <h3 class="modal-title">Add Custom Quest</h3>
        <p class="text-secondary text-small mb-20">Create a quest tailored to your goals.</p>
        <form id="custom-quest-form">
        <div class="form-group"><label class="form-label">Quest</label><input type="text" class="form-input" id="custom-quest-text" placeholder="What will you do?" required></div>
        <div class="form-group"><label class="form-label">Mode</label>
        <select class="form-input" id="custom-quest-mode" required>
            <option value="ideas">Ideas</option>
            <option value="personality">Personality</option>
            <option value="execution">Execution</option>
        </select></div>
        <div class="form-group"><label class="form-label">XP (10-100)</label><input type="number" class="form-input" id="custom-quest-xp" value="40" min="10" max="100" required></div>
        <div class="flex gap-10"><button type="submit" class="btn btn-primary btn-full">Add Quest</button><button type="button" class="btn btn-secondary" id="cancel-modal">Cancel</button></div>
        </form></div></div>`;
    }
    return '';
}

function getQuestsModalH(){
    const w = weakest();
    // Get suggested opportunities based on weakest mode
    const suggested = FORECAST_DATABASE
        .filter(f => f.threatMode === w || f.opportunities.some(o => o.mode === w))
        .slice(0, 5);
    
    const expandedOpp = S.getQuestsExpandedOpp; // {forecastId, oppIndex}
    
    return `<div class="modal-overlay" id="modal-bg">
        <div class="modal" style="max-width:480px;max-height:85vh;overflow-y:auto">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">
                <h3 class="modal-title" style="margin:0">Get More Quests</h3>
                <button style="background:none;border:none;color:var(--text-secondary);font-size:20px;cursor:pointer" id="close-get-quests">√ó</button>
            </div>
            <p class="text-secondary text-small mb-20">Opportunities matched to your <strong style="color:var(--${w})">${w}</strong> mode:</p>
            
            ${suggested.length > 0 ? suggested.map(f => {
                // Find best opportunity for user's weakest mode
                const bestOpp = f.opportunities.find(o => o.mode === w) || f.opportunities[0];
                const oppIndex = f.opportunities.indexOf(bestOpp);
                const isExpanded = expandedOpp?.forecastId === f.id && expandedOpp?.oppIndex === oppIndex;
                const progress = S.forecastProgress[f.id]?.[oppIndex] || 0;
                const isComplete = progress >= bestOpp.quests.length;
                
                return `
                <div class="get-quests-opp" style="background:var(--bg-primary);border:1px solid ${isExpanded ? 'var(--accent)' : 'var(--bg-tertiary)'};margin-bottom:10px;transition:all 0.2s">
                    <div class="get-quests-opp-header" data-fid="${f.id}" data-oid="${oppIndex}" style="padding:15px;cursor:pointer;display:flex;justify-content:space-between;align-items:center">
                        <div style="flex:1">
                            <div style="font-size:13px;font-weight:600;margin-bottom:4px">${bestOpp.title}</div>
                            <div style="font-size:10px;color:var(--text-muted)">
                                <span style="color:var(--${bestOpp.mode});text-transform:uppercase">${bestOpp.mode.substring(0,4)}</span> ¬∑ 
                                ${f.probability}% likely ¬∑ ${bestOpp.quests.length} quests
                                ${isComplete ? ' ¬∑ <span style="color:var(--success)">‚úì Done</span>' : progress > 0 ? ` ¬∑ <span style="color:var(--accent)">${progress}/${bestOpp.quests.length}</span>` : ''}
                            </div>
                        </div>
                        <div style="background:var(--accent);color:var(--bg-primary);padding:6px 12px;font-size:11px;font-weight:bold">${bestOpp.quests.length}</div>
                    </div>
                    
                    ${isExpanded ? `
                    <div style="padding:0 15px 15px 15px;border-top:1px solid var(--bg-tertiary)">
                        <div style="font-size:10px;color:var(--accent);text-transform:uppercase;letter-spacing:1px;margin:12px 0 10px">Quest Path</div>
                        ${bestOpp.quests.map((q, j) => {
                            const done = j < progress;
                            const current = j === progress;
                            return `
                            <div style="display:flex;gap:10px;align-items:flex-start;margin-bottom:8px;${done ? 'opacity:0.5;' : ''}">
                                <span style="width:18px;height:18px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;flex-shrink:0;${done ? 'background:var(--success);color:white' : current ? 'background:var(--accent);color:var(--bg-primary)' : 'background:var(--bg-tertiary);color:var(--text-secondary)'}">${done ? '‚úì' : j + 1}</span>
                                <span style="font-size:11px;line-height:1.4;${done ? 'text-decoration:line-through;' : ''}">${q.task}</span>
                            </div>
                        `}).join('')}
                        ${!isComplete ? `
                        <button class="btn btn-primary btn-full btn-small mt-10 add-opp-quests" data-fid="${f.id}" data-oid="${oppIndex}">${progress > 0 ? 'Continue These Quests ‚Üí' : 'Add These Quests ‚Üí'}</button>
                        ` : `
                        <div style="text-align:center;padding:10px 0;color:var(--success);font-size:12px">‚úì Quest path complete!</div>
                        `}
                    </div>
                    ` : ''}
                </div>
            `}).join('') : '<p class="text-secondary text-small">No matching opportunities found.</p>'}
            
            <button class="btn btn-secondary btn-full btn-small mt-10" id="browse-all-forecasts">Browse All Forecasts ‚Üí</button>
        </div>
    </div>`;
}

function bindEvents(){
    // Auth forms
    document.getElementById('login-form')?.addEventListener('submit',e=>{e.preventDefault();login();});
    document.getElementById('signup-form')?.addEventListener('submit',e=>{e.preventDefault();signup();});
    document.getElementById('forgot-form')?.addEventListener('submit',e=>{e.preventDefault();resetPassword();});
    document.getElementById('reset-password-form')?.addEventListener('submit',e=>{e.preventDefault();completePasswordReset();});
    
    // Navigation
    document.getElementById('to-signup')?.addEventListener('click',()=>{S.onboardStep=1;S.screen='onboarding';render();});
    document.getElementById('to-login')?.addEventListener('click',()=>{S.screen='login';S.freeQuizMode=false;render();});
    document.getElementById('forgot-pass')?.addEventListener('click',()=>{S.screen='forgot';render();});
    document.getElementById('back-login')?.addEventListener('click',()=>{S.screen='login';S.freeQuizMode=false;render();});
    
    // Free diagnostic flow (4 questions with email gate)
    document.getElementById('take-free-quiz')?.addEventListener('click',()=>{
        S.diagnosticStep=0;
        S.diagnosticEmail='';
        S.diagnosticIndustry='';
        S.diagnosticAnswers=[];
        S.screen='diagnostic';
        render();
    });
    document.getElementById('diagnostic-start-form')?.addEventListener('submit',async e=>{
        e.preventDefault();
        S.diagnosticEmail = document.getElementById('diag-email').value;
        S.diagnosticIndustry = document.getElementById('diag-industry').value;
        
        // Create Auth user with random password (they'll set real password if they convert)
        const tempPassword = 'temp_' + Math.random().toString(36).slice(2) + Date.now().toString(36);
        const authResult = await authSignUp(S.diagnosticEmail, tempPassword, {user_type:'lead',source:'diagnostic_quiz',industry:S.diagnosticIndustry});
        
        if (authResult.error && authResult.error.message !== 'User already registered') {
            console.error('Lead capture error:', authResult.error);
            // Still let them continue the quiz even if auth fails
        }
        
        // Also save industry info to users table (Auth doesn't store custom fields)
        await db('users', 'POST', {
            email: S.diagnosticEmail,
            industry: S.diagnosticIndustry,
            source: 'diagnostic_quiz',
            start_date: new Date().toISOString(),
            user_type: 'lead'
        });
        
        S.diagnosticStep = 1;
        render();
    });
    document.querySelectorAll('.diag-option').forEach(o=>o.addEventListener('click',()=>{
        const idx = parseInt(o.dataset.idx);
        S.diagnosticAnswers.push(idx);
        S.diagnosticStep++;
        render();
    }));
    document.getElementById('back-to-login')?.addEventListener('click',()=>{
        S.screen='login';
        render();
    });
    document.getElementById('quit-quiz')?.addEventListener('click',()=>{
        S.freeQuizMode=false;
        S.screen='login';
        render();
    });
    document.getElementById('free-to-signup')?.addEventListener('click',()=>{
        S.onboardStep=1;
        S.screen='onboarding';
        render();
    });
    

    // === COMPANY FORM ===
    document.getElementById('company-form')?.addEventListener('submit', async e=>{
        e.preventDefault();
        S.companyUrl=document.getElementById('company-url').value;
        S.companyEmail=document.getElementById('company-email').value;
        S.companyIndustry=document.getElementById('company-industry').value;
        S.companyDesc=(document.getElementById('company-desc')?.value||'').trim();
        var domain=S.companyUrl.replace(/https?:\/\//,'').replace(/www\./,'').replace(/\/$/,'');
        // Create Auth user (same pattern as diagnostic)
        var tempPw='temp_'+Math.random().toString(36).slice(2)+Date.now().toString(36);
        var authRes=await authSignUp(S.companyEmail,tempPw,{user_type:'lead',role:S.companyUrl,website:S.companyUrl,source:'company_risk',industry:S.companyIndustry,company_desc:S.companyDesc||''});
        if(authRes.error&&authRes.error.message!=='User already registered'){console.error('Auth:',authRes.error);}
        // Save custom fields to public.users
        await db('users','POST',{email:S.companyEmail,password:'auth_managed',industry:S.companyIndustry,role:S.companyUrl,source:'company_risk',start_date:new Date().toISOString(),user_type:'lead',name:S.companyDesc||''});
        S.companyStep=1;S.companyLoadingStep=0;S.reportSlide=0;S.plans={};render();
        setTimeout(()=>{S.companyLoadingStep=1;render();},800);setTimeout(()=>{S.companyLoadingStep=2;render();},2000);setTimeout(()=>{S.companyLoadingStep=3;render();},3500);setTimeout(()=>{S.companyLoadingStep=4;render();},5000);setTimeout(()=>{S.companyLoadingStep=5;render();},7000);
        var ctx=S.companyDesc?domain+': '+S.companyDesc+'. '+S.companyIndustry+'.':domain+' ('+S.companyIndustry+').';
        
        // STEP 1: Fetch forecasts + opportunities from Supabase
        var forecasts=await db('forecasts','GET',null,'?active=eq.true&select=id,title,category,probability,timeframe,threat_reason');
        var forecastOpps=await db('forecast_opportunities','GET',null,'?active=eq.true&select=id,forecast_id,title,description');
        var forecastRisks=await db('forecast_risks','GET',null,'?active=eq.true&select=title,description,default_probability');
        
        if(!forecasts||!forecastOpps){forecasts=[];forecastOpps=[];}
        if(!forecastRisks)forecastRisks=[];
        console.log('Supabase: forecasts='+((forecasts&&forecasts.length)||0)+', opps='+((forecastOpps&&forecastOpps.length)||0)+', risks='+((forecastRisks&&forecastRisks.length)||0));
        
        // Build a compact list of forecast + opportunity pairs for the AI
        var oppList=[];
        forecastOpps.forEach(function(fo){
            var f=forecasts.find(function(fc){return fc.id===fo.forecast_id;});
            if(f)oppList.push({id:fo.id,prediction:f.title,title:fo.title,desc:fo.description});
        });
        // Fisher-Yates shuffle for true randomization
        for(var si=oppList.length-1;si>0;si--){var sj=Math.floor(Math.random()*(si+1));var tmp=oppList[si];oppList[si]=oppList[sj];oppList[sj]=tmp;}
        var sample=oppList.slice(0,50);
        console.log('Sampled '+sample.length+' opportunities from '+oppList.length+' total');
        console.log('First 3 samples:', sample.slice(0,3).map(s=>s.prediction+': '+s.title));
        
        // STEP 2: AI Call 1 - Generate 15 opportunities customized for this company
        var oppListText=sample.map(function(o,i){return (i+1)+'. ['+o.prediction+'] '+o.title+': '+o.desc;}).join('\n');
        
        var generatePrompt='You are a visionary AI strategist.\n\nCompany: '+ctx+'\n\nBelow are '+sample.length+' opportunity templates based on major predictions. Your job: pick the 15 MOST RELEVANT to '+domain+' and REWRITE each one specifically for this company.\n\nCRITICAL RULES:\n- Pick from ACROSS the entire list ‚Äî do NOT just take the first 15\n- Every opportunity MUST use what '+domain+' actually does as the vehicle\n- If '+domain+' makes memes, the opportunity is about MEMES. If it sells insurance, about INSURANCE\n- Rewrite the description in 2 vivid, actionable sentences specific to '+domain+'\n- Think BIG: self-driving cars = new lifestyle spaces (gaming, shopping, therapy). Neural interfaces = thought-controlled products. Loneliness = community IS the product\n- NEVER suggest generic consulting/advising unrelated to the company product\n- For the "p" field, include the FULL prediction name (e.g. "Self-driving cars become lifestyle spaces"), NOT a number\n- ORDER BY RELEVANCE: Put the most relevant to '+domain+' FIRST\n\nOpportunity templates:\n'+oppListText+'\n\nReturn ONLY valid JSON:\n{"d":"1 sentence what '+domain+' does","o":[{"id":template_number,"p":"full prediction name text","t":"rewritten title for '+domain+'","s":"2 vivid sentences specific to '+domain+'"}],"m":"2 sentence summary"}\n\n15 in o. Best fits first.';
        
        var allOppsResult=[],companyDesc='',summary='';
        for(var attempt=0;attempt<3;attempt++){
            try{
                var r1=await ai([{role:'user',content:generatePrompt}],3000,'general');
                if(r1){var c=r1.replace(/```json|```/g,'').trim(),parsed=null;try{parsed=JSON.parse(c);}catch(e1){for(var f of ['}]}]}',']}]}','}]}}','}]}']){try{parsed=JSON.parse(c+f);break;}catch(e2){}}}
                if(parsed&&parsed.o&&parsed.o.length>=5){allOppsResult=parsed.o.map(function(x){return{prediction:x.p||'',title:x.t||'',description:x.s||''};});companyDesc=parsed.d||'';summary=parsed.m||'';break;}}
            }catch(e){console.error('Generate attempt '+(attempt+1)+':',e);}
        }
        
        // STEP 3: Gemini ranks opportunities by relevance to this company
        if(allOppsResult.length>=5){
            // Build a company profile for better ranking
            var rankPrompt='You are an expert business strategist ranking AI opportunities for a specific company.\n\nCOMPANY: '+domain+'\nDESCRIPTION: '+(companyDesc||ctx)+'\nINDUSTRY: '+S.companyIndustry+'\n\nHere are '+allOppsResult.length+' opportunities generated for this company. Your job is to REORDER them so the MOST impactful and actionable ones come first.\n\nRANKING CRITERIA (in order of importance):\n1. IMMEDIATE ACTIONABILITY: Could they start this within 2 weeks with existing resources?\n2. CORE BUSINESS FIT: Does this leverage what they already do, not require them to become a different company?\n3. REVENUE POTENTIAL: Would this create new revenue or protect existing revenue?\n4. COMPETITIVE MOAT: Would this be hard for competitors to copy?\n5. PREDICTION RELEVANCE: How likely is this prediction to directly affect their industry?\n\nCRITICAL: Do NOT return the original order. Actually think about what '+domain+' does.\n\nFor example:\n- A MEME SITE should rank community/content/humor opportunities first, NOT self-driving cars\n- A SaaS tool like NOTION should rank AI features/productivity first, NOT physical goods\n- A LUXURY BRAND like LVMH should rank brand/experience opportunities first, NOT code tools\n\nOpportunities:\n'+allOppsResult.map(function(o,i){return(i+1)+'. ['+o.prediction+'] '+o.title+': '+o.description;}).join('\n')+'\n\nReturn a JSON object with "ranked" containing the numbers reordered from best to worst fit for '+domain+'.\nAlso include "reasoning" with a 1-sentence explanation of why #1 is the top pick.\n\n{"ranked":[numbers best-to-worst],"reasoning":"..."}\n\nJSON only. No other text.';
            
            for(var attempt=0;attempt<2;attempt++){
                try{
                    var r2=await aiRank(rankPrompt,800);
                    console.log('AI ranking raw:',r2);
                    if(r2){var c=r2.replace(/```json|```/g,'').trim(),parsed=null;try{parsed=JSON.parse(c);}catch(e1){for(var f of ['}]}','}}',']}}',']','}']){try{parsed=JSON.parse(c+f);break;}catch(e2){}}}
                    if(parsed&&parsed.ranked&&parsed.ranked.length>=5){
                        console.log('AI rank order:',parsed.ranked,'Reason:',parsed.reasoning||'');
                        var ranked=[];
                        parsed.ranked.forEach(function(idx){
                            var i=typeof idx==='number'?idx-1:parseInt(idx)-1;
                            if(i>=0&&i<allOppsResult.length&&allOppsResult[i])ranked.push(allOppsResult[i]);
                        });
                        // Add any that Gemini missed
                        allOppsResult.forEach(function(o){if(ranked.indexOf(o)===-1)ranked.push(o);});
                        if(ranked.length>=5){allOppsResult=ranked;console.log('Reordered: top opp is now "'+ranked[0].title+'" ['+ranked[0].prediction+']');}
                        break;
                    } else {
                        console.warn('AI ranking parse failed, attempt '+(attempt+1));
                    }}
                }catch(e){console.error('AI rank attempt '+(attempt+1)+':',e);}
            }
        } else {
            console.warn('Skipping AI ranking: only '+allOppsResult.length+' opps');
        }
        
        // STEP 4: Build risks from Supabase + always include Big 3
        // Fix: ensure prediction field contains actual prediction text, not a number
        allOppsResult.forEach(function(o){
            if(o.prediction&&!isNaN(o.prediction)){
                var pidx=parseInt(o.prediction)-1;
                if(sample[pidx]&&sample[pidx].prediction)o.prediction=sample[pidx].prediction;
                else o.prediction='';
            }
        });
        var risks=forecastRisks.map(function(r){return{prediction:r.title,probability:r.default_probability,impact:r.description};});
        // Always include OpenAI, Claude, Gemini as competitive risks
        var big3=[
            {prediction:'OpenAI builds competing product',probability:78,impact:'OpenAI\'s expanding product suite (ChatGPT, GPTs, API) could directly replicate or replace what '+domain+' offers, with massive distribution advantage.'},
            {prediction:'Anthropic\'s Claude enters your space',probability:72,impact:'Claude\'s rapid capability gains and enterprise focus mean Anthropic could build features that overlap with '+domain+'\'s core value proposition.'},
            {prediction:'Google Gemini commoditizes your niche',probability:75,impact:'Google can bundle Gemini into Search, Workspace, and Android ‚Äî giving away for free what '+domain+' charges for, overnight.'}
        ];
        big3.forEach(function(b3){
            if(!risks.find(function(r){return r.prediction.toLowerCase().includes('openai')&&b3.prediction.includes('OpenAI')||r.prediction.toLowerCase().includes('claude')&&b3.prediction.includes('Claude')||r.prediction.toLowerCase().includes('gemini')&&b3.prediction.includes('Gemini');})){
                risks.push(b3);
            }
        });
        risks=risks.slice(0,10); // cap at 10
        
        // STEP 5: AI-Proof Status ‚Äî OpenAI generates, Gemini validates
        var aiStatus={level:'Moderately Positioned',summary:'Your company has opportunities ahead but needs to act on key AI shifts.'};
        try {
            var statusPrompt='You are an AI industry analyst. Evaluate how AI-proof this company is.\n\nCompany: '+ctx+' ('+companyDesc+')\nIndustry: '+S.companyIndustry+'\n\nTop opportunities found:\n'+allOppsResult.slice(0,5).map(function(o,i){return(i+1)+'. '+o.title;}).join('\n')+'\n\nRisks:\n'+risks.slice(0,5).map(function(r,i){return(i+1)+'. '+r.prediction;}).join('\n')+'\n\nRate this company\'s AI-proof status. Consider:\n- How easily AI could replicate their core offering\n- Whether their industry is being rapidly transformed by AI\n- How much of their value depends on things AI is good at (content, analysis, code, support)\n- Whether they have defensible moats (brand, network effects, physical assets, regulation)\n\nReturn ONLY JSON:\n{"level":"High Risk" or "Moderately Positioned" or "Well Positioned","strengths":"what the company is good at that protects it (1-2 sentences)","gaps":"what key shifts they are missing (1-2 sentences)","summary":"You\'re ahead of [X%] of companies in [industry] because [strength]. Your core advantage is [specific thing]. But [specific gap/risk]. The window to act is [timeframe]."}\n\nBe specific to '+domain+'. Reference what they actually do. The summary should read like a personalized briefing, not generic advice.';
            var statusR=await ai([{role:'user',content:statusPrompt}],1000,'general');
            if(statusR){var sc=statusR.replace(/```json|```/g,'').trim();try{var sp=JSON.parse(sc);if(sp.level&&sp.summary){aiStatus=sp;}}catch(e){console.error('Status parse:',e);}}
            
            // Gemini validates/adjusts the level
            var validatePrompt='A company analysis AI rated '+domain+' ('+companyDesc+', '+S.companyIndustry+') as "'+aiStatus.level+'" for AI-proof status.\n\nTheir reasoning: '+aiStatus.summary+'\n\nDo you agree with this rating? Consider:\n- "High Risk" = AI can easily replicate their core value, no strong moat, industry being disrupted fast\n- "Moderately Positioned" = Some AI threats but has some defensible advantages, needs to adapt\n- "Well Positioned" = Strong moats (brand, physical, regulatory, network effects), AI is more opportunity than threat\n\nExamples: LVMH = Well Positioned (luxury brand moat, physical goods). Notion = High Risk (AI can build note/doc tools easily). A meme website = Moderately Positioned (creative/community moat but AI generates content).\n\nReturn ONLY JSON:\n{"agree":true/false,"adjusted_level":"High Risk" or "Moderately Positioned" or "Well Positioned","reason":"1 sentence why you agree or disagree"}\n\nOnly JSON.';
            var valR=await aiRank(validatePrompt,300);
            if(valR){var vc=valR.replace(/```json|```/g,'').trim();try{var vp=JSON.parse(vc);if(vp&&!vp.agree&&vp.adjusted_level){aiStatus.level=vp.adjusted_level;aiStatus.summary=aiStatus.summary+' ('+vp.reason+')';}}catch(e){console.error('Validate parse:',e);}}
        } catch(e){console.error('Status generation:',e);}
        
        S.companyResult={company_description:companyDesc||S.companyDesc||domain,opportunities:allOppsResult.slice(0,15),threats:risks,summary:summary||domain+' has real opportunities to leverage these shifts, but needs to move fast on the ones that match its strengths.',ai_status:aiStatus};
        // Save result to DB
        await db('leads','PATCH',{company_result:JSON.stringify(S.companyResult)},`?email=eq.${encodeURIComponent(S.companyEmail)}&source=eq.company_risk`);
        S.companyStep=2;render();
    });
    document.getElementById('unlock-company-report')?.addEventListener('click',()=>{
        localStorage.setItem('apc_report',JSON.stringify({type:'company',url:S.companyUrl,email:S.companyEmail,industry:S.companyIndustry,desc:S.companyDesc,result:S.companyResult}));
        var email=encodeURIComponent(S.companyEmail||'');
        window.location.href=COMPANY_REPORT_STRIPE+'?prefilled_email='+email+'&success_url='+encodeURIComponent(location.origin+'/app.html?report_success=true');
    });
    // === THREAT FORM ===
    document.getElementById('threat-form')?.addEventListener('submit', async e=>{
        e.preventDefault();
        S.threatUrl=document.getElementById('threat-url').value;S.threatEmail=document.getElementById('threat-email').value;
        S.threatIndustry=document.getElementById('threat-industry').value;S.threatDesc=(document.getElementById('threat-desc')?.value||'').trim();
        var provider=THREAT_PROVIDERS[S.threatProvider],domain=S.threatUrl.replace(/https?:\/\//,'').replace(/www\./,'').replace(/\/$/,'');
        // Create Auth user (same pattern as diagnostic)
        var tempPw='temp_'+Math.random().toString(36).slice(2)+Date.now().toString(36);
        var authRes=await authSignUp(S.threatEmail,tempPw,{user_type:'lead',role:S.threatUrl,website:S.threatUrl,source:'threat_'+S.threatProvider,industry:S.threatIndustry,company_desc:S.threatDesc||''});
        if(authRes.error&&authRes.error.message!=='User already registered'){console.error('Auth:',authRes.error);}
        // Save custom fields to public.users
        await db('users','POST',{email:S.threatEmail,password:'auth_managed',industry:S.threatIndustry,role:S.threatUrl,source:'threat_'+S.threatProvider,start_date:new Date().toISOString(),user_type:'lead',name:S.threatDesc||''});
        S.threatStep=1;S.threatLoadingStep=0;S.threatSlide=0;S.threatPlans={};render();
        setTimeout(()=>{S.threatLoadingStep=1;render();},800);setTimeout(()=>{S.threatLoadingStep=2;render();},2000);setTimeout(()=>{S.threatLoadingStep=3;render();},3500);setTimeout(()=>{S.threatLoadingStep=4;render();},5000);setTimeout(()=>{S.threatLoadingStep=5;render();},7000);
        var ctx=S.threatDesc?domain+': '+S.threatDesc+'. '+S.threatIndustry+'.':domain+' ('+S.threatIndustry+').';
        var plist=provider.products.map(p=>'- '+p.name+': '+p.desc).join('\n');
        
        // STEP 1: Fetch forecasts + opportunities from Supabase
        var forecasts=await db('forecasts','GET',null,'?active=eq.true&select=id,title,category,probability,timeframe,threat_reason');
        var forecastOpps=await db('forecast_opportunities','GET',null,'?active=eq.true&select=id,forecast_id,title,description');
        var forecastRisks=await db('forecast_risks','GET',null,'?active=eq.true&select=title,description,default_probability');
        
        if(!forecasts||!forecastOpps){forecasts=[];forecastOpps=[];}
        if(!forecastRisks)forecastRisks=[];
        
        var oppList=[];
        forecastOpps.forEach(function(fo){
            var f=forecasts.find(function(fc){return fc.id===fo.forecast_id;});
            if(f)oppList.push({id:fo.id,prediction:f.title,title:fo.title,desc:fo.description});
        });
        // Fisher-Yates shuffle
        for(var si=oppList.length-1;si>0;si--){var sj=Math.floor(Math.random()*(si+1));var tmp=oppList[si];oppList[si]=oppList[sj];oppList[sj]=tmp;}
        var sample=oppList.slice(0,50);
        
        // STEP 2: AI Call 1 - Generate 15 opportunities + threat assessment
        var oppListText=sample.map(function(o,i){return (i+1)+'. ['+o.prediction+'] '+o.title+': '+o.desc;}).join('\n');
        
        var generatePrompt='You are a visionary AI strategist.\n\nCompany: '+ctx+'\n'+provider.name+' has launched: '+plist+'\n\nBelow are '+sample.length+' opportunity templates based on major predictions. Pick the 15 MOST RELEVANT to '+domain+' and REWRITE each one specifically for this company.\n\nCRITICAL RULES:\n- Every opportunity MUST use what '+domain+' actually does as the vehicle\n- Rewrite descriptions in 2 vivid, actionable sentences specific to '+domain+'\n- Think BIG about each prediction\n- NEVER suggest generic consulting unrelated to the company product\n\nAlso assess threat from '+provider.name+':\n- THREAT LEVEL: "Critical Exposure" (direct competitor), "High Exposure" (software), "Moderate Exposure" (service), "Positioned but Must Adapt" (physical goods)\n- Timeline in months\n\nOpportunity templates:\n'+oppListText+'\n\nReturn ONLY valid JSON:\n{"d":"1 sentence what '+domain+' does","l":"threat level","ts":"what is threatened vs safe","m":months,"mr":"reason","o":[{"id":number,"p":"prediction","t":"rewritten title","s":"2 vivid sentences"}],"m2":"2 sentence summary"}\n\n15 in o.';
        
        var allOppsResult=[],companyDesc='',summary='',threatLevel='',threatSummary='',monthsUntil=0,timelineReason='';
        for(var attempt=0;attempt<3;attempt++){
            try{
                var r1=await ai([{role:'user',content:generatePrompt}],3000,'general');
                if(r1){var c=r1.replace(/```json|```/g,'').trim(),parsed=null;try{parsed=JSON.parse(c);}catch(e1){for(var f of ['}]}]}',']}]}','}]}}','}]}']){try{parsed=JSON.parse(c+f);break;}catch(e2){}}}
                if(parsed&&parsed.o&&parsed.o.length>=5){allOppsResult=parsed.o.map(function(x){return{prediction:x.p||'',title:x.t||'',description:x.s||''};});companyDesc=parsed.d||'';threatLevel=parsed.l||'';threatSummary=parsed.ts||'';monthsUntil=parsed.m||0;timelineReason=parsed.mr||'';summary=parsed.m2||'';break;}}
            }catch(e){console.error('Threat generate attempt '+(attempt+1)+':',e);}
        }
        
        // STEP 3: Gemini ranks opportunities by relevance
        if(allOppsResult.length>=5){
            var rankPrompt='You are an expert business strategist ranking AI opportunities for a specific company.\n\nCOMPANY: '+domain+'\nDESCRIPTION: '+(companyDesc||ctx)+'\nINDUSTRY: '+S.threatIndustry+'\nTHREAT FROM: '+provider.name+'\n\nReorder these '+allOppsResult.length+' opportunities so the MOST impactful and actionable ones come first.\n\nRANKING CRITERIA:\n1. IMMEDIATE ACTIONABILITY: Could they start this within 2 weeks?\n2. CORE BUSINESS FIT: Does this leverage what they already do?\n3. DEFENSIVE VALUE: Does this protect against '+provider.name+'?\n4. REVENUE POTENTIAL: New revenue or protect existing?\n\nCRITICAL: Do NOT return the original order. A meme site should see community/content first, not self-driving cars. A SaaS tool should see AI features first, not physical goods.\n\nOpportunities:\n'+allOppsResult.map(function(o,i){return(i+1)+'. ['+o.prediction+'] '+o.title+': '+o.description;}).join('\n')+'\n\n{"ranked":[numbers best-to-worst],"reasoning":"why #1 is top"}\n\nJSON only.';
            for(var attempt=0;attempt<2;attempt++){
                try{
                    var r2=await aiRank(rankPrompt,800);
                    console.log('Gemini threat ranking raw:',r2);
                    if(r2){var c=r2.replace(/```json|```/g,'').trim(),parsed=null;try{parsed=JSON.parse(c);}catch(e1){for(var f of ['}]}','}}',']}}',']','}']){try{parsed=JSON.parse(c+f);break;}catch(e2){}}}
                    if(parsed&&parsed.ranked&&parsed.ranked.length>=5){
                        var ranked=[];
                        parsed.ranked.forEach(function(idx){
                            var i=typeof idx==='number'?idx-1:parseInt(idx)-1;
                            if(i>=0&&i<allOppsResult.length&&allOppsResult[i])ranked.push(allOppsResult[i]);
                        });
                        allOppsResult.forEach(function(o){if(ranked.indexOf(o)===-1)ranked.push(o);});
                        if(ranked.length>=5){allOppsResult=ranked;console.log('Threat reordered: top is "'+ranked[0].title+'"');}
                        break;
                    }}
                }catch(e){console.error('Gemini threat rank attempt '+(attempt+1)+':',e);}
            }
        }
        
        // STEP 4: Build risks from Supabase + always include Big 3
        var risks=forecastRisks.map(function(r){return{prediction:r.title,probability:r.default_probability,impact:r.description};});
        var big3=[
            {prediction:'OpenAI builds competing product',probability:78,impact:'OpenAI\'s expanding product suite could directly replicate or replace what '+domain+' offers, with massive distribution advantage.'},
            {prediction:'Anthropic\'s Claude enters your space',probability:72,impact:'Claude\'s rapid capability gains and enterprise focus mean Anthropic could build features that overlap with '+domain+'\'s core value.'},
            {prediction:'Google Gemini commoditizes your niche',probability:75,impact:'Google can bundle Gemini into Search, Workspace, and Android ‚Äî giving away for free what '+domain+' charges for.'}
        ];
        big3.forEach(function(b3){if(!risks.find(function(r){return r.prediction.includes('OpenAI')&&b3.prediction.includes('OpenAI')||r.prediction.includes('Claude')&&b3.prediction.includes('Claude')||r.prediction.includes('Gemini')&&b3.prediction.includes('Gemini');}))risks.push(b3);});
        risks=risks.slice(0,10);
        
        // Fix: ensure prediction field contains actual prediction text, not a number
        allOppsResult.forEach(function(o){
            if(o.prediction&&!isNaN(o.prediction)){
                // It's a number (AI returned template number instead of prediction text)
                var idx=parseInt(o.prediction)-1;
                if(sample[idx]&&sample[idx].prediction)o.prediction=sample[idx].prediction;
                else o.prediction='';
            }
        });
        
        var fallbackLevel='Moderate Exposure';var fallbackMonths=provider.defaultMonths;
        var softwareInd=['Technology','SaaS','Software','AI/ML','Web3/Crypto'];
        var physicalInd=['Manufacturing','Retail','Real Estate','Healthcare','Construction'];
        if(softwareInd.some(s=>S.threatIndustry.includes(s))){fallbackLevel='High Exposure';fallbackMonths=Math.max(8,provider.defaultMonths-6);}
        if(physicalInd.some(s=>S.threatIndustry.includes(s))){fallbackLevel='Positioned but Must Adapt';fallbackMonths=provider.defaultMonths+6;}
        S.threatResult={company_description:companyDesc||S.threatDesc||domain,threat_level:threatLevel||fallbackLevel,threat_summary:threatSummary||provider.name+' is advancing into areas that directly impact '+domain+"'s core operations.",months_until_threat:monthsUntil||fallbackMonths,timeline_reason:timelineReason||'Based on '+provider.name+"'s product velocity and "+S.threatIndustry+' dynamics.',opportunities:allOppsResult.slice(0,15),threats:risks};
        // Save result to DB
        await db('users','PATCH',{company_result:JSON.stringify(S.threatResult)},`?email=eq.${encodeURIComponent(S.threatEmail)}&source=eq.threat_${S.threatProvider}`);
        S.threatStep=2;render();
    });
    document.getElementById('unlock-threat-report')?.addEventListener('click',()=>{
        localStorage.setItem('apc_report',JSON.stringify({type:'threat',provider:S.threatProvider,url:S.threatUrl,email:S.threatEmail,industry:S.threatIndustry,desc:S.threatDesc,result:S.threatResult}));
        var email=encodeURIComponent(S.threatEmail||'');
        window.location.href=COMPANY_REPORT_STRIPE+'?prefilled_email='+email+'&success_url='+encodeURIComponent(location.origin+'/app.html?report_success=true');
    });
    // PDF + Email handlers
    document.getElementById('download-company-pdf')?.addEventListener('click',()=>downloadReportPDF('company'));
    document.getElementById('download-threat-pdf')?.addEventListener('click',()=>downloadReportPDF('threat'));
    document.getElementById('send-company-email')?.addEventListener('click',()=>emailReportToTeam('company'));
    document.getElementById('send-threat-email')?.addEventListener('click',()=>emailReportToTeam('threat'));
    
    // Slide navigation
    document.getElementById('slide-prev')?.addEventListener('click',()=>{if(S.reportSlide>0){S.reportSlide--;render();}});
    document.getElementById('slide-next')?.addEventListener('click',()=>{var totalSlides=(S.companyResult?.opportunities?.length||0)+3;if(S.reportSlide<totalSlides-1){S.reportSlide++;render();}});
    document.getElementById('threat-slide-prev')?.addEventListener('click',()=>{if(S.threatSlide>0){S.threatSlide--;render();}});
    document.getElementById('threat-slide-next')?.addEventListener('click',()=>{var totalSlides=(S.threatResult?.opportunities?.length||0)+3;if(S.threatSlide<totalSlides-1){S.threatSlide++;render();}});
    
    // Generate Plan buttons
    for(var pi=0;pi<(S.companyResult?.opportunities?.length||0);pi++){
        (function(idx){
            document.getElementById('gen-plan-'+idx)?.addEventListener('click',async function(){
                if(S.plans[idx]&&S.plans[idx].generating)return;
                S.plans[idx]={generating:true,steps:[]};render();
                var opp=S.companyResult.opportunities[idx];
                var domain=S.companyUrl.replace(/https?:\/\//,'').replace(/www\./,'').replace(/\/$/,'');
                var ctx=S.companyDesc?domain+': '+S.companyDesc+'. '+S.companyIndustry+'.':domain+' ('+S.companyIndustry+').';
                
                // Step 1: OpenAI generates action plan
                var planPrompt='You are a strategic AI consultant. Create a specific, actionable plan for this opportunity.\n\nCompany: '+ctx+'\nOpportunity: '+opp.title+'\nPrediction: '+(opp.prediction||'')+'\nDescription: '+opp.description+'\n\nCreate a 5-step action plan that is SPECIFIC to '+domain+'. Each step should be concrete, not generic consulting advice.\n\nRules:\n- Step 1 should be something they can do THIS WEEK\n- Steps should build on each other\n- Include specific tools, platforms, or approaches where relevant\n- Reference what '+domain+' actually does as the vehicle\n- Include estimated timeline for each step\n\nReturn ONLY JSON:\n{"steps":[{"title":"short action title","desc":"2-3 specific sentences","timeline":"e.g. Week 1, Month 1-2, etc."}]}\n\n5 steps exactly.';
                var planSteps=[];
                try{
                    var pr=await ai([{role:'user',content:planPrompt}],2000,'general');
                    if(pr){var pc=pr.replace(/```json|```/g,'').trim();try{var pp=JSON.parse(pc);if(pp.steps)planSteps=pp.steps;}catch(e){console.error('Plan parse:',e);}}
                }catch(e){console.error('Plan gen:',e);}
                
                // Step 2: Gemini ranks/validates the plan steps
                if(planSteps.length>=3){
                    try{
                        var valPlanPrompt='Company: '+ctx+'\nOpportunity: '+opp.title+': '+opp.description+'\n\nAn AI generated this action plan. Review it and improve the ordering. Move the highest-impact, most actionable steps first. Remove any step that is generic/vague and replace with something specific to '+domain+'.\n\nCurrent plan:\n'+planSteps.map(function(s,i){return(i+1)+'. '+s.title+': '+s.desc+' ('+s.timeline+')';}).join('\n')+'\n\nReturn ONLY JSON:\n{"steps":[{"title":"...","desc":"...","timeline":"..."}]}\n\n5 steps, best order. Be specific to '+domain+'.';
                        var vr=await aiRank(valPlanPrompt,1500);
                        if(vr){var vc=vr.replace(/```json|```/g,'').trim();try{var vp=JSON.parse(vc);if(vp.steps&&vp.steps.length>=3)planSteps=vp.steps;}catch(e){console.error('Gemini plan validate:',e);}}
                    }catch(e){console.error('Gemini plan:',e);}
                }
                
                // Step 3: Quick OpenAI polish pass
                if(planSteps.length>=3){
                    try{
                        var polishPrompt='Polish this action plan for '+domain+' ('+S.companyIndustry+'). Make it punchier. Each description should be max 2 vivid sentences. Keep timelines realistic.\n\nPlan:\n'+JSON.stringify(planSteps)+'\n\nReturn ONLY JSON: {"steps":[{"title":"...","desc":"...","timeline":"..."}]}';
                        var polR=await ai([{role:'user',content:polishPrompt}],1500,'general');
                        if(polR){var plc=polR.replace(/```json|```/g,'').trim();try{var plp=JSON.parse(plc);if(plp.steps&&plp.steps.length>=3)planSteps=plp.steps;}catch(e){}}
                    }catch(e){}
                }
                
                S.plans[idx]={generating:false,steps:planSteps.slice(0,5)};render();
            });
        })(pi);
    }
    
    // Generate Plan buttons for THREAT page
    for(var tpi=0;tpi<(S.threatResult?.opportunities?.length||0);tpi++){
        (function(idx){
            document.getElementById('gen-threat-plan-'+idx)?.addEventListener('click',async function(){
                if(!S.threatPlans)S.threatPlans={};
                if(S.threatPlans[idx]&&S.threatPlans[idx].generating)return;
                S.threatPlans[idx]={generating:true,steps:[]};render();
                var opp=S.threatResult.opportunities[idx];
                var domain=S.threatUrl.replace(/https?:\/\//,'').replace(/www\./,'').replace(/\/$/,'');
                var ctx=S.threatDesc?domain+': '+S.threatDesc+'. '+S.threatIndustry+'.':domain+' ('+S.threatIndustry+').';
                var planPrompt='You are a strategic AI consultant. Create a specific, actionable plan for this opportunity.\n\nCompany: '+ctx+'\nOpportunity: '+opp.title+'\nPrediction: '+(opp.prediction||'')+'\nDescription: '+opp.description+'\n\nCreate a 5-step action plan that is SPECIFIC to '+domain+'.\n\nRules:\n- Step 1 should be something they can do THIS WEEK\n- Steps should build on each other\n- Include specific tools, platforms, or approaches\n- Reference what '+domain+' actually does\n- Include estimated timeline for each step\n\nReturn ONLY JSON:\n{"steps":[{"title":"short action title","desc":"2-3 specific sentences","timeline":"e.g. Week 1, Month 1-2"}]}\n\n5 steps exactly.';
                var planSteps=[];
                try{var pr=await ai([{role:'user',content:planPrompt}],2000,'general');if(pr){var pc=pr.replace(/```json|```/g,'').trim();try{var pp=JSON.parse(pc);if(pp.steps)planSteps=pp.steps;}catch(e){}}}catch(e){}
                if(planSteps.length>=3){try{var valPlanPrompt='Company: '+ctx+'\nOpportunity: '+opp.title+'\n\nReview and reorder this plan. Most impactful first. Replace anything generic.\n\nPlan:\n'+planSteps.map(function(s,i){return(i+1)+'. '+s.title+': '+s.desc;}).join('\n')+'\n\nReturn ONLY JSON:\n{"steps":[{"title":"...","desc":"...","timeline":"..."}]}';var vr=await aiRank(valPlanPrompt,1500);if(vr){var vc=vr.replace(/```json|```/g,'').trim();try{var vp=JSON.parse(vc);if(vp.steps&&vp.steps.length>=3)planSteps=vp.steps;}catch(e){}}}catch(e){}}
                S.threatPlans[idx]={generating:false,steps:planSteps.slice(0,5)};render();
            });
        })(tpi);
    }

    // Onboarding flow - Step 1: Email + Industry
    document.getElementById('onboard-email-form')?.addEventListener('submit',e=>{
        e.preventDefault();
        S.onboardData.email = document.getElementById('ob-email').value;
        S.onboardData.industry = document.getElementById('ob-industry').value;
        S.onboardStep=2; // Go to quiz intro
        render();
    });
    
    // Step 4: Post-payment account creation (name + password)
    document.getElementById('post-payment-account-form')?.addEventListener('submit', async e=>{
        e.preventDefault();
        const btn = e.target.querySelector('button');
        btn.textContent = 'Creating account...';
        btn.disabled = true;
        
        const name = document.getElementById('ob-name').value;
        const password = document.getElementById('ob-pass').value;
        const email = S.onboardData?.email || S.user?.email;
        
        // Create Supabase Auth account
        const authResult = await authSignUp(email, password);
        if (authResult.error && authResult.error.message !== 'User already registered') {
            console.error('Auth signup error:', authResult.error);
            alert('Account creation failed. Please try again.');
            btn.textContent = 'Create Account';
            btn.disabled = false;
            return;
        }
        
        S.user = S.user || {};
        S.user.name = name;
        S.user.email = email;
        S.user.industry = S.onboardData?.industry;
        S.user.scores = S.freeQuizScores || S.scores || {ideas:50,personality:50,execution:50};
        S.user.baseline_scores = S.user.scores;
        S.user.plan = 'paid';
        S.user.start_date = new Date().toISOString();
        S.user.onboarded = false; // Will be true after they finish all steps
        
        // Save to database NOW so they can always log back in (no password stored here)
        const existing = await db('users','GET',null,`?email=eq.${encodeURIComponent(S.user.email)}`);
        if(existing?.length){
            // Update existing user
            await db('users','PATCH', S.user, `?email=eq.${encodeURIComponent(S.user.email)}`);
            S.user = {...existing[0], ...S.user};
        } else {
            // Create new user
            const res = await db('users','POST', S.user);
            if(res?.length) S.user = res[0];
        }
        
        localStorage.setItem('apc_session', JSON.stringify(S.user));
        localStorage.removeItem('apc_pending');
        
        S.onboardStep=5; // Go to goals
        render();
    });
    
    // Step 2: Start Assessment
    document.getElementById('start-assessment')?.addEventListener('click',()=>{
        S.quizStep=0;
        S.quizAnswers=[];
        S.screen='quiz';
        render();
    });
    
    // Step 4: Goals selection (after payment)
    document.querySelectorAll('.goal-option').forEach(g=>g.addEventListener('click',()=>{
        const goalId = g.dataset.goal;
        if(!S.onboardData.goals) S.onboardData.goals = [];
        if(S.onboardData.goals.includes(goalId)){
            S.onboardData.goals = S.onboardData.goals.filter(id=>id!==goalId);
        } else {
            S.onboardData.goals.push(goalId);
        }
        render();
    }));
    document.getElementById('goals-continue')?.addEventListener('click',()=>{
        if(S.onboardData.goals && S.onboardData.goals.length > 0){
            S.onboardStep=6;
            render();
        }
    });
    
    // Step 5: Interests selection + finish
    document.querySelectorAll('.interest-option').forEach(i=>i.addEventListener('click',()=>{
        const interestId = i.dataset.interest;
        if(S.onboardData.forecastInterests.includes(interestId)){
            S.onboardData.forecastInterests = S.onboardData.forecastInterests.filter(id=>id!==interestId);
        } else {
            S.onboardData.forecastInterests.push(interestId);
        }
        render();
    }));
    
    // Go to Stripe payment (step 3) - save pending data before redirect
    document.getElementById('go-to-stripe-link')?.addEventListener('click',()=>{
        // Save pending user data before redirecting to Stripe
        const pendingUser = {
            email: S.onboardData.email,
            industry: S.onboardData.industry,
            scores: S.freeQuizScores || S.scores,
            baseline_scores: S.freeQuizScores || S.scores,
            onboardStep: 4, // After payment, continue to step 4
            onboardData: S.onboardData,
            onboardSelectedForecasts: S.onboardSelectedForecasts
        };
        localStorage.setItem('apc_pending', JSON.stringify(pendingUser));
        // Link will navigate to Stripe
    });
    document.getElementById('go-to-stripe-annual')?.addEventListener('click',()=>{
        // Save pending user data before redirecting to Stripe (annual)
        const pendingUser = {
            email: S.onboardData.email,
            industry: S.onboardData.industry,
            scores: S.freeQuizScores || S.scores,
            baseline_scores: S.freeQuizScores || S.scores,
            onboardStep: 4,
            onboardData: S.onboardData,
            onboardSelectedForecasts: S.onboardSelectedForecasts
        };
        localStorage.setItem('apc_pending', JSON.stringify(pendingUser));
    });
    
    // Diagnostic results - save pending data for both monthly and annual
    document.getElementById('diag-to-signup-link')?.addEventListener('click',()=>{
        const scores = calculateDiagnosticScores();
        const pendingUser = {
            email: S.diagnosticEmail,
            industry: S.diagnosticIndustry,
            scores: scores,
            baseline_scores: scores,
            onboardStep: 4,
            onboardData: { email: S.diagnosticEmail, industry: S.diagnosticIndustry, goals: [], forecastInterests: [] },
            onboardSelectedForecasts: []
        };
        localStorage.setItem('apc_pending', JSON.stringify(pendingUser));
    });
    document.getElementById('diag-to-signup-annual')?.addEventListener('click',()=>{
        const scores = calculateDiagnosticScores();
        const pendingUser = {
            email: S.diagnosticEmail,
            industry: S.diagnosticIndustry,
            scores: scores,
            baseline_scores: scores,
            onboardStep: 4,
            onboardData: { email: S.diagnosticEmail, industry: S.diagnosticIndustry, goals: [], forecastInterests: [] },
            onboardSelectedForecasts: []
        };
        localStorage.setItem('apc_pending', JSON.stringify(pendingUser));
    });
    
    // Finish onboarding
    document.getElementById('finish-onboarding')?.addEventListener('click',async()=>{
        // Complete the onboarding - save user and go to dashboard
        await completeOnboarding();
    });
    
    // Suggested forecasts selection
    document.querySelectorAll('.suggested-forecast').forEach(f=>f.addEventListener('click',()=>{
        const fid = f.dataset.fid;
        if(!S.onboardSelectedForecasts) S.onboardSelectedForecasts = [];
        if(S.onboardSelectedForecasts.includes(fid)){
            S.onboardSelectedForecasts = S.onboardSelectedForecasts.filter(id=>id!==fid);
        } else {
            S.onboardSelectedForecasts.push(fid);
        }
        render();
    }));
    document.getElementById('forecasts-continue')?.addEventListener('click',()=>{
        S.onboardStep=7; // Go to email/paywall
        render();
    });
    
    // Email signup + Paywall (step 7)
    document.getElementById('subscribe-btn')?.addEventListener('click',()=>{
        // Save email preference before redirecting to Stripe
        const email = document.getElementById('weekly-email')?.value;
        const optIn = document.getElementById('email-optin')?.checked;
        if(email && optIn) {
            // Store for later use after payment
            S.weeklyEmailOptIn = {email, optedIn: optIn};
            save();
        }
    });
    
    // Upload (keeping for settings, but not in onboarding)
    const zone=document.getElementById('upload-zone'),inp=document.getElementById('file-input');
    zone?.addEventListener('click',()=>inp?.click());
    inp?.addEventListener('change',e=>handleFile(e.target.files[0]));
    document.getElementById('rm-file')?.addEventListener('click',()=>{S.uploadedFile=null;render();});
    document.getElementById('analyze-btn')?.addEventListener('click',analyzeFile);
    document.getElementById('skip-upload')?.addEventListener('click',()=>{
        // If we have free quiz scores, use those
        if(S.freeQuizScores) S.scores = {...S.freeQuizScores};
        S.screen='results';
        render();
    });
    
    // Quiz
    document.querySelectorAll('.option').forEach(o=>o.addEventListener('click',()=>answerQuiz(+o.dataset.idx)));
    document.querySelectorAll('[data-diff]').forEach(b=>b.addEventListener('click',()=>{S.diff=b.dataset.diff;render();}));
    document.getElementById('start-app')?.addEventListener('click',startApp);
    
    // App navigation
    document.querySelectorAll('[data-screen]').forEach(a=>a.addEventListener('click',e=>{e.preventDefault();S.showMoreMenu=false;S.screen=a.dataset.screen;render();}));
    document.getElementById('logout')?.addEventListener('click',logout);
    document.getElementById('mobile-logout')?.addEventListener('click',logout);
    
    // More menu toggle
    document.getElementById('more-menu-toggle')?.addEventListener('click',e=>{e.stopPropagation();S.showMoreMenu=!S.showMoreMenu;render();});
    document.addEventListener('click',e=>{if(S.showMoreMenu && !e.target.closest('.more-menu') && !e.target.closest('#more-menu-toggle')){S.showMoreMenu=false;render();}});
    
    // Quests
    document.querySelectorAll('.complete-q').forEach(b=>b.addEventListener('click',()=>openModal(b.dataset.id)));
    document.querySelectorAll('.skip-q').forEach(b=>b.addEventListener('click',()=>skipQuest(b.dataset.id)));
    document.querySelectorAll('[data-setdiff]').forEach(b=>b.addEventListener('click',()=>{S.diff=b.dataset.setdiff;S.quests=genQuests();save();render();}));
    // Get Quests modal
    document.getElementById('get-quests-btn')?.addEventListener('click',()=>{
        S.modal='getQuests';
        S.getQuestsExpandedOpp=null;
        render();
    });
    document.getElementById('close-get-quests')?.addEventListener('click',()=>{
        S.modal=null;
        S.getQuestsExpandedOpp=null;
        render();
    });
    document.getElementById('browse-all-forecasts')?.addEventListener('click',()=>{
        S.modal=null;
        S.getQuestsExpandedOpp=null;
        S.screen='forecasts';
        render();
    });
    // Expand/collapse opportunities in Get Quests modal
    document.querySelectorAll('.get-quests-opp-header').forEach(el=>el.addEventListener('click',()=>{
        const fid = el.dataset.fid;
        const oid = parseInt(el.dataset.oid);
        if(S.getQuestsExpandedOpp?.forecastId === fid && S.getQuestsExpandedOpp?.oppIndex === oid){
            S.getQuestsExpandedOpp = null;
        } else {
            S.getQuestsExpandedOpp = {forecastId: fid, oppIndex: oid};
        }
        render();
    }));
    // Add quests from Get Quests modal
    document.querySelectorAll('.add-opp-quests').forEach(el=>el.addEventListener('click',()=>{
        const fid = el.dataset.fid;
        const oid = parseInt(el.dataset.oid);
        // Follow this forecast if not already
        if(!S.followedForecasts.includes(fid)){
            S.followedForecasts.push(fid);
        }
        if(!S.forecastProgress[fid]) S.forecastProgress[fid] = {};
        S.modal=null;
        S.getQuestsExpandedOpp=null;
        save();
        render();
    }));
    
    // Custom quests
    document.getElementById('add-custom-quest')?.addEventListener('click',()=>{S.modal='addQuest';render();});
    document.getElementById('custom-quest-form')?.addEventListener('submit',e=>{e.preventDefault();addCustomQuest();});
    document.querySelectorAll('.complete-custom-q').forEach(b=>b.addEventListener('click',()=>completeCustomQuest(b.dataset.id)));
    document.querySelectorAll('.delete-custom-q').forEach(b=>b.addEventListener('click',()=>deleteCustomQuest(b.dataset.id)));
    
    // Hide quests
    document.querySelectorAll('.hide-q').forEach(b=>b.addEventListener('click',()=>hideQuest(b.dataset.id)));
    document.getElementById('unhide-all')?.addEventListener('click',()=>{S.hiddenQuests=[];save();render();});
    
    // Forecast quests
    document.querySelectorAll('.complete-forecast-q').forEach(b=>b.addEventListener('click',()=>completeForecastQuest(b.dataset.fid, b.dataset.oid)));
    document.querySelectorAll('.follow-forecast').forEach(b=>b.addEventListener('click',()=>toggleFollowForecast(b.dataset.id)));
    
    // Modal
    document.getElementById('modal-bg')?.addEventListener('click',e=>{if(e.target.id==='modal-bg')closeModal();});
    document.getElementById('cancel-modal')?.addEventListener('click',closeModal);
    document.getElementById('confirm-done')?.addEventListener('click',confirmDone);
    
    // Chat
    document.getElementById('send-msg')?.addEventListener('click',sendChat);
    document.getElementById('chat-input')?.addEventListener('keypress',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendChat();}});
    document.querySelectorAll('[data-coach]').forEach(b=>b.addEventListener('click',()=>{S.coachMode=b.dataset.coach;render();}));
    
    // Review
    document.getElementById('gen-review')?.addEventListener('click',genReview);
    
    // Settings
    document.getElementById('re-upload')?.addEventListener('click',()=>{S.screen='upload';render();});
    document.getElementById('re-quiz')?.addEventListener('click',()=>{S.quizStep=0;S.quizAnswers=[];S.screen='quiz';render();});
    document.getElementById('support-form')?.addEventListener('submit',e=>{e.preventDefault();submitSupport();});
    document.getElementById('change-password-form')?.addEventListener('submit',e=>{e.preventDefault();changePassword();});
    document.getElementById('toggle-password-form')?.addEventListener('click',e=>{
        e.preventDefault();
        const container = document.getElementById('password-form-container');
        if(container) container.style.display = container.style.display === 'none' ? 'block' : 'none';
    });
    
    // Theme toggle
    document.getElementById('theme-dark')?.addEventListener('click',()=>{setTheme('dark');});
    document.getElementById('theme-light')?.addEventListener('click',()=>{setTheme('light');});
    
    // Forecasts
    document.querySelectorAll('[data-filter]').forEach(b=>b.addEventListener('click',()=>{S.forecastFilter=b.dataset.filter;render();}));
    document.querySelectorAll('.view-forecast-detail').forEach(b=>b.addEventListener('click',()=>{
        S.selectedForecast = FORECAST_DATABASE.find(f => f.id === b.dataset.id);
        S.expandedOpp = null; // Reset expanded opportunity
        S.modal = 'forecastDetail';
        render();
    }));
    document.getElementById('close-forecast-modal')?.addEventListener('click',()=>{S.modal=null;S.selectedForecast=null;S.expandedOpp=null;render();});
    document.querySelectorAll('.opp-header').forEach(h=>h.addEventListener('click',()=>{
        const oppIndex = parseInt(h.dataset.opp);
        S.expandedOpp = S.expandedOpp === oppIndex ? null : oppIndex;
        render();
    }));
    document.querySelectorAll('.add-quest-path').forEach(b=>b.addEventListener('click',()=>{
        addQuestPathToQueue(b.dataset.forecast, parseInt(b.dataset.opp));
    }));
}

// Custom Quest Functions
function addCustomQuest(){
    const text = document.getElementById('custom-quest-text').value.trim();
    const mode = document.getElementById('custom-quest-mode').value;
    const xp = parseInt(document.getElementById('custom-quest-xp').value) || 40;
    
    if(!text) return;
    
    S.customQuests.push({
        id: 'custom-' + Date.now(),
        t: text,
        mode: mode,
        xp: Math.min(100, Math.max(10, xp)),
        done: false,
        ts: Date.now()
    });
    S.modal = null;
    save();
    render();
}

function completeCustomQuest(id){
    const q = S.customQuests.find(q=>q.id===id);
    if(!q) return;
    
    q.done = true;
    S.receipts.push({
        title: q.t,
        mode: q.mode,
        xp: q.xp,
        ts: Date.now(),
        reflection: 'Custom quest completed'
    });
    updateScores(q.mode, q.xp);
    save();
    render();
}

function deleteCustomQuest(id){
    S.customQuests = S.customQuests.filter(q=>q.id!==id);
    save();
    render();
}

function hideQuest(id){
    if(!S.hiddenQuests.includes(id)){
        S.hiddenQuests.push(id);
        save();
        render();
    }
}

// Forecast Quest Functions
async function toggleFollowForecast(forecastId){
    const idx = S.followedForecasts.indexOf(forecastId);
    if(idx === -1){
        S.followedForecasts.push(forecastId);
        if(!S.forecastProgress[forecastId]) S.forecastProgress[forecastId] = {};
    } else {
        S.followedForecasts.splice(idx, 1);
    }
    await save();
    render();
}

function completeForecastQuest(forecastId, oppIndex){
    oppIndex = parseInt(oppIndex);
    const forecast = FORECAST_DATABASE.find(f => f.id === forecastId);
    if(!forecast){console.error('Forecast not found:',forecastId);return;}
    
    const opp = forecast.opportunities[oppIndex];
    if(!opp){console.error('Opp not found:',forecastId,'index:',oppIndex,'total opps:',forecast.opportunities.length);return;}
    
    // Initialize progress if needed
    if(!S.forecastProgress[forecastId]) S.forecastProgress[forecastId] = {};
    const currentStep = S.forecastProgress[forecastId][oppIndex] || 0;
    
    if(currentStep < opp.quests.length){
        const quest = opp.quests[currentStep];
        
        // Add receipt
        S.receipts.push({
            title: quest.task,
            mode: quest.mode,
            xp: quest.xp,
            ts: Date.now(),
            reflection: `Forecast: ${forecast.title.substring(0,50)}...`,
            forecastId: forecastId,
            oppIndex: oppIndex
        });
        
        // Update scores
        updateScores(quest.mode, quest.xp);
        
        // Advance progress
        S.forecastProgress[forecastId][oppIndex] = currentStep + 1;
    }
    
    save();
    render();
}

// Onboarding handlers
async function handleOnboardAccount(){
    const name = document.getElementById('ob-name').value;
    const email = document.getElementById('ob-email').value;
    const pass = document.getElementById('ob-pass').value;
    
    // Create Supabase Auth account
    const authResult = await authSignUp(email, pass);
    if (authResult.error) {
        if (authResult.error.message === 'User already registered') {
            alert('Email already exists. Please sign in.');
        } else {
            alert('Signup failed: ' + (authResult.error.message || 'Unknown error'));
        }
        return;
    }
    
    // Sign them in to get access token
    const signIn = await authSignIn(email, pass);
    if (signIn.access_token) {
        localStorage.setItem('apc_auth_token', signIn.access_token);
    }
    
    S.user = {name, email, start_date: new Date().toISOString(), onboarded: false};
    S.onboardData.email = email;
    localStorage.setItem('apc_pending', JSON.stringify(S.user));
    S.onboardStep = 2;
    render();
}

function handleOnboardOccupation(){
    S.onboardData.occupation = document.getElementById('ob-occupation').value;
    S.onboardData.industry = document.getElementById('ob-industry').value;
    S.onboardData.experience = document.getElementById('ob-experience').value;
    S.onboardStep = 3;
    render();
}

async function login(){
    const email = document.getElementById('email').value;
    const pass = document.getElementById('pass').value;
    
    // Step 1: Try Supabase Auth first
    const authResult = await authSignIn(email, pass);
    
    if (!authResult.error) {
        // Supabase Auth worked - user is already migrated
        const accessToken = authResult.access_token;
        localStorage.setItem('apc_auth_token', accessToken);
        
        // Load user data from users table
        const users = await db('users', 'GET', null, `?email=eq.${encodeURIComponent(email)}`);
        if (users?.length) {
            S.user = users[0];
            S.scores = users[0].scores || {ideas:50, personality:50, execution:50};
            S.receipts = users[0].receipts || [];
            S.quests = users[0].quests?.length ? users[0].quests : genQuests();
            S.diff = users[0].diff || 'standard';
            localStorage.setItem('apc_session', JSON.stringify({...S.user, authToken: accessToken}));
            
            if (S.user.plan === 'paid' || S.user.onboarded) {
                S.screen = 'dashboard';
            } else {
                S.screen = 'onboarding';
            }
            render();
            return;
        }
    }
    
    // Step 2: Supabase Auth failed - check if they exist in SQL with old password
    const users = await db('users', 'GET', null, `?email=eq.${encodeURIComponent(email)}`);
    
    if (users?.length && users[0].password === pass) {
        // Old password matches! Migrate them to Supabase Auth
        console.log('Migrating user to Supabase Auth...');
        
        const signupResult = await authSignUp(email, pass);
        
        if (signupResult.error && signupResult.error.message !== 'User already registered') {
            console.error('Migration signup failed:', signupResult.error);
            alert('Login error. Please try again or contact support.');
            return;
        }
        
        // Now sign them in with Supabase Auth
        const newAuthResult = await authSignIn(email, pass);
        
        if (newAuthResult.error) {
            // Might need to confirm email - just let them in with old method for now
            console.log('Auth signin after migration failed, using legacy login');
        } else {
            localStorage.setItem('apc_auth_token', newAuthResult.access_token);
        }
        
        // Load user data and proceed
        S.user = users[0];
        S.scores = users[0].scores || {ideas:50, personality:50, execution:50};
        S.receipts = users[0].receipts || [];
        S.quests = users[0].quests?.length ? users[0].quests : genQuests();
        S.diff = users[0].diff || 'standard';
        localStorage.setItem('apc_session', JSON.stringify(S.user));
        
        if (S.user.plan === 'paid' || S.user.onboarded) {
            S.screen = 'dashboard';
        } else {
            S.screen = 'onboarding';
        }
        render();
        return;
    }
    
    alert('Invalid credentials');
}

async function signup(){
    const name = document.getElementById('name').value;
    const email = document.getElementById('email').value;
    const pass = document.getElementById('pass').value;
    
    // Check if email exists in users table
    const ex = await db('users', 'GET', null, `?email=eq.${encodeURIComponent(email)}`);
    if (ex?.length) {
        alert('Email exists');
        return;
    }
    
    // Create Supabase Auth account
    const authResult = await authSignUp(email, pass);
    if (authResult.error && authResult.error.message !== 'User already registered') {
        console.error('Signup error:', authResult.error);
        alert('Signup failed: ' + (authResult.error.message || 'Unknown error'));
        return;
    }
    
    // Store user data (without password - it's in Supabase Auth now)
    S.user = {name, email, start_date: new Date().toISOString(), onboarded: false};
    localStorage.setItem('apc_pending', JSON.stringify(S.user));
    S.screen = 'pricing';
    render();
}

function handleFile(f){if(f?.name.endsWith('.json')){S.uploadedFile=f;render();}else alert('Upload .json file');}

async function analyzeFile(){
    S.screen='analyzing';render();
    try{
        const txt=await S.uploadedFile.text();
        const res=await ai([{role:'user',content:txt.substring(0,20000)}],600,'analyze');
        const data=JSON.parse(res);
        if(data?.ideas !== undefined){
            // Apply skewing to GPT scores too
            const skewed = skewScores({ideas:data.ideas,personality:data.personality,execution:data.execution});
            S.scores = skewed;
            S.gptAnalysis = {scores: skewed, summary: data.summary};
        }
    }catch(e){console.error(e);}
    S.screen='results';render();
}

function answerQuiz(i){
    // Use first 7 questions for onboarding, all 15 for free quiz
    const isFree = S.freeQuizMode || S.screen === 'freeQuiz';
    const quizQuestions = isFree ? Qs : Qs.slice(0, 7);
    
    S.quizAnswers.push(quizQuestions[S.quizStep].o[i]);
    if(S.quizStep < quizQuestions.length - 1){
        S.quizStep++;
        render();
    } else {
        // Calculate raw scores
        const raw = {ideas:50, personality:50, execution:50};
        const multiplier = isFree ? 5 : 7; // Higher multiplier for fewer questions
        S.quizAnswers.forEach(a => {
            raw[a.m] = Math.min(100, Math.max(0, raw[a.m] + a.w * multiplier));
        });
        
        // Apply GPT analysis if available
        if(S.gptAnalysis?.scores){
            raw.ideas = Math.round((raw.ideas + S.gptAnalysis.scores.ideas) / 2);
            raw.personality = Math.round((raw.personality + S.gptAnalysis.scores.personality) / 2);
            raw.execution = Math.round((raw.execution + S.gptAnalysis.scores.execution) / 2);
        }
        
        // Apply score skewing (lower the weakest score)
        const skewed = skewScores(raw);
        
        // Handle free quiz vs onboarding quiz
        if(isFree) {
            S.freeQuizScores = skewed;
            S.freeQuizMode = false;
            S.screen = 'freeResults';
        } else {
            S.scores = skewed;
            S.freeQuizScores = skewed;
            // Go to onboarding step 3 (results + paywall)
            S.onboardStep = 3;
            S.screen = 'onboarding';
        }
        render();
    }
}

async function completeOnboarding(){
    // This is called after payment, at the end of onboarding step 5
    // Include onboarding data in user object
    S.user = S.user || {};
    S.user.email = S.onboardData.email;
    S.user.industry = S.onboardData.industry;
    S.user.onboarded = true;
    S.user.baseline_scores = {...S.scores};
    S.user.scores = S.scores;
    S.user.diff = S.diff || 'standard';
    S.user.goals = S.onboardData.goals;
    S.user.forecast_interests = S.onboardData.forecastInterests;
    
    // Follow selected forecasts
    if(S.onboardSelectedForecasts?.length){
        S.followedForecasts = [...S.onboardSelectedForecasts];
    }
    
    S.quests = genQuests();
    const res = await db('users','POST',S.user);
    if(res?.length){
        S.user = res[0];
        localStorage.setItem('apc_session',JSON.stringify(S.user));
        localStorage.removeItem('apc_pending');
        // Send welcome email (don't await - fire and forget)
        sendWelcomeEmail(S.user.name || 'there', S.user.email);
    }
    S.screen = 'dashboard';
    render();
}

async function startApp(){
    // Include onboarding data in user object
    S.user.onboarded = true;
    S.user.baseline_scores = {...S.scores};
    S.user.scores = S.scores;
    S.user.diff = S.diff;
    S.user.occupation = S.onboardData.occupation;
    S.user.industry = S.onboardData.industry;
    S.user.experience = S.onboardData.experience;
    S.user.goals = S.onboardData.goals;
    S.user.forecast_interests = S.onboardData.forecastInterests;
    
    S.quests = genQuests();
    const res = await db('users','POST',S.user);
    if(res?.length){
        S.user = res[0];
        localStorage.setItem('apc_session',JSON.stringify(S.user));
        localStorage.removeItem('apc_pending');
        // Send welcome email (don't await - fire and forget)
        sendWelcomeEmail(S.user.name, S.user.email);
    }
    S.screen = 'dashboard';
    render();
}

function openModal(id){S.selectedQuest=S.quests.find(q=>q.id==id);S.modal='complete';render();}
function closeModal(){S.modal=null;S.selectedQuest=null;render();}

async function confirmDone(){
    const q=S.selectedQuest,ref=document.getElementById('reflection')?.value||'';
    q.done=true;
    S.receipts.push({id:Date.now(),title:q.t,mode:q.mode,xp:q.xp,reflection:ref,ts:new Date().toISOString()});
    S.scores[q.mode]=Math.min(100,S.scores[q.mode]+Math.floor(q.xp/20));
    updateStreakData(); // Track streak locally
    closeModal();await save();render();
}

function skipQuest(id){S.quests=S.quests.filter(q=>q.id!=id);save();render();}

async function sendChat(){
    const inp=document.getElementById('chat-input'),msg=inp.value.trim();if(!msg)return;
    const mode = S.coachMode;
    S.chat.push({t:msg,u:true,mode:mode});inp.value='';S.loading=true;render();
    
    const modeChats = S.chat.filter(m => m.mode === mode);
    const coachType = 'coach-' + mode;
    const reply=await ai(modeChats.map(m=>({role:m.u?'user':'assistant',content:m.t})),500,coachType);
    S.chat.push({t:reply||'Error. Try again.',u:false,mode:mode});S.loading=false;render();
    document.getElementById('chat-msgs')?.scrollTo(0,999999);
}

async function genReview(){
    S.loading=true;render();
    const week=S.receipts.filter(r=>(Date.now()-new Date(r.ts))<7*86400000);
    if(week.length<3){S.loading=false;render();return;}
    const sum=week.map(r=>`- ${r.title} (${r.mode}) ${r.reflection||''}`).join('\n');
    S.weeklyReview=await ai([{role:'user',content:`This week:\n${sum}`}],400,'review');
    S.loading=false;render();
}

function logout(){S.user=null;S.screen='login';S.scores={ideas:50,personality:50,execution:50};S.quests=[];S.receipts=[];S.chat=[];localStorage.removeItem('apc_session');render();}

// ==================== EMAIL SYSTEM ====================
// Note: Requires Resend API key in environment variable RESEND_API_KEY
// Set up at: https://resend.com
// Verify domain: aiproof.club

const EMAIL_API = '/.netlify/functions/send-email';

async function sendEmail(type, data) {
    try {
        const response = await fetch(EMAIL_API, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ type, data })
        });
        return response.ok;
    } catch (e) {
        console.error('Email send failed:', e);
        return false;
    }
}

// Welcome email - sent after successful signup
async function sendWelcomeEmail(name, email) {
    return sendEmail('welcome', { name, email });
}

// Password reset email
async function resetPassword(){
    const email = document.getElementById('reset-email').value;
    const btn = document.querySelector('#forgot-form button');
    btn.textContent = 'Sending...';
    btn.disabled = true;
    
    // Use Supabase Auth password reset
    const result = await authResetPassword(email);
    
    if (result.error) {
        console.error('Password reset error:', result.error);
    }
    
    // Always show same message for security
    alert('If an account exists with that email, a reset link has been sent. Check your inbox.');
    btn.textContent = 'Send Reset Link';
    btn.disabled = false;
    S.screen='login';
    render();
}

// Change password (from settings when logged in)
async function changePassword(){
    const currentPass = document.getElementById('current-pass').value;
    const newPass = document.getElementById('new-pass').value;
    const confirmPass = document.getElementById('confirm-pass').value;
    
    if(newPass !== confirmPass) {
        alert('New passwords do not match.');
        return;
    }
    
    if(newPass.length < 6) {
        alert('Password must be at least 6 characters.');
        return;
    }
    
    // Try to verify via Supabase Auth by signing in with current password
    const authResult = await authSignIn(S.user.email, currentPass);
    
    if (authResult.error) {
        // Fallback: check old SQL password for users not yet migrated
        const users = await db('users', 'GET', null, `?email=eq.${encodeURIComponent(S.user.email)}`);
        if (!users?.length || users[0].password !== currentPass) {
            alert('Current password is incorrect.');
            return;
        }
        
        // Migrate to Supabase Auth with new password
        await authSignUp(S.user.email, newPass);
    } else {
        // Update password in Supabase Auth
        const updateResult = await authUpdatePassword(authResult.access_token, newPass);
        if (updateResult.error) {
            alert('Failed to update password. Please try again.');
            return;
        }
    }
    
    alert('Password updated successfully!');
    document.getElementById('change-password-form').reset();
}

// Support form submission
async function submitSupport(){
    const subject = document.getElementById('support-subject').value;
    const message = document.getElementById('support-message').value;
    const btn = document.querySelector('#support-form button');
    
    btn.textContent = 'Sending...';
    btn.disabled = true;
    
    const success = await sendEmail('support', {
        name: S.user?.name || 'Unknown',
        email: S.user?.email || 'No email',
        userId: S.user?.id,
        subject,
        message,
        userStats: {
            dayNum: dayNum(),
            totalXP: totalXP(),
            streak: streak(),
            scores: S.scores
        }
    });
    
    if(success) {
        alert('Message sent! We\'ll get back to you within 24-48 hours.');
        document.getElementById('support-form').reset();
    } else {
        alert('Failed to send message. Please try again or email directly at support@aiproof.club');
    }
    
    btn.textContent = 'Send Message';
    btn.disabled = false;
}

// Handle password reset from email link (called on page load)
async function handleResetToken() {
    // Supabase sends recovery links with hash: #access_token=xxx&type=recovery
    var hp = new URLSearchParams(window.location.hash.substring(1));
    var at = hp.get('access_token');
    var tt = hp.get('type');
    if(at && tt === 'recovery') {
        S.modal = 'resetPassword';
        S.recoveryAccessToken = at;
        S.screen = 'resetPassword';
        render();
    }
}

async function completePasswordReset() {
    const newPass = document.getElementById('reset-new-pass').value;
    const confirmPass = document.getElementById('reset-confirm-pass').value;
    
    if(newPass !== confirmPass) {
        alert('Passwords do not match.');
        return;
    }
    
    if(newPass.length < 6) {
        alert('Password must be at least 6 characters.');
        return;
    }
    
    const btn = document.querySelector('#reset-password-form button');
    btn.textContent = 'Updating...';
    btn.disabled = true;
    
    try {
        // Use the recovery access token from Supabase to update password
        const result = await authUpdatePassword(S.recoveryAccessToken, newPass);
        
        if(result.error) {
            console.error('Password update error:', result.error);
            alert('Reset link has expired. Please request a new one.');
            S.modal = null;
            S.screen = 'forgot';
            render();
            return;
        }
        
        alert('Password updated successfully! Please sign in.');
        S.modal = null;
        S.recoveryAccessToken = null;
        // Clear the hash/params from URL
        history.replaceState({}, '', location.pathname);
        S.screen = 'login';
        render();
    } catch(e) {
        console.error('Reset error:', e);
        alert('Something went wrong. Please try again.');
        btn.textContent = 'Set New Password';
        btn.disabled = false;
    }
}

async function save(){
    if(!S.user?.email) {
        console.error('Save failed: No user email');
        return;
    }
    const data = {
        scores: S.scores,
        receipts: S.receipts,
        quests: S.quests,
        diff: S.diff,
        hiddenQuests: S.hiddenQuests,
        customQuests: S.customQuests,
        followedForecasts: S.followedForecasts,
        forecastProgress: S.forecastProgress,
        lastQuestWeek: S.user.lastQuestWeek
    };
    const result = await db('users','PATCH',data,`?email=eq.${encodeURIComponent(S.user.email)}`);
    if(!result) console.error('Save to Supabase failed');
    localStorage.setItem('apc_session',JSON.stringify({...S.user,...data}));
}

// ==================== FORECASTS ====================
const CATEGORIES = {
    'ai': {name: 'AI & Technology', icon: 'ü§ñ'},
    'tech': {name: 'Tech & Business', icon: 'üíª'},
    'transportation': {name: 'Transportation', icon: 'üöó'},
    'crypto': {name: 'Crypto', icon: '‚Çø'},
    'finance': {name: 'Finance', icon: 'üìà'},
    'work': {name: 'Future of Work', icon: 'üíº'},
    'media': {name: 'Media & Content', icon: 'üé¨'}
};

// COMPREHENSIVE FORECAST DATABASE
// Real odds from Polymarket + Metaculus + Billionaire predictions
// Last updated: February 2026
// 50+ forecasts per category with realistic, gradual quest progressions


function getRiskLevel(forecast, userScores) {
    const threatScore = userScores[forecast.threatMode];
    if (threatScore < 40) return {level: 'critical', label: 'CRITICAL', color: 'var(--danger)'};
    if (threatScore < 55) return {level: 'high', label: 'HIGH', color: 'var(--warning)'};
    if (threatScore < 70) return {level: 'moderate', label: 'MODERATE', color: 'var(--accent)'};
    return {level: 'low', label: 'LOW', color: 'var(--success)'};
}

function getUrgency(forecast) {
    const prob = forecast.probability;
    if (forecast.timeframe.includes('month') && prob > 60) return {label: 'URGENT', color: 'var(--danger)'};
    if (prob > 70) return {label: 'HIGH PROBABILITY', color: 'var(--warning)'};
    if (prob > 50) return {label: 'LIKELY', color: 'var(--accent)'};
    return {label: 'EMERGING', color: 'var(--text-secondary)'};
}

function forecastsH() {
    const forecasts = FORECAST_DATABASE;
    
    // Get user's profile for personalization
    const occupation = S.user?.occupation || S.onboardData?.occupation || '';
    const interests = S.user?.forecastInterests || S.user?.forecast_interests || S.onboardData?.forecastInterests || [];
    const goals = S.user?.goals || S.onboardData?.goals || [];
    
    // Check if user has set up their profile
    const hasProfile = occupation || interests.length > 0;
    
    // Map occupations to relevant categories
    const occupationCategories = {
        'tech': ['ai', 'tech', 'crypto', 'transportation'],
        'finance': ['finance', 'crypto', 'tech'],
        'creative': ['media', 'ai', 'work', 'transportation'],
        'healthcare': ['ai', 'work', 'tech', 'transportation'],
        'education': ['ai', 'work', 'media'],
        'marketing': ['media', 'ai', 'work'],
        'sales': ['work', 'ai', 'tech'],
        'consulting': ['work', 'finance', 'ai', 'transportation'],
        'legal': ['ai', 'work', 'finance', 'transportation'],
        'retail': ['work', 'ai', 'tech', 'transportation'],
        'manufacturing': ['ai', 'work', 'tech', 'transportation'],
        'other': ['ai', 'work', 'tech', 'transportation']
    };
    
    // Map interests to categories
    const interestCategories = {
        'ai': ['ai', 'tech'],
        'crypto': ['crypto', 'finance'],
        'finance': ['finance', 'work'],
        'media': ['media', 'ai'],
        'health': ['work', 'ai', 'transportation'],
        'climate': ['tech', 'work', 'transportation'],
        'transportation': ['transportation', 'tech', 'ai']
    };
    
    // Build relevant categories based on profile
    let relevantCategories = new Set();
    
    if (occupation && occupationCategories[occupation]) {
        occupationCategories[occupation].forEach(c => relevantCategories.add(c));
    }
    
    interests.forEach(interest => {
        if (interestCategories[interest]) {
            interestCategories[interest].forEach(c => relevantCategories.add(c));
        }
    });
    
    // Get suggested forecasts based on profile
    let suggestedForecasts = [];
    if (relevantCategories.size > 0) {
        suggestedForecasts = forecasts.filter(f => 
            relevantCategories.has(f.category) || f.threatMode === weakest()
        ).slice(0, 6);
    }
    
    // Get followed forecasts
    const followedForecasts = forecasts.filter(f => S.followedForecasts.includes(f.id));
    
    // Apply filter if one is selected
    const showSuggested = S.forecastFilter === 'suggested' || (!S.forecastFilter && hasProfile);
    const showFollowing = S.forecastFilter === 'following';
    const filtered = S.forecastFilter && S.forecastFilter !== 'all' && S.forecastFilter !== 'suggested' && S.forecastFilter !== 'following'
        ? forecasts.filter(f => f.category === S.forecastFilter)
        : S.forecastFilter === 'all' ? forecasts : null;
    
    return `
        <div class="page-header">
            <h1 class="page-title">Forecasts</h1>
            <p class="page-subtitle">Follow predictions that matter to your career. Get quests to prepare.</p>
        </div>
        
        ${followedForecasts.length > 0 ? `
        <div class="card mb-20" style="padding:15px;background:var(--bg-primary);border-color:var(--accent)">
            <div style="font-size:11px;color:var(--accent);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px">üì° You're Tracking ${followedForecasts.length} Forecast${followedForecasts.length > 1 ? 's' : ''}</div>
            <p style="font-size:13px;line-height:1.5;color:var(--text-secondary)">Your weekly quests are shaped by the forecasts you follow. <a href="#" class="text-link" data-filter="following">View your followed forecasts ‚Üí</a></p>
        </div>
        ` : ''}
        
        <div class="card mb-20" style="padding:15px">
            <div style="display:flex;gap:8px;flex-wrap:wrap">
                ${hasProfile ? `<button class="btn btn-small ${showSuggested && !S.forecastFilter ? 'btn-primary' : S.forecastFilter === 'suggested' ? 'btn-primary' : 'btn-secondary'}" data-filter="suggested">‚ú® For You</button>` : ''}
                ${followedForecasts.length > 0 ? `<button class="btn btn-small ${S.forecastFilter === 'following' ? 'btn-primary' : 'btn-secondary'}" data-filter="following">Following (${followedForecasts.length})</button>` : ''}
                <button class="btn btn-small ${S.forecastFilter==='all'?'btn-primary':'btn-secondary'}" data-filter="all">All</button>
                ${Object.entries(CATEGORIES).map(([k,v]) => 
                    `<button class="btn btn-small ${S.forecastFilter===k?'btn-primary':'btn-secondary'}" data-filter="${k}">${v.icon} ${v.name}</button>`
                ).join('')}
            </div>
        </div>
        
        ${!hasProfile && !S.forecastFilter ? `
        <div class="card mb-20" style="padding:25px;text-align:center;border-style:dashed">
            <div style="font-size:32px;margin-bottom:15px">üîÆ</div>
            <h3 style="font-size:16px;margin-bottom:10px">Select a category to explore forecasts</h3>
            <p style="font-size:13px;color:var(--text-secondary);max-width:400px;margin:0 auto">
                Each forecast reveals emerging opportunities and comes with quests to help you prepare before the window closes.
            </p>
        </div>
        ` : ''}
        
        ${showFollowing ? `
        <div style="margin-bottom:15px">
            <div style="font-size:11px;color:var(--accent);text-transform:uppercase;letter-spacing:1px;margin-bottom:15px">Forecasts You're Following</div>
            ${followedForecasts.length > 0 ? followedForecasts.map(f => renderForecastCard(f)).join('') : 
            '<div class="card" style="padding:25px;text-align:center"><p class="text-secondary">You\'re not following any forecasts yet. Browse categories above to find ones that matter to your career.</p></div>'}
        </div>
        ` : ''}
        
        ${showSuggested && !showFollowing && suggestedForecasts.length > 0 ? `
        <div style="margin-bottom:15px">
            <div style="font-size:11px;color:var(--accent);text-transform:uppercase;letter-spacing:1px;margin-bottom:5px">Suggested For You</div>
            <p style="font-size:12px;color:var(--text-secondary);margin-bottom:15px">Based on your ${occupation ? 'work in ' + getOccupationLabel(occupation) : 'interests'}${interests.length > 0 ? ' and selected interests' : ''}</p>
            ${suggestedForecasts.map(f => renderForecastCard(f)).join('')}
            <div style="text-align:center;margin-top:20px">
                <button class="btn btn-secondary" data-filter="all">View All Forecasts ‚Üí</button>
            </div>
        </div>
        ` : ''}
        
        ${filtered ? `
        <div class="forecast-list">
            ${filtered.map(f => renderForecastCard(f)).join('')}
        </div>
        ` : ''}
        
        <style>
            .forecast-item { transition: all 0.2s; }
            .forecast-item:hover { border-color: var(--text-secondary); }
            .threat-to-weakest { background: linear-gradient(135deg, var(--bg-secondary) 0%, rgba(255,68,68,0.05) 100%); }
    
    `;
}

function getOccupationLabel(occupation) {
    const labels = {
        'tech': 'Technology',
        'finance': 'Finance',
        'creative': 'Creative/Design',
        'healthcare': 'Healthcare',
        'education': 'Education',
        'marketing': 'Marketing',
        'sales': 'Sales',
        'consulting': 'Consulting',
        'legal': 'Legal',
        'retail': 'Retail',
        'manufacturing': 'Manufacturing',
        'other': 'your field'
    };
    return labels[occupation] || occupation;
}

function renderForecastCard(f) {
    const risk = getRiskLevel(f, S.scores);
    const isThreatToWeakest = f.threatMode === weakest();
    
    return `
    <div class="card mb-15 forecast-item ${isThreatToWeakest ? 'threat-to-weakest' : ''}" style="${isThreatToWeakest ? 'border-color:var(--danger);' : ''}">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px;flex-wrap:wrap;gap:8px">
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                <span style="font-size:10px;padding:3px 8px;background:var(--bg-tertiary);color:var(--text-secondary)">${CATEGORIES[f.category]?.icon} ${CATEGORIES[f.category]?.name}</span>
                <span style="font-size:10px;padding:3px 8px;background:rgba(255,68,68,0.2);color:${risk.color}">YOUR RISK: ${risk.label}</span>
                ${isThreatToWeakest ? '<span style="font-size:10px;padding:3px 8px;background:var(--danger);color:white">‚ö†Ô∏è TARGETS YOUR WEAKNESS</span>' : ''}
            </div>
            <span style="font-size:10px;color:var(--text-muted)">${f.source}</span>
        </div>
        
        <h3 style="font-size:16px;line-height:1.4;margin-bottom:12px">${f.title}</h3>
        
        <div style="display:flex;gap:20px;margin-bottom:15px;flex-wrap:wrap">
            <div>
                <div style="font-size:28px;font-weight:700;color:${f.probability > 60 ? 'var(--warning)' : 'var(--text-secondary)'}">${f.probability}%</div>
                <div style="font-size:9px;color:var(--text-muted);text-transform:uppercase">Probability</div>
            </div>
            <div>
                <div style="font-size:16px;font-weight:700;color:var(--text-primary)">${f.timeframe}</div>
                <div style="font-size:9px;color:var(--text-muted);text-transform:uppercase">Timeframe</div>
            </div>
            <div>
                <div style="font-size:16px;font-weight:700;color:var(--${f.threatMode})">${f.threatMode.toUpperCase()}</div>
                <div style="font-size:9px;color:var(--text-muted);text-transform:uppercase">Mode Threatened</div>
            </div>
        </div>
        
        <div style="background:var(--bg-primary);border-left:3px solid var(--${f.threatMode});padding:12px;margin-bottom:15px">
            <div style="font-size:10px;color:var(--${f.threatMode});text-transform:uppercase;letter-spacing:1px;margin-bottom:6px">Why ${f.threatMode} is threatened</div>
            <p style="font-size:12px;line-height:1.5;color:var(--text-secondary)">${f.threatReason}</p>
            <p style="font-size:11px;color:var(--text-muted);margin-top:8px"><strong>At risk:</strong> ${f.atRisk}</p>
        </div>
        
        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
            <button class="btn btn-small btn-primary view-forecast-detail" data-id="${f.id}">See Opportunities ‚Üí</button>
            <button class="btn btn-small ${S.followedForecasts.includes(f.id)?'btn-success':'btn-secondary'} follow-forecast" data-id="${f.id}">
                ${S.followedForecasts.includes(f.id)?'‚úì Following':'+ Follow'}
            </button>
        </div>
        ${f.source ? `<div style="margin-top:12px;font-size:10px;color:var(--text-muted)">Source: ${f.source}</div>` : ''}
    </div>
    `;
}

function forecastDetailModalH() {
    const f = S.selectedForecast;
    if (!f) return '';
    const risk = getRiskLevel(f, S.scores);
    
    return `
        <div class="modal-overlay" id="modal-bg">
            <div class="modal" style="max-width:650px;max-height:90vh;overflow-y:auto">
                <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:15px">
                    <span style="font-size:10px;padding:3px 8px;background:rgba(255,68,68,0.2);color:${risk.color}">YOUR RISK: ${risk.label}</span>
                    <button style="background:none;border:none;color:var(--text-secondary);font-size:20px;cursor:pointer" id="close-forecast-modal">√ó</button>
                </div>
                
                <h3 style="font-size:18px;line-height:1.4;margin-bottom:15px">${f.title}</h3>
                
                <div style="display:flex;gap:15px;margin-bottom:20px;flex-wrap:wrap">
                    <div style="background:var(--bg-primary);padding:12px 16px;text-align:center">
                        <div style="font-size:24px;font-weight:700">${f.probability}%</div>
                        <div style="font-size:9px;color:var(--text-muted);text-transform:uppercase">Probability</div>
                    </div>
                    <div style="background:var(--bg-primary);padding:12px 16px;text-align:center">
                        <div style="font-size:16px;font-weight:700">${f.timeframe}</div>
                        <div style="font-size:9px;color:var(--text-muted);text-transform:uppercase">Timeframe</div>
                    </div>
                    <div style="background:var(--bg-primary);padding:12px 16px;text-align:center">
                        <div style="font-size:16px;font-weight:700;color:var(--${f.threatMode})">${f.threatMode.toUpperCase()}</div>
                        <div style="font-size:9px;color:var(--text-muted);text-transform:uppercase">Threatened</div>
                    </div>
                    <div style="background:var(--bg-primary);padding:12px 16px;text-align:center">
                        <div style="font-size:16px;font-weight:700">${S.scores[f.threatMode]}%</div>
                        <div style="font-size:9px;color:var(--text-muted);text-transform:uppercase">Your ${f.threatMode}</div>
                    </div>
                </div>
                
                ${S.scores[f.threatMode] < 50 ? `
                <div style="background:var(--danger);padding:15px;margin-bottom:20px">
                    <div style="font-size:11px;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;color:white">‚ö†Ô∏è WARNING</div>
                    <p style="font-size:13px;color:white">Your ${f.threatMode} score (${S.scores[f.threatMode]}%) puts you at HIGH RISK if this forecast materializes. Start preparing NOW.</p>
                </div>
                ` : ''}
                
                <div style="margin-bottom:20px">
                    <div style="font-size:11px;color:var(--accent);text-transform:uppercase;letter-spacing:1px;margin-bottom:10px">Opportunities to Prepare (${f.opportunities.length})</div>
                    
                    ${f.opportunities.map((opp, i) => {
                        const progress = S.forecastProgress[f.id]?.[i] || 0;
                        const totalQuests = opp.quests.length;
                        const isComplete = progress >= totalQuests;
                        const hasProgress = progress > 0;
                        return `
                        <div style="background:var(--bg-primary);border:1px solid ${S.expandedOpp === i ? 'var(--accent)' : isComplete ? 'var(--success)' : 'var(--bg-tertiary)'};margin-bottom:12px;transition:all 0.2s">
                            <div class="opp-header" data-opp="${i}" style="padding:15px;cursor:pointer;display:flex;justify-content:space-between;align-items:flex-start">
                                <div style="flex:1">
                                    <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;flex-wrap:wrap">
                                        <h4 style="font-size:14px;margin:0">${opp.title}</h4>
                                        <span style="font-size:10px;padding:2px 8px;background:var(--bg-tertiary);color:var(--${opp.mode})">+${opp.mode.toUpperCase()}</span>
                                        ${isComplete ? `<span style="font-size:10px;padding:2px 8px;background:var(--success);color:white">‚úì COMPLETE</span>` : 
                                          hasProgress ? `<span style="font-size:10px;padding:2px 8px;background:var(--bg-tertiary);color:var(--accent)">${progress}/${totalQuests}</span>` : ''}
                                    </div>
                                    <p style="font-size:12px;color:var(--text-secondary);line-height:1.5;margin:0">${opp.description}</p>
                                    <div style="font-size:10px;color:var(--text-muted);margin-top:8px">Difficulty: ${opp.difficulty} ¬∑ Timeframe: ${opp.timeframe} ¬∑ ${opp.quests.length} quests</div>
                                </div>
                                <span style="color:var(--accent);font-size:18px;margin-left:10px">${S.expandedOpp === i ? '‚àí' : '+'}</span>
                            </div>
                            
                            ${S.expandedOpp === i ? `
                            <div style="padding:0 15px 15px 15px;border-top:1px solid var(--bg-tertiary)">
                                <div style="background:var(--bg-secondary);padding:12px;border-left:2px solid var(--accent);margin-top:15px">
                                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                                        <div style="font-size:10px;color:var(--accent);text-transform:uppercase;letter-spacing:1px">Quest Path</div>
                                        ${(S.forecastProgress[f.id]?.[i] || 0) > 0 ? `<span style="font-size:10px;color:var(--success)">${S.forecastProgress[f.id]?.[i] || 0}/${opp.quests.length} Complete</span>` : ''}
                                    </div>
                                    ${opp.quests.map((q, j) => {
                                        const progress = S.forecastProgress[f.id]?.[i] || 0;
                                        const isCompleted = j < progress;
                                        const isCurrent = j === progress;
                                        return `
                                        <div style="display:flex;gap:10px;align-items:flex-start;margin-bottom:10px;padding-bottom:10px;${j < opp.quests.length - 1 ? 'border-bottom:1px solid var(--bg-tertiary)' : ''}${isCompleted ? 'opacity:0.5;' : ''}">
                                            <span style="font-size:12px;width:20px;height:20px;display:flex;align-items:center;justify-content:center;border-radius:50%;flex-shrink:0;${isCompleted ? 'background:var(--success);color:white' : isCurrent ? 'background:var(--accent);color:var(--bg-primary)' : 'background:var(--bg-tertiary);color:var(--text-secondary)'}">${isCompleted ? '‚úì' : j + 1}</span>
                                            <div style="flex:1">
                                                <span style="font-size:11px;line-height:1.4;${isCompleted ? 'text-decoration:line-through;' : ''}">${q.task}</span>
                                                <div style="font-size:9px;color:var(--text-muted);margin-top:3px"><span style="color:var(--${q.mode})">${q.mode.toUpperCase()}</span> ¬∑ +${q.xp} XP</div>
                                            </div>
                                        </div>
                                    `}).join('')}
                                    ${(S.forecastProgress[f.id]?.[i] || 0) < opp.quests.length ? `
                                    <button class="btn btn-small btn-primary btn-full mt-10 add-quest-path" data-forecast="${f.id}" data-opp="${i}">${(S.forecastProgress[f.id]?.[i] || 0) > 0 ? 'Continue Quest Path ‚Üí' : 'Add These Quests to My Queue ‚Üí'}</button>
                                    ` : `
                                    <div style="text-align:center;padding:15px 0;color:var(--success)">
                                        <span style="font-size:20px">üéâ</span>
                                        <div style="font-size:12px;margin-top:5px">Quest path complete!</div>
                                    </div>
                                    `}
                                </div>
                            </div>
                            ` : ''}
                        </div>
                    `}).join('')}
                </div>
                
                <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
                    <button class="btn btn-small ${S.followedForecasts.includes(f.id)?'btn-success':'btn-secondary'} follow-forecast" data-id="${f.id}">
                        ${S.followedForecasts.includes(f.id)?'‚úì Following':'+ Follow This Forecast'}
                    </button>
                    ${f.sourceUrl ? `<a href="${f.sourceUrl}" target="_blank" class="btn btn-small btn-secondary">View Source ‚Üí</a>` : ''}
                </div>
                
                ${f.source ? `
                <div style="margin-top:15px;padding-top:15px;border-top:1px solid var(--bg-tertiary)">
                    <div style="font-size:10px;color:var(--text-muted);margin-bottom:8px">SOURCE</div>
                    <p style="font-size:11px;color:var(--text-secondary);line-height:1.5;margin-bottom:10px">${f.source}</p>
                    ${f.sourceUrl ? `<a href="${f.sourceUrl}" target="_blank" class="btn btn-small btn-secondary" style="margin-bottom:10px">View Prediction Market ‚Üí</a>` : ''}
                    <div style="display:flex;gap:12px;margin-top:8px;flex-wrap:wrap;font-size:10px;color:var(--text-muted)">
                        <span>Explore more:</span>
                        <a href="https://polymarket.com/predictions/ai" target="_blank" style="color:var(--accent)">Polymarket AI</a>
                        <a href="https://www.metaculus.com/questions/" target="_blank" style="color:var(--accent)">Metaculus</a>
                        <a href="https://manifold.markets" target="_blank" style="color:var(--accent)">Manifold</a>
                    </div>
                </div>
                ` : ''}
            </div>
        </div>
    `;
}

function addQuestPathToQueue(forecastId, oppIndex) {
    const forecast = FORECAST_DATABASE.find(f => f.id === forecastId);
    if (!forecast) return;
    
    const opp = forecast.opportunities[oppIndex];
    if (!opp) return;
    
    // Add quests to user's queue
    opp.quests.forEach(q => {
        S.quests.push({
            t: q.task,
            xp: q.xp,
            mode: q.mode,
            diff: 'forecast',
            tip: `From: ${forecast.title.substring(0, 50)}...`,
            id: Date.now() + Math.random(),
            done: false,
            fromForecast: forecastId
        });
    });
    
    save();
    S.modal = null;
    S.selectedForecast = null;
    S.screen = 'quests';
    render();
}

async function loadForecasts() {
    // For now using static database
    // Later: fetch from Supabase or API
    render();
}

// Update modalH to include forecast detail modal
async function init(){
    initTheme(); // Load saved theme preference
    const params=new URLSearchParams(location.search);
    const hash=location.hash.replace('#','');
    
    // Clean URL routing: /google, /claude, /openai, /company, /diagnostic
    // Works whether Netlify rewrites (path stays /openai) or JS reads path directly
    var path=location.pathname.replace(/\/$/,'').split('/').pop();
    // Also check referrer in case of redirect
    if(path==='app.html'){
        var ref=document.referrer||'';
        var refPath=ref.replace(/\/$/,'').split('/').pop();
        if(['google','claude','openai','company','diagnostic'].includes(refPath)) path=refPath;
    }
    if(path==='diagnostic'){params.set('mode','diagnostic');}
    if(path==='company'){
        S.companyStep=0;S.companyUrl='';S.companyEmail='';S.companyIndustry='';S.companyDesc='';S.companyResult=null;S.companyLoadingStep=0;S.companyUnlocked=false;S.reportSlide=0;S.plans={};S.screen='company';render();return;
    }
    if(['google','claude','openai'].includes(path)){
        S.threatProvider=path;S.threatStep=0;S.threatUrl='';S.threatEmail='';S.threatIndustry='';S.threatDesc='';S.threatResult=null;S.threatLoadingStep=0;S.threatUnlocked=false;S.threatSlide=0;S.threatPlans={};S.screen='threat';render();return;
    }
    
    // Check for report payment success
    if(params.get('report_success')==='true'){
        history.replaceState({},'',location.pathname);
        var saved=localStorage.getItem('apc_report');
        if(saved){
            try{
                var data=JSON.parse(saved);
                localStorage.removeItem('apc_report');
                if(data.type==='company'){
                    S.companyUrl=data.url||'';S.companyEmail=data.email||'';S.companyIndustry=data.industry||'';
                    S.companyDesc=data.desc||'';S.companyResult=data.result;S.companyStep=2;S.companyUnlocked=true;S.reportSlide=0;S.plans={};
                    // Update plan from lead to report_paid
                    await db('users','PATCH',{user_type:'report_paid'},`?email=eq.${encodeURIComponent(data.email)}&source=eq.company_risk`);
                    S.screen='company';render();return;
                }
                if(data.type==='threat'){
                    S.threatProvider=data.provider;S.threatUrl=data.url||'';S.threatEmail=data.email||'';
                    S.threatIndustry=data.industry||'';S.threatDesc=data.desc||'';S.threatResult=data.result;
                    S.threatStep=2;S.threatUnlocked=true;
                    // Update plan from lead to report_paid
                    await db('users','PATCH',{user_type:'report_paid'},`?email=eq.${encodeURIComponent(data.email)}&source=eq.threat_${data.provider}`);
                    S.screen='threat';render();return;
                }
            }catch(e){console.error('Report restore:',e);}
        }
    }
    
    // Check for diagnostic mode from landing page
    if(params.get('mode') === 'diagnostic') {
        history.replaceState({}, '', location.pathname + '#diagnostic');
        S.diagnosticStep = 0;
        S.diagnosticEmail = '';
        S.diagnosticIndustry = '';
        S.diagnosticAnswers = [];
        S.screen = 'diagnostic';
        render();
        return;
    }
    
    // Company mode
    if(params.get('mode')==='company'||hash==='company'){S.companyStep=0;S.companyUrl='';S.companyEmail='';S.companyIndustry='';S.companyDesc='';S.companyResult=null;S.companyLoadingStep=0;S.companyUnlocked=false;S.reportSlide=0;S.plans={};S.screen='company';render();return;}
    // Threat mode
    var _tm=params.get('threat');if(_tm&&typeof THREAT_PROVIDERS!=='undefined'&&THREAT_PROVIDERS[_tm]){S.threatProvider=_tm;S.threatStep=0;S.threatUrl='';S.threatEmail='';S.threatIndustry='';S.threatDesc='';S.threatResult=null;S.threatLoadingStep=0;S.threatUnlocked=false;S.threatSlide=0;S.threatPlans={};S.screen='threat';render();return;}
    // Check for Supabase Auth password recovery (hash fragment: #access_token=xxx&type=recovery)
    var hashParams = new URLSearchParams(location.hash.substring(1));
    var recoveryToken = hashParams.get('access_token');
    var tokenType = hashParams.get('type');
    if(recoveryToken && tokenType === 'recovery') {
        console.log('Password recovery detected');
        S.modal = 'resetPassword';
        S.recoveryAccessToken = recoveryToken;
        S.screen = 'resetPassword';
        render();
        return;
    }
    // Also check query params (some Supabase configs use PKCE flow)
    var qToken = params.get('token');
    var qType = params.get('type');
    if(qToken && qType === 'recovery') {
        console.log('Password recovery detected (query param)');
        S.modal = 'resetPassword';
        S.recoveryAccessToken = qToken;
        S.screen = 'resetPassword';
        render();
        return;
    }
    
    // Handle hash routes
    const validScreens = ['signin','signup','login','forgot','pricing','onboarding','upload','quiz','results','dashboard','quests','coach','receipts','capsules','review','settings','forecasts','diagnostic','company','threat'];
    
    if(params.get('success')==='true'){
        history.replaceState({},'',location.pathname);
        const pending=localStorage.getItem('apc_pending');
        if(pending){
            const pendingData = JSON.parse(pending);
            S.user = { email: pendingData.email, plan: 'paid' };
            S.scores = pendingData.scores || {ideas:50,personality:50,execution:50};
            S.freeQuizScores = pendingData.baseline_scores || S.scores;
            S.onboardData = pendingData.onboardData || {goals: [], forecastInterests: []};
            // Ensure goals array exists
            if(!S.onboardData.goals) S.onboardData.goals = [];
            if(!S.onboardData.forecastInterests) S.onboardData.forecastInterests = [];
            S.onboardSelectedForecasts = pendingData.onboardSelectedForecasts || [];
            S.onboardStep = pendingData.onboardStep || 4; // Continue to goals
            S.screen = 'onboarding';
            render();
            return;
        }
    }
    
    const session=localStorage.getItem('apc_session');
    if(session){
        const data=JSON.parse(session);
        const users=await db('users','GET',null,`?email=eq.${encodeURIComponent(data.email)}`);
        if(users?.length){
            S.user=users[0];S.scores=users[0].scores||{ideas:50,personality:50,execution:50};
            S.receipts=users[0].receipts||[];S.diff=users[0].diff||'standard';
            
            // Load quests - ONLY generate new ones if truly empty
            if(users[0].quests && users[0].quests.length > 0) {
                S.quests = users[0].quests;
            } else {
                S.quests = genQuests();
            }
            
            // Load quest customization data
            S.hiddenQuests=users[0].hiddenQuests||[];
            S.customQuests=users[0].customQuests||[];
            S.followedForecasts=users[0].followedForecasts||[];
            S.forecastProgress=users[0].forecastProgress||{};
            
            // Ensure lastQuestWeek is set if user has quests
            if(!S.user.lastQuestWeek && S.quests.length > 0) {
                S.user.lastQuestWeek = getWeekNumber();
                save();
            }
            
            // Merge any local receipts that might not have synced (edge case recovery)
            const localSession = JSON.parse(session);
            if(localSession.receipts && localSession.receipts.length > S.receipts.length) {
                // Local has more receipts - merge them
                const serverIds = new Set(S.receipts.map(r => r.id));
                const missingReceipts = localSession.receipts.filter(r => !serverIds.has(r.id));
                if(missingReceipts.length) {
                    S.receipts = [...S.receipts, ...missingReceipts];
                    save(); // Sync merged receipts back to server
                }
            }
            
            // Merge followedForecasts from localStorage if server is missing some
            if(localSession.followedForecasts && localSession.followedForecasts.length > S.followedForecasts.length) {
                const serverIds = new Set(S.followedForecasts);
                const missing = localSession.followedForecasts.filter(id => !serverIds.has(id));
                if(missing.length) {
                    S.followedForecasts = [...S.followedForecasts, ...missing];
                    save();
                }
            }
            
            // If logged in and hash is a valid app screen, go there
            if(hash && ['dashboard','quests','coach','receipts','capsules','review','settings','forecasts'].includes(hash)){
                S.screen = hash;
            } else {
                S.screen=S.user.onboarded?'dashboard':'onboarding';
            }
            checkWeeklyProgress();
            updateHash();
            render();return;
        }
    }
    
    // Not logged in - handle auth screens
    if(hash === 'signup' || hash === 'signin' || hash === 'login'){
        S.screen = hash === 'signin' ? 'login' : hash;
    } else if(hash === 'forgot'){
        S.screen = 'forgot';
    } else {
        S.screen = 'login';
    }
    updateHash();
    render();
}

function updateHash(){
    const screenToHash = {
        'login': 'signin',
        'signup': 'signup',
        'forgot': 'forgot',
        'pricing': 'pricing',
        'onboarding': 'onboarding',
        'upload': 'upload',
        'quiz': 'quiz',
        'results': 'results',
        'dashboard': 'dashboard',
        'quests': 'quests',
        'coach': 'coach',
        'receipts': 'receipts',
        'capsules': 'capsules',
        'review': 'review',
        'settings': 'settings',
        'forecasts': 'forecasts'
    };
    const newHash = screenToHash[S.screen] || S.screen;
    if(location.hash !== '#' + newHash){
        history.pushState(null, '', '#' + newHash);
    }
}

// Handle browser back/forward
// Test unlock: add ?debug=1 to any URL, then type "unlock" on results page
var _dbg=location.search.includes('debug=1');var _uk='';document.addEventListener('keydown',function(e){if(!_dbg)return;if(e.key.length===1){_uk+=e.key.toLowerCase();if(_uk.length>6)_uk=_uk.slice(-6);if(_uk==='unlock'){if(S.screen==='company'){S.companyUnlocked=true;render();}if(S.screen==='threat'){S.threatUnlocked=true;render();}}}});

window.addEventListener('popstate', () => {
    const hash = location.hash.replace('#','');
    if(hash && S.user){
        if(['dashboard','quests','coach','receipts','capsules','review','settings','forecasts'].includes(hash)){
            S.screen = hash;
            render();
        }
    } else if(['signin','login','signup','forgot'].includes(hash)){
        S.screen = hash === 'signin' ? 'login' : hash;
        render();
    }
});
init();
</script>
</body>
</html>

